<!doctype html><html lang=zh-tw dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Android WebView 筆記 | EricLog</title>
<meta name=keywords content="Android"><meta name=description content="好幾年都沒有特別去用 Android 的 WebView，近期工作需要用到 WebView，所以特別去查一下並將資料放在這篇文章內方便日後翻查。 AndroidX WebKit AndroidX 其實有 WebKit 的"><meta name=author content><link rel=canonical href=https://eric.swiftzer.net/2024/02/android-webview/><link crossorigin=anonymous href=/assets/css/stylesheet.014d92f7e42768013bc6e6c6aaf7562cad235ef48b65d729ba2e6b2ceb3a58e1.css integrity="sha256-AU2S9+QnaAE7xubGqvdWLK0jXvSLZdcpui5rLOs6WOE=" rel="preload stylesheet" as=style><link rel=icon href=https://eric.swiftzer.net/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://eric.swiftzer.net/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://eric.swiftzer.net/favicon-32x32.png><link rel=apple-touch-icon href=https://eric.swiftzer.net/apple-touch-icon.png><link rel=mask-icon href=https://eric.swiftzer.net/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh-tw href=https://eric.swiftzer.net/2024/02/android-webview/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=JetBrains+Mono:wght@300&display=swap" rel=stylesheet><script async src="https://www.googletagmanager.com/gtag/js?id=G-D93F946T73"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-D93F946T73",{anonymize_ip:!1})}</script><meta property="og:title" content="Android WebView 筆記"><meta property="og:description" content="好幾年都沒有特別去用 Android 的 WebView，近期工作需要用到 WebView，所以特別去查一下並將資料放在這篇文章內方便日後翻查。 AndroidX WebKit AndroidX 其實有 WebKit 的"><meta property="og:type" content="article"><meta property="og:url" content="https://eric.swiftzer.net/2024/02/android-webview/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-02-24T11:45:00+08:00"><meta property="article:modified_time" content="2024-02-24T11:45:00+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Android WebView 筆記"><meta name=twitter:description content="好幾年都沒有特別去用 Android 的 WebView，近期工作需要用到 WebView，所以特別去查一下並將資料放在這篇文章內方便日後翻查。 AndroidX WebKit AndroidX 其實有 WebKit 的"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://eric.swiftzer.net/posts/"},{"@type":"ListItem","position":2,"name":"Android WebView 筆記","item":"https://eric.swiftzer.net/2024/02/android-webview/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Android WebView 筆記","name":"Android WebView 筆記","description":"好幾年都沒有特別去用 Android 的 WebView，近期工作需要用到 WebView，所以特別去查一下並將資料放在這篇文章內方便日後翻查。 AndroidX WebKit AndroidX 其實有 WebKit 的","keywords":["Android"],"articleBody":"好幾年都沒有特別去用 Android 的 WebView，近期工作需要用到 WebView，所以特別去查一下並將資料放在這篇文章內方便日後翻查。\nAndroidX WebKit AndroidX 其實有 WebKit 的 artifact androidx.webkit:webkit，但不是把整個 browser 加到 app 入面（WebView 實際在用的 web browser 是由 Google Play Store 提供，並可以 developer options 切換），而是把部分較新的 WebView 功能加個檢查 function，如果目前的 WebView 支援那個功能的話就可以執行這部分的 code。\nAndroidX WebKit 入面有 WebViewClientCompat，這是用來 polyfill 部分 Android SDK 內的 WebViewClient。相信最值得一提的地方是 shouldOverrideUrlLoading。這個 method 是用來控制 WebView 是否載入這個網址。你可以在這個 callback 內截停某些網址載入，然後做其他東西。比如因應某些網址來 startActivity 讓那些網址改為系統瀏覽器開啟。另一個經典用法是用作由 JavaScript 傳遞資料給 native app，但如果經 URL 傳遞很長的 string 的話（例如 base64 encode 的圖片）很容易會 lag 機。\n留意 WebViewClientCompat 的 shouldOverrideUrlLoading 跟 Android SDK 那個行為不同：WebViewClientCompat 會把除 loadUrl 的頁面都改由系統預設瀏覽器開啟。\nLifecycle WebView 是一個比較麻煩的 UI 組件，因為要特別手動接駁 Android Activity/Fragment 的 lifecycle，如果做漏的話 WebView 的 state 就會在 configuration change 後出錯。就好似 Google Maps SDK 的 MapView 一樣需要 forward lifecycle method。如果是 Activity 的話大概是這樣：\nclass WebViewActivity : AppCompatActivity() { private lateinit var webView: WebView override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContentView(R.layout.activity_webview) webView = findViewById(R.id.webview) // 在載入 WebView 第一頁前要檢查 savedInstanceState // 如果 configuration change 前用戶已經載入過或者按了連結去另一頁的話 // 不檢查 savedInstanceState 就會在 configuration change 後載入第一頁 if (savedInstanceState == null) { webView.loadUrl(\"https://example.com\") // 如果要加額外的 header（例如盜連 CodePen），可以在 loadUrl 再加 Map webView.loadUrl( \"https://cdpn.io/RhinoLu/fullpage/RrPxMv?anon=true\u0026view=\", mapOf(\"Referer\" to \"https://codepen.io/RhinoLu/pen/RrPxMv\"), ) } } override fun onPause() { super.onPause() webView.onPause() } override fun onResume() { super.onResume() webView.onResume() } override fun onDestroy() { super.onDestroy() webView.destroy() } override fun onSaveInstanceState(outState: Bundle) { super.onSaveInstanceState(outState) webView.saveState(outState) } override fun onRestoreInstanceState(savedInstanceState: Bundle) { super.onRestoreInstanceState(savedInstanceState) webView.restoreState(savedInstanceState) } } JavaScript 與 native app 雙向溝通 用 AndroidX WebKit 的主要原因是為了用 WebMessageListener。傳統的 JavaScript 與 native app 溝通方法是靠加了 @JavascriptInterface annotation 的 class 做 JavaScript 向 native 傳遞訊息，由 native 向 JavaScript 傳遞訊息就用 WebView.evaluateJavascript call JavaScript 的 function。\n自從 Android 6 (API Level 23) 開始，WebView 開始支援 postWebMessage，加上 AndroidX WebKit 有 addWebMessageListener method，我們可以用這兩個 method 實現 native app 和 JavaScript 雙向溝通。\nNative app 向 JavaScript 通訊 在 Android app 那邊，我們假設用戶按下 sendData 按鈕後就會發送一個帶有當前時間的 string：\nfindViewById\u003cButton\u003e(R.id.sendData).setOnClickListener { if (WebViewFeature.isFeatureSupported(WebViewFeature.POST_WEB_MESSAGE)) { WebViewCompat.postWebMessage( webView, WebMessageCompat(\"Hello from Android @ ${Instant.now()}\"), Uri.parse(\"https://cdpn.io\"), ) } else { // postWebMessage is not supported } } 上面的 code 首先要檢查一下目前的 WebView 是否支援 POST_WEB_MESSAGE，如果支援的話就向當前 https://cdpn.io 作域名的網頁發送那段 string。加上 targetOrigin 那個參數是為了加強保安，避免把內容發送到不是我們期望的網站。如果不想限制就可以用 Uri.parse(\"*\")。\n而 JavaScript 那邊就可以用 addEventListener 收到那段 string。String 的內容是放在 event.data 內。\nwindow.addEventListener('message', receiver, false); function receiver(event) { console.log(event.data); } JavaScript 向 native app 通訊 首先在 Android 那邊要加 WebMessageListener，同樣地都要先檢查是否支援 WEB_MESSAGE_LISTENER。那個 Android 是 JavaScript 那邊看到的 object 名稱。而 setOf(\"https://cdpn.io\") 是指明 WebView 在那些域名才把 Android object 塞入去 window object 內，都是為了加強保安。以前 addJavascriptInterface 是沒有這個功能，凡是載入網頁都會把 Android object 塞入去 window object 內。\nif (WebViewFeature.isFeatureSupported(WebViewFeature.WEB_MESSAGE_LISTENER)) { WebViewCompat.addWebMessageListener( webView, \"Android\", setOf(\"https://cdpn.io\"), MyWebMessageListener(), ) } 去到 WebMessageListener 的部分，只需要 override onPostMessage method 獲取 message.data。如果想在收到 message 後馬上回覆 JavaScript 的話可以用 replyProxy.postMessage 來向 JavaScript 通訊。\nclass MyWebMessageListener() : WebViewCompat.WebMessageListener { override fun onPostMessage( view: WebView, message: WebMessageCompat, sourceOrigin: Uri, isMainFrame: Boolean, replyProxy: JavaScriptReplyProxy, ) { Toast.makeText(this, \"Received message from WebView: ${message.data}\", Toast.LENGTH_SHORT).show() // 收到後馬上回覆 JavaScript if (WebViewFeature.isFeatureSupported(WebViewFeature.WEB_MESSAGE_LISTENER) \u0026\u0026 replyProxy != null) { replyProxy.postMessage(\"got the message @ ${Instant.now()}\") } } } 而 JavaScript 那邊就是先檢查有沒有那個 Android object，有的話就可以 call postMessage 向 native app 通訊。如果要收到來自 native app 的回應，要再為 onmessage 設定 callback function。\ndocument .getElementById(\"postMessage\") .addEventListener(\"click\", function (event) { if (typeof Android !== \"undefined\") { Android.postMessage(\"testing\"); } }); // Immediately receive message right after calling Android.postMessage if (typeof Android !== \"undefined\") { Android.onmessage = function (event) { console.log(\"Android.onmessage received: \", event); } } 雙向通訊大概就是這樣。除了傳送 string 之外，其實還可以傳送 binary data。Native app 那邊是用 ByteArray type；而 JavaScript 那邊就用 ArrayBuffer type。以為就不用刻意 base64 encode 圖片之類的 binary 文件。\n另一樣要留意的是 WebMessageListener 執行的 thread 跟以往 @JavascriptInterface 不一樣。\nBack button 與進度條 Activity 的 onBackPressed method 因應 Android 14 (API level 34) 的 predictive back gesture 功能而 deprecated，如果要令 WebView 的上一頁加到 Android 系統的 back button 的話就要用 onBackPressedDispatcher。\nonBackPressedDispatcher 的用法其實跟 Activity 的 onBackPressed 完全相反。onBackPressed 是用戶按了 back 後會 call，你在這個 function 內控制是否 call super class 的 onBackPressed（即是真的讓系統處理 back）。而 onBackPressedDispatcher 是要你主動通知它目前是不是交由系統處理 back，如果設定成不由系統處理的話就會執行你的 OnBackPressedCallback。\n要做到這個效果我們需要 override WebViewClientCompat 來取得目前 WebView 的 event，主要是留意 onPageStarted、onPageFinished、onReceivedError、onReceivedHttpError，然後在裏面檢查現在的 WebView.canGoBack。\n另一樣是進度條，進度數值和是否需要顯示進度條是靠 WebViewClientCompat 和 WebChromeClient。WebChromeClient 沒有 compat 版，直接 override Android SDK 提供的就可以。\n這兩項的 code 大約是這樣：\nclass WebViewActivity : AppCompatActivity() { private lateinit var webView: WebView private val onBackPressedCallback = object : OnBackPressedCallback(false) { override fun handleOnBackPressed() { if (webView.canGoBack()) { webView.goBack() } } } override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) setContentView(R.layout.activity_webview) webView = findViewById(R.id.webview) webView.webViewClient = MyWebViewClient( onPageStarted = { // 顯示載入中 }, onPageFinished = { // 隱藏載入中 }, updateCanGoBackAndForward = { canGoBack, _ -\u003e // 設定 onBackPressedCallback 是否啟用 // 如果 WebView 沒有頁面可以返回就要停用我們的 callback，這樣就能 finish Activity onBackPressedCallback.isEnabled = canGoBack }, ) webView.webChromeClient = MyWebChromeClient( onProgressChanged = { newProgress -\u003e // 設定進度條的進度 }, ) onBackPressedDispatcher.addCallback(onBackPressedCallback) } } class MyWebViewClient( private val onPageStarted: (url: String) -\u003e Unit = {}, private val onPageFinished: (url: String) -\u003e Unit = {}, private val onReceivedError: (request: WebResourceRequest, error: WebResourceErrorCompat) -\u003e Unit = { _, _ -\u003e }, private val onReceivedHttpError: (request: WebResourceRequest, errorResponse: WebResourceResponse) -\u003e Unit = { _, _ -\u003e }, private val updateCanGoBackAndForward: (canGoBack: Boolean, canGoForward: Boolean) -\u003e Unit = { _, _ -\u003e }, ) : WebViewClientCompat() { override fun onPageStarted(view: WebView, url: String, favicon: Bitmap?) { super.onPageStarted(view, url, favicon) onPageStarted(url) updateCanGoBackAndForward(view.canGoBack(), view.canGoForward()) } override fun onPageFinished(view: WebView, url: String) { super.onPageFinished(view, url) onPageFinished(url) updateCanGoBackAndForward(view.canGoBack(), view.canGoForward()) } override fun onReceivedError(view: WebView, request: WebResourceRequest, error: WebResourceErrorCompat) { super.onReceivedError(view, request, error) onReceivedError(request, error) updateCanGoBackAndForward(view.canGoBack(), view.canGoForward()) } override fun onReceivedHttpError(view: WebView, request: WebResourceRequest, errorResponse: WebResourceResponse) { super.onReceivedHttpError(view, request, errorResponse) onReceivedHttpError(request, errorResponse) updateCanGoBackAndForward(view.canGoBack(), view.canGoForward()) } } class MyWebChromeClient( val onProgressChanged: (newProgress: Int) -\u003e Unit = {}, ) : WebChromeClient() { override fun onProgressChanged(view: WebView, newProgress: Int) { super.onProgressChanged(view, newProgress) onProgressChanged(newProgress) } } 參考 Build web apps in WebView 使用 AndroidX 增强 WebView 的能力 ","wordCount":"2311","inLanguage":"zh-tw","datePublished":"2024-02-24T11:45:00+08:00","dateModified":"2024-02-24T11:45:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://eric.swiftzer.net/2024/02/android-webview/"},"publisher":{"@type":"Organization","name":"EricLog","logo":{"@type":"ImageObject","url":"https://eric.swiftzer.net/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://eric.swiftzer.net/ accesskey=h title="EricLog (Alt + H)">EricLog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li></ul></div></div><ul id=menu><li><a href=https://eric.swiftzer.net/fonts/ title=Fonts><span>Fonts</span></a></li><li><a href=https://eric.swiftzer.net/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://eric.swiftzer.net/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://eric.swiftzer.net/about/ title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://eric.swiftzer.net/>首頁</a>&nbsp;»&nbsp;<a href=https://eric.swiftzer.net/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Android WebView 筆記</h1><div class=post-meta><span title='2024-02-24 11:45:00 +0800 +0800'>February 24, 2024</span></div></header><div class=post-content><p>好幾年都沒有特別去用 Android 的 <code>WebView</code>，近期工作需要用到 <code>WebView</code>，所以特別去查一下並將資料放在這篇文章內方便日後翻查。</p><h2 id=androidx-webkit>AndroidX WebKit<a hidden class=anchor aria-hidden=true href=#androidx-webkit>#</a></h2><p>AndroidX 其實有 WebKit 的 artifact <a href=https://maven.google.com/web/index.html#androidx.webkit:webkit><code>androidx.webkit:webkit</code></a>，但不是把整個 browser 加到 app 入面（<code>WebView</code> 實際在用的 web browser 是由 <a href="https://play.google.com/store/apps/details?id=com.google.android.webview">Google Play Store 提供</a>，並可以 developer options 切換），而是把部分較新的 <code>WebView</code> 功能加個檢查 function，如果目前的 <code>WebView</code> 支援那個功能的話就可以執行這部分的 code。</p><p>AndroidX WebKit 入面有 <code>WebViewClientCompat</code>，這是用來 polyfill 部分 Android SDK 內的 <code>WebViewClient</code>。相信最值得一提的地方是 <code>shouldOverrideUrlLoading</code>。這個 method 是用來控制 <code>WebView</code> 是否載入這個網址。你可以在這個 callback 內截停某些網址載入，然後做其他東西。比如因應某些網址來 <code>startActivity</code> 讓那些網址改為系統瀏覽器開啟。另一個經典用法是用作由 JavaScript 傳遞資料給 native app，但如果經 URL 傳遞很長的 string 的話（例如 base64 encode 的圖片）很容易會 lag 機。</p><p>留意 <code>WebViewClientCompat</code> 的 <code>shouldOverrideUrlLoading</code> 跟 Android SDK 那個行為不同：<code>WebViewClientCompat</code> 會把除 <code>loadUrl</code> 的頁面都改由系統預設瀏覽器開啟。</p><h2 id=lifecycle>Lifecycle<a hidden class=anchor aria-hidden=true href=#lifecycle>#</a></h2><p><code>WebView</code> 是一個比較麻煩的 UI 組件，因為要特別手動接駁 Android <code>Activity</code>/<code>Fragment</code> 的 lifecycle，如果做漏的話 <code>WebView</code> 的 state 就會在 configuration change 後出錯。就好似 Google Maps SDK 的 <code>MapView</code> 一樣<a href=https://developers.google.com/maps/documentation/android-sdk/reference/com/google/android/libraries/maps/MapView>需要 forward lifecycle method</a>。如果是 <code>Activity</code> 的話大概是這樣：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>class</span> <span class=nc>WebViewActivity</span> <span class=p>:</span> <span class=n>AppCompatActivity</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>lateinit</span> <span class=k>var</span> <span class=py>webView</span><span class=p>:</span> <span class=n>WebView</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>onCreate</span><span class=p>(</span><span class=n>savedInstanceState</span><span class=p>:</span> <span class=n>Bundle</span><span class=p>?)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>super</span><span class=p>.</span><span class=n>onCreate</span><span class=p>(</span><span class=n>savedInstanceState</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>setContentView</span><span class=p>(</span><span class=nc>R</span><span class=p>.</span><span class=n>layout</span><span class=p>.</span><span class=n>activity_webview</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>webView</span> <span class=p>=</span> <span class=n>findViewById</span><span class=p>(</span><span class=nc>R</span><span class=p>.</span><span class=n>id</span><span class=p>.</span><span class=n>webview</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// 在載入 WebView 第一頁前要檢查 savedInstanceState
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// 如果 configuration change 前用戶已經載入過或者按了連結去另一頁的話
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// 不檢查 savedInstanceState 就會在 configuration change 後載入第一頁
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=n>savedInstanceState</span> <span class=o>==</span> <span class=k>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>webView</span><span class=p>.</span><span class=n>loadUrl</span><span class=p>(</span><span class=s2>&#34;https://example.com&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1>// 如果要加額外的 header（例如盜連 CodePen），可以在 loadUrl 再加 Map
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>webView</span><span class=p>.</span><span class=n>loadUrl</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;https://cdpn.io/RhinoLu/fullpage/RrPxMv?anon=true&amp;view=&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>mapOf</span><span class=p>(</span><span class=s2>&#34;Referer&#34;</span> <span class=n>to</span> <span class=s2>&#34;https://codepen.io/RhinoLu/pen/RrPxMv&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>onPause</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>super</span><span class=p>.</span><span class=n>onPause</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>webView</span><span class=p>.</span><span class=n>onPause</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>onResume</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>super</span><span class=p>.</span><span class=n>onResume</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>webView</span><span class=p>.</span><span class=n>onResume</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>onDestroy</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>super</span><span class=p>.</span><span class=n>onDestroy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>webView</span><span class=p>.</span><span class=n>destroy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>onSaveInstanceState</span><span class=p>(</span><span class=n>outState</span><span class=p>:</span> <span class=n>Bundle</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>super</span><span class=p>.</span><span class=n>onSaveInstanceState</span><span class=p>(</span><span class=n>outState</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>webView</span><span class=p>.</span><span class=n>saveState</span><span class=p>(</span><span class=n>outState</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>onRestoreInstanceState</span><span class=p>(</span><span class=n>savedInstanceState</span><span class=p>:</span> <span class=n>Bundle</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>super</span><span class=p>.</span><span class=n>onRestoreInstanceState</span><span class=p>(</span><span class=n>savedInstanceState</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>webView</span><span class=p>.</span><span class=n>restoreState</span><span class=p>(</span><span class=n>savedInstanceState</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=javascript-與-native-app-雙向溝通>JavaScript 與 native app 雙向溝通<a hidden class=anchor aria-hidden=true href=#javascript-與-native-app-雙向溝通>#</a></h2><p>用 AndroidX WebKit 的主要原因是為了用 <code>WebMessageListener</code>。傳統的 JavaScript 與 native app 溝通方法是靠加了 <a href=https://developer.android.com/reference/android/webkit/JavascriptInterface><code>@JavascriptInterface</code> annotation</a> 的 class 做 JavaScript 向 native 傳遞訊息，由 native 向 JavaScript 傳遞訊息就用 <a href=https://developer.android.com/reference/android/webkit/WebView#evaluateJavascript(java.lang.String,%20android.webkit.ValueCallback%3Cjava.lang.String%3E)><code>WebView.evaluateJavascript</code></a> call JavaScript 的 function。</p><p>自從 Android 6 (API Level 23) 開始，<code>WebView</code> 開始支援 <code>postWebMessage</code>，加上 AndroidX WebKit 有 <code>addWebMessageListener</code> method，我們可以用這兩個 method 實現 native app 和 JavaScript 雙向溝通。</p><h3 id=native-app-向-javascript-通訊>Native app 向 JavaScript 通訊<a hidden class=anchor aria-hidden=true href=#native-app-向-javascript-通訊>#</a></h3><p>在 Android app 那邊，我們假設用戶按下 <code>sendData</code> 按鈕後就會發送一個帶有當前時間的 string：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=n>findViewById</span><span class=p>&lt;</span><span class=n>Button</span><span class=p>&gt;(</span><span class=nc>R</span><span class=p>.</span><span class=n>id</span><span class=p>.</span><span class=n>sendData</span><span class=p>).</span><span class=n>setOnClickListener</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nc>WebViewFeature</span><span class=p>.</span><span class=n>isFeatureSupported</span><span class=p>(</span><span class=nc>WebViewFeature</span><span class=p>.</span><span class=n>POST_WEB_MESSAGE</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nc>WebViewCompat</span><span class=p>.</span><span class=n>postWebMessage</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>webView</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>WebMessageCompat</span><span class=p>(</span><span class=s2>&#34;Hello from Android @ </span><span class=si>${Instant.now()}</span><span class=s2>&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=nc>Uri</span><span class=p>.</span><span class=n>parse</span><span class=p>(</span><span class=s2>&#34;https://cdpn.io&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// postWebMessage is not supported
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>上面的 code 首先要檢查一下目前的 <code>WebView</code> 是否支援 <code>POST_WEB_MESSAGE</code>，如果支援的話就向當前 <code>https://cdpn.io</code> 作域名的網頁發送那段 string。加上 <code>targetOrigin</code> 那個參數是為了加強保安，避免把內容發送到不是我們期望的網站。如果不想限制就可以用 <code>Uri.parse("*")</code>。</p><p>而 JavaScript 那邊就可以用 <code>addEventListener</code> 收到那段 string。String 的內容是放在 <code>event.data</code> 內。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nb>window</span><span class=p>.</span><span class=nx>addEventListener</span><span class=p>(</span><span class=s1>&#39;message&#39;</span><span class=p>,</span> <span class=nx>receiver</span><span class=p>,</span> <span class=kc>false</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>receiver</span><span class=p>(</span><span class=nx>event</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>event</span><span class=p>.</span><span class=nx>data</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=javascript-向-native-app-通訊>JavaScript 向 native app 通訊<a hidden class=anchor aria-hidden=true href=#javascript-向-native-app-通訊>#</a></h3><p>首先在 Android 那邊要加 <code>WebMessageListener</code>，同樣地都要先檢查是否支援 <code>WEB_MESSAGE_LISTENER</code>。那個 <code>Android</code> 是 JavaScript 那邊看到的 object 名稱。而 <code>setOf("https://cdpn.io")</code> 是指明 <code>WebView</code> 在那些域名才把 <code>Android</code> object 塞入去 <code>window</code> object 內，都是為了加強保安。以前 <code>addJavascriptInterface</code> 是沒有這個功能，凡是載入網頁都會把 <code>Android</code> object 塞入去 <code>window</code> object 內。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nc>WebViewFeature</span><span class=p>.</span><span class=n>isFeatureSupported</span><span class=p>(</span><span class=nc>WebViewFeature</span><span class=p>.</span><span class=n>WEB_MESSAGE_LISTENER</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nc>WebViewCompat</span><span class=p>.</span><span class=n>addWebMessageListener</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>webView</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;Android&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>setOf</span><span class=p>(</span><span class=s2>&#34;https://cdpn.io&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>MyWebMessageListener</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>去到 <code>WebMessageListener</code> 的部分，只需要 override <code>onPostMessage</code> method 獲取 <code>message.data</code>。如果想在收到 message 後馬上回覆 JavaScript 的話可以用 <code>replyProxy.postMessage</code> 來向 JavaScript 通訊。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>class</span> <span class=nc>MyWebMessageListener</span><span class=p>()</span> <span class=p>:</span> <span class=nc>WebViewCompat</span><span class=p>.</span><span class=n>WebMessageListener</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>onPostMessage</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>view</span><span class=p>:</span> <span class=n>WebView</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>message</span><span class=p>:</span> <span class=n>WebMessageCompat</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>sourceOrigin</span><span class=p>:</span> <span class=n>Uri</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>isMainFrame</span><span class=p>:</span> <span class=n>Boolean</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>replyProxy</span><span class=p>:</span> <span class=n>JavaScriptReplyProxy</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nc>Toast</span><span class=p>.</span><span class=n>makeText</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=s2>&#34;Received message from WebView: </span><span class=si>${message.data}</span><span class=s2>&#34;</span><span class=p>,</span> <span class=nc>Toast</span><span class=p>.</span><span class=n>LENGTH_SHORT</span><span class=p>).</span><span class=n>show</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 收到後馬上回覆 JavaScript
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=nc>WebViewFeature</span><span class=p>.</span><span class=n>isFeatureSupported</span><span class=p>(</span><span class=nc>WebViewFeature</span><span class=p>.</span><span class=n>WEB_MESSAGE_LISTENER</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=n>replyProxy</span> <span class=o>!=</span> <span class=k>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>replyProxy</span><span class=p>.</span><span class=n>postMessage</span><span class=p>(</span><span class=s2>&#34;got the message @ </span><span class=si>${Instant.now()}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>而 JavaScript 那邊就是先檢查有沒有那個 <code>Android</code> object，有的話就可以 call <code>postMessage</code> 向 native app 通訊。如果要收到來自 native app 的回應，要再為 <code>onmessage</code> 設定 callback function。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nb>document</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=nx>getElementById</span><span class=p>(</span><span class=s2>&#34;postMessage&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=nx>addEventListener</span><span class=p>(</span><span class=s2>&#34;click&#34;</span><span class=p>,</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>event</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=k>typeof</span> <span class=nx>Android</span> <span class=o>!==</span> <span class=s2>&#34;undefined&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>Android</span><span class=p>.</span><span class=nx>postMessage</span><span class=p>(</span><span class=s2>&#34;testing&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Immediately receive message right after calling Android.postMessage
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>if</span> <span class=p>(</span><span class=k>typeof</span> <span class=nx>Android</span> <span class=o>!==</span> <span class=s2>&#34;undefined&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>Android</span><span class=p>.</span><span class=nx>onmessage</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>event</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Android.onmessage received: &#34;</span><span class=p>,</span> <span class=nx>event</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>雙向通訊大概就是這樣。除了傳送 string 之外，其實還可以傳送 binary data。Native app 那邊是用 <code>ByteArray</code> type；而 JavaScript 那邊就用 <code>ArrayBuffer</code> type。以為就不用刻意 base64 encode 圖片之類的 binary 文件。</p><p>另一樣要留意的是 <code>WebMessageListener</code> 執行的 thread 跟以往 <code>@JavascriptInterface</code> 不一樣。</p><h2 id=back-button-與進度條>Back button 與進度條<a hidden class=anchor aria-hidden=true href=#back-button-與進度條>#</a></h2><p><code>Activity</code> 的 <code>onBackPressed</code> method 因應 Android 14 (API level 34) 的 predictive back gesture 功能而 deprecated，如果要令 <code>WebView</code> 的上一頁加到 Android 系統的 back button 的話就要用 <code>onBackPressedDispatcher</code>。</p><p><code>onBackPressedDispatcher</code> 的用法其實跟 <code>Activity</code> 的 <code>onBackPressed</code> 完全相反。<code>onBackPressed</code> 是用戶按了 back 後會 call，你在這個 function 內控制是否 call super class 的 <code>onBackPressed</code>（即是真的讓系統處理 back）。而 <code>onBackPressedDispatcher</code> 是要你主動通知它目前是不是交由系統處理 back，如果設定成不由系統處理的話就會執行你的 <code>OnBackPressedCallback</code>。</p><p>要做到這個效果我們需要 override <code>WebViewClientCompat</code> 來取得目前 <code>WebView</code> 的 event，主要是留意 <code>onPageStarted</code>、<code>onPageFinished</code>、<code>onReceivedError</code>、<code>onReceivedHttpError</code>，然後在裏面檢查現在的 <code>WebView.canGoBack</code>。</p><p>另一樣是進度條，進度數值和是否需要顯示進度條是靠 <code>WebViewClientCompat</code> 和 <code>WebChromeClient</code>。<code>WebChromeClient</code> 沒有 compat 版，直接 override Android SDK 提供的就可以。</p><p>這兩項的 code 大約是這樣：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>class</span> <span class=nc>WebViewActivity</span> <span class=p>:</span> <span class=n>AppCompatActivity</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>lateinit</span> <span class=k>var</span> <span class=py>webView</span><span class=p>:</span> <span class=n>WebView</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>val</span> <span class=py>onBackPressedCallback</span> <span class=p>=</span> <span class=k>object</span> <span class=err>: </span><span class=nc>OnBackPressedCallback</span><span class=p>(</span><span class=k>false</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>override</span> <span class=k>fun</span> <span class=nf>handleOnBackPressed</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>webView</span><span class=p>.</span><span class=n>canGoBack</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>webView</span><span class=p>.</span><span class=n>goBack</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>onCreate</span><span class=p>(</span><span class=n>savedInstanceState</span><span class=p>:</span> <span class=n>Bundle</span><span class=p>?)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>super</span><span class=p>.</span><span class=n>onCreate</span><span class=p>(</span><span class=n>savedInstanceState</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>setContentView</span><span class=p>(</span><span class=nc>R</span><span class=p>.</span><span class=n>layout</span><span class=p>.</span><span class=n>activity_webview</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>webView</span> <span class=p>=</span> <span class=n>findViewById</span><span class=p>(</span><span class=nc>R</span><span class=p>.</span><span class=n>id</span><span class=p>.</span><span class=n>webview</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>webView</span><span class=p>.</span><span class=n>webViewClient</span> <span class=p>=</span> <span class=n>MyWebViewClient</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>onPageStarted</span> <span class=p>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 顯示載入中
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=n>onPageFinished</span> <span class=p>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 隱藏載入中
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=n>updateCanGoBackAndForward</span> <span class=p>=</span> <span class=p>{</span> <span class=n>canGoBack</span><span class=p>,</span> <span class=n>_</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 設定 onBackPressedCallback 是否啟用
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=c1>// 如果 WebView 沒有頁面可以返回就要停用我們的 callback，這樣就能 finish Activity
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>onBackPressedCallback</span><span class=p>.</span><span class=n>isEnabled</span> <span class=p>=</span> <span class=n>canGoBack</span>
</span></span><span class=line><span class=cl>            <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>webView</span><span class=p>.</span><span class=n>webChromeClient</span> <span class=p>=</span> <span class=n>MyWebChromeClient</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>onProgressChanged</span> <span class=p>=</span> <span class=p>{</span> <span class=n>newProgress</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 設定進度條的進度
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>onBackPressedDispatcher</span><span class=p>.</span><span class=n>addCallback</span><span class=p>(</span><span class=n>onBackPressedCallback</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>class</span> <span class=nc>MyWebViewClient</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>val</span> <span class=py>onPageStarted</span><span class=p>:</span> <span class=p>(</span><span class=n>url</span><span class=p>:</span> <span class=n>String</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Unit</span> <span class=p>=</span> <span class=p>{},</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>val</span> <span class=py>onPageFinished</span><span class=p>:</span> <span class=p>(</span><span class=n>url</span><span class=p>:</span> <span class=n>String</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Unit</span> <span class=p>=</span> <span class=p>{},</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>val</span> <span class=py>onReceivedError</span><span class=p>:</span> <span class=p>(</span><span class=n>request</span><span class=p>:</span> <span class=n>WebResourceRequest</span><span class=p>,</span> <span class=n>error</span><span class=p>:</span> <span class=n>WebResourceErrorCompat</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Unit</span> <span class=p>=</span> <span class=p>{</span> <span class=n>_</span><span class=p>,</span> <span class=n>_</span> <span class=o>-&gt;</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>val</span> <span class=py>onReceivedHttpError</span><span class=p>:</span> <span class=p>(</span><span class=n>request</span><span class=p>:</span> <span class=n>WebResourceRequest</span><span class=p>,</span> <span class=n>errorResponse</span><span class=p>:</span> <span class=n>WebResourceResponse</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Unit</span> <span class=p>=</span> <span class=p>{</span> <span class=n>_</span><span class=p>,</span> <span class=n>_</span> <span class=o>-&gt;</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>val</span> <span class=py>updateCanGoBackAndForward</span><span class=p>:</span> <span class=p>(</span><span class=n>canGoBack</span><span class=p>:</span> <span class=n>Boolean</span><span class=p>,</span> <span class=n>canGoForward</span><span class=p>:</span> <span class=n>Boolean</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Unit</span> <span class=p>=</span> <span class=p>{</span> <span class=n>_</span><span class=p>,</span> <span class=n>_</span> <span class=o>-&gt;</span> <span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>:</span> <span class=n>WebViewClientCompat</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>onPageStarted</span><span class=p>(</span><span class=n>view</span><span class=p>:</span> <span class=n>WebView</span><span class=p>,</span> <span class=n>url</span><span class=p>:</span> <span class=n>String</span><span class=p>,</span> <span class=n>favicon</span><span class=p>:</span> <span class=n>Bitmap</span><span class=p>?)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>super</span><span class=p>.</span><span class=n>onPageStarted</span><span class=p>(</span><span class=n>view</span><span class=p>,</span> <span class=n>url</span><span class=p>,</span> <span class=n>favicon</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>onPageStarted</span><span class=p>(</span><span class=n>url</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>updateCanGoBackAndForward</span><span class=p>(</span><span class=n>view</span><span class=p>.</span><span class=n>canGoBack</span><span class=p>(),</span> <span class=n>view</span><span class=p>.</span><span class=n>canGoForward</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>onPageFinished</span><span class=p>(</span><span class=n>view</span><span class=p>:</span> <span class=n>WebView</span><span class=p>,</span> <span class=n>url</span><span class=p>:</span> <span class=n>String</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>super</span><span class=p>.</span><span class=n>onPageFinished</span><span class=p>(</span><span class=n>view</span><span class=p>,</span> <span class=n>url</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>onPageFinished</span><span class=p>(</span><span class=n>url</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>updateCanGoBackAndForward</span><span class=p>(</span><span class=n>view</span><span class=p>.</span><span class=n>canGoBack</span><span class=p>(),</span> <span class=n>view</span><span class=p>.</span><span class=n>canGoForward</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>onReceivedError</span><span class=p>(</span><span class=n>view</span><span class=p>:</span> <span class=n>WebView</span><span class=p>,</span> <span class=n>request</span><span class=p>:</span> <span class=n>WebResourceRequest</span><span class=p>,</span> <span class=n>error</span><span class=p>:</span> <span class=n>WebResourceErrorCompat</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>super</span><span class=p>.</span><span class=n>onReceivedError</span><span class=p>(</span><span class=n>view</span><span class=p>,</span> <span class=n>request</span><span class=p>,</span> <span class=n>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>onReceivedError</span><span class=p>(</span><span class=n>request</span><span class=p>,</span> <span class=n>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>updateCanGoBackAndForward</span><span class=p>(</span><span class=n>view</span><span class=p>.</span><span class=n>canGoBack</span><span class=p>(),</span> <span class=n>view</span><span class=p>.</span><span class=n>canGoForward</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>onReceivedHttpError</span><span class=p>(</span><span class=n>view</span><span class=p>:</span> <span class=n>WebView</span><span class=p>,</span> <span class=n>request</span><span class=p>:</span> <span class=n>WebResourceRequest</span><span class=p>,</span> <span class=n>errorResponse</span><span class=p>:</span> <span class=n>WebResourceResponse</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>super</span><span class=p>.</span><span class=n>onReceivedHttpError</span><span class=p>(</span><span class=n>view</span><span class=p>,</span> <span class=n>request</span><span class=p>,</span> <span class=n>errorResponse</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>onReceivedHttpError</span><span class=p>(</span><span class=n>request</span><span class=p>,</span> <span class=n>errorResponse</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>updateCanGoBackAndForward</span><span class=p>(</span><span class=n>view</span><span class=p>.</span><span class=n>canGoBack</span><span class=p>(),</span> <span class=n>view</span><span class=p>.</span><span class=n>canGoForward</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>class</span> <span class=nc>MyWebChromeClient</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>onProgressChanged</span><span class=p>:</span> <span class=p>(</span><span class=n>newProgress</span><span class=p>:</span> <span class=n>Int</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Unit</span> <span class=p>=</span> <span class=p>{},</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>:</span> <span class=n>WebChromeClient</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>onProgressChanged</span><span class=p>(</span><span class=n>view</span><span class=p>:</span> <span class=n>WebView</span><span class=p>,</span> <span class=n>newProgress</span><span class=p>:</span> <span class=n>Int</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>super</span><span class=p>.</span><span class=n>onProgressChanged</span><span class=p>(</span><span class=n>view</span><span class=p>,</span> <span class=n>newProgress</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>onProgressChanged</span><span class=p>(</span><span class=n>newProgress</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=參考>參考<a hidden class=anchor aria-hidden=true href=#參考>#</a></h2><ul><li><a href=https://developer.android.com/develop/ui/views/layout/webapps/webview>Build web apps in WebView</a></li><li><a href=https://juejin.cn/post/7259762775365320741>使用 AndroidX 增强 WebView 的能力</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://eric.swiftzer.net/tags/android/>Android</a></li></ul><nav class=paginav><a class=prev href=https://eric.swiftzer.net/2024/06/firebase-cloud-messaging-legacy-api/><span class=title>« 上一頁</span><br><span>Firebase Cloud Messaging legacy API</span>
</a><a class=next href=https://eric.swiftzer.net/2024/02/android-14-migration/><span class=title>下一頁 »</span><br><span>Android 14 migration</span></a></nav></footer><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//efilm.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></article></main><footer class=footer><span>&copy; 2024 <a href=https://eric.swiftzer.net/>EricLog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>