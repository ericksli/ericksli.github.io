<!doctype html><html lang=zh-tw dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>用 Google Apps Script 建立 Google Calendar event | EricLog</title>
<meta name=keywords content="Google"><meta name=description content="Google Apps Script 是一套以 JavaScript 造的 API，可以讓你寫程式控制 Google Apps 內 Docs、Spreadsheet、Gmail、Drive 等等的功能。這次介紹如何用 Google Apps Script"><meta name=author content><link rel=canonical href=https://eric.swiftzer.net/2018/10/google-apps-script-create-calendar-event/><link crossorigin=anonymous href=/assets/css/stylesheet.48ed1b8bd3873bc86534e1a6b0ba618b6c80d8a975cf0cf1f1835c2b89c5c5b0.css integrity="sha256-SO0bi9OHO8hlNOGmsLphi2yA2Kl1zwzx8YNcK4nFxbA=" rel="preload stylesheet" as=style><link rel=icon href=https://eric.swiftzer.net/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://eric.swiftzer.net/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://eric.swiftzer.net/favicon-32x32.png><link rel=apple-touch-icon href=https://eric.swiftzer.net/apple-touch-icon.png><link rel=mask-icon href=https://eric.swiftzer.net/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh-tw href=https://eric.swiftzer.net/2018/10/google-apps-script-create-calendar-event/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=JetBrains+Mono:wght@300&display=swap" rel=stylesheet><script async src="https://www.googletagmanager.com/gtag/js?id=G-D93F946T73"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-D93F946T73",{anonymize_ip:!1})}</script><meta property="og:title" content="用 Google Apps Script 建立 Google Calendar event"><meta property="og:description" content="Google Apps Script 是一套以 JavaScript 造的 API，可以讓你寫程式控制 Google Apps 內 Docs、Spreadsheet、Gmail、Drive 等等的功能。這次介紹如何用 Google Apps Script"><meta property="og:type" content="article"><meta property="og:url" content="https://eric.swiftzer.net/2018/10/google-apps-script-create-calendar-event/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2018-10-17T14:49:46+08:00"><meta property="article:modified_time" content="2018-10-17T14:49:46+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="用 Google Apps Script 建立 Google Calendar event"><meta name=twitter:description content="Google Apps Script 是一套以 JavaScript 造的 API，可以讓你寫程式控制 Google Apps 內 Docs、Spreadsheet、Gmail、Drive 等等的功能。這次介紹如何用 Google Apps Script"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://eric.swiftzer.net/posts/"},{"@type":"ListItem","position":2,"name":"用 Google Apps Script 建立 Google Calendar event","item":"https://eric.swiftzer.net/2018/10/google-apps-script-create-calendar-event/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"用 Google Apps Script 建立 Google Calendar event","name":"用 Google Apps Script 建立 Google Calendar event","description":"Google Apps Script 是一套以 JavaScript 造的 API，可以讓你寫程式控制 Google Apps 內 Docs、Spreadsheet、Gmail、Drive 等等的功能。這次介紹如何用 Google Apps Script","keywords":["Google"],"articleBody":"Google Apps Script 是一套以 JavaScript 造的 API，可以讓你寫程式控制 Google Apps 內 Docs、Spreadsheet、Gmail、Drive 等等的功能。這次介紹如何用 Google Apps Script 建立 Google Calendar 的 event。我們會把部分建立 event 時所需要的資料放入 spreadsheet 內（會以 2019 年香港公眾假期作例子），然後用 Google Apps Script 讀取 spreadsheet 的內容再建立 event，效果就像 mail merge 般。\n準備內容 首先，去 Google Drive 建立一個 Spreadsheet。\n我們會將這些假期加到 Google Calendar 內 找出 Calendar ID 因為每人的 Google Calendar 可以有多於一個 calendar，所以第一件事就是要找到你想加入 event 那一個行事曆的 calendar ID。按 Tools \u003e Script editor 進入 Google Apps Script 的編輯工具。\n進入 Google Apps Script 的方法 這個編輯工具左邊是檔案列表，右邊是讓你修改程式碼。\n我們首先試試下面的一個 function：\nfunction listAllCalendars() { var calendars = CalendarApp.getAllCalendars(); calendars.forEach(function (c) { Logger.log(c.getName() + \" \u003e\u003e\u003e \" + c.getId()) }) } 在工具列，有一個選單，是用來選擇執行的 function。\n執行 function 的方法 選擇「listAllCalendars」，然後按 Run，你首先會看到 Google 要求授權窗口，授權後你就會看到「Running function listAllCalendars…」。這表示 listAllCalendars 正在執行中。\n執行中 執行完成後它會自動消失。消失後你可以按 Ctrl + Enter 開啟 Logs 窗口，你可以看到經由 Logger.log 記錄下來的 log。在 listAllCalendars 中，我們把 calendar 的名稱和對應的 ID 都記錄下來。因為之後建立 calendar event 是要利用到 calendar ID，所以你要把 calendar ID 抄起來備用。\nLogs 窗口 準備 event 描述範本 接着就返回 Script editor。Google Calendar 的 event 描述可以用一些基本的 HTML 標籤（例如 、、\n、、）。這次我們會用到 Google Apps Script 的 HTML template 功能。\n在選單中揀選 File \u003e New \u003e HTML file，之後輸入名稱「Calendar Template」。\n建立 HTML template HtmlService 的 template 功能主要是用 \u003c? ?\u003e 和 \u003c?= ?\u003e 兩款 tag。如果要用到 if、for 的話，就可以這樣做：\n\u003c? if (foo == 1) { ?\u003ebar\u003c? } ?\u003e 如果要輸出 bar 的內容（連 HTML escape），可以用：\n\u003c?= bar ?\u003e 我們會在每個 event 的描述顯示假期的中英文名稱。雖然看起來沒有甚麼用，但可以簡單示範這個功能。\n\u003cb\u003e英文名：\u003c/b\u003e \u003c?= enTitle ?\u003e \u003cbr\u003e\u003cb\u003e中文名：\u003c/b\u003e \u003c?= zhTitle ?\u003e 留意一點就是 Google Calendar 的 event 描述如果用 HTML 的話，它對空白字符的處理方式和網頁瀏覽器不同。網頁瀏覽器會將多於一個空白字符當成一個空白字符顯示（除非用 \u0026nbsp;）；但 Google Calendar 就會把所有空白字符顯示。所以如果講究排版效果的話就可能會令 HTML template 的 HTML code 混亂一點。\n讀取試算表內容 做好 HTML template 之後我們就要寫一個 function 把開首準備好的內容讀取並變成 JavaScript 的 object array。\nfunction extractHolidays() { var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Holidays') var values = sheet.getRange(2, 1, sheet.getMaxRows() - 1, 3).getValues() var results = [] for (var row in values) { var rowValues = values[row] // early termination if empty row is found if (rowValues[0] === '' || rowValues[1] === '' || rowValues[2] === '') { break } results.push({ zhTitle: rowValues[0], enTitle: rowValues[1], date: rowValues[2], }) } return results } SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Holidays') 其實就是取得當前檔案中的「Holidays」試算表的 Sheet。拿到 sheet 之後就可以讀寫試算表內的 cell。\n下一步就是要讀取指定範圍的 cell，那就是用 [getRange(row, column, numRows, numColumns)](https://developers.google.com/apps-script/reference/spreadsheet/sheet#getRange(Integer,Integer,Integer,Integer)。\nrow 填 2 是因為我們第一行是標題，第二行開始才是內容 column 填 1 是因為我們在 Column A 開始就是內容（由 1 開始數起） numRows 填 sheet.getMaxRows() - 1 即是我們要 sheet 的全部行，但扣除第一行標題（實際內容沒有那麼多行，所以之後會有 early termination 的部分） numColumns 填 3 是因為我們要讀取的內容是由 Column A 至 C，共三列 之後就做一個 JavaScript object 來儲起每筆記錄，方便之後使用。留意 Column C 我們的格式是 DateTime，Google Apps Script 會自動取得 JavaScript Date object。時區可參考 Spreadsheet 的 Spreadsheet settings 及 Script editor 的 Project properties。最後把生成的 array return 就行了。\n把 event 加到 calendar 內 最後的部分就是建立 Google calendar 的 event。\nvar CALENDAR_ID = 'xxxxxxxxxx@group.calendar.google.com' function createCalendarEvents() { var holidays = extractHolidays() var template = HtmlService.createTemplateFromFile('Calendar Template'); holidays.forEach(function (holiday) { var title = holiday.zhTitle template.zhTitle = holiday.zhTitle template.enTitle = holiday.enTitle var html = template.evaluate().getContent() CalendarApp.getCalendarById(CALENDAR_ID).createAllDayEvent(title, holiday.date, { description: html }) }) } CALENDAR_ID 就是最初抄下來的 calendar ID；holidays 就是剛才讀取 spreadsheet 的部分；template 就是建立之前準備好的 HTML template。\n然後就為每筆記錄（公眾假期）套進 HTML template 並生成 HTML code，之後就用 createAllDayEvent(title, date, options) 來建立 all-day event（因為公眾假期是全日的，如果你的 event 不是全日的話就改用 createEvent(title, startTime, endTime, options) 或其他 method）。\nHTML template 要把 template 內用過的 variable（即是 zhTitle 和 enTitle）設定好才可以生成 HTML code（template.evaluate().getContent() 這一句）。\n最後執行 createCalendarEvents 就可以建立 event。\n成品效果 編輯 event 會看到 HTML 格式的內容 留意每執行一次 createCalendarEvents 就會建立新的 event 而不是修改現有的 event。\n如果你想在再執行時跳過已建立過的 event 的話，可以在 spreadsheet 加多一個 column 標記來記錄這一筆資料是否已經建立過 event。下面兩句可供參考（記錄當前用戶電郵地址、時間）：\nsheet.getRange(row, column).setValue(Session.getActiveUser().getEmail()) sheet.getRange(row, column).setValue(new Date()) 完整程式碼 Google Apps Script 程式碼、HTML 和試算表內容已經放到 Gist 上。\n下一篇會講解利用 Google Apps Script 發送電郵（即是 mail merge）。\n補充 在處理時間時難免會想用 Moment.js 來格式化、計算時間，又或者用 Lodash 之類的 JavaScript library。Google Apps Script 是有機制 (App Script library) 讓你調用這些 library。詳情可以參考 Stack Overflow 的答案。\n","wordCount":"2127","inLanguage":"zh-tw","datePublished":"2018-10-17T14:49:46+08:00","dateModified":"2018-10-17T14:49:46+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://eric.swiftzer.net/2018/10/google-apps-script-create-calendar-event/"},"publisher":{"@type":"Organization","name":"EricLog","logo":{"@type":"ImageObject","url":"https://eric.swiftzer.net/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://eric.swiftzer.net/ accesskey=h title="EricLog (Alt + H)">EricLog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li></ul></div></div><ul id=menu><li><a href=https://eric.swiftzer.net/fonts/ title=Fonts><span>Fonts</span></a></li><li><a href=https://eric.swiftzer.net/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://eric.swiftzer.net/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://eric.swiftzer.net/about/ title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://eric.swiftzer.net/>首頁</a>&nbsp;»&nbsp;<a href=https://eric.swiftzer.net/posts/>Posts</a></div><h1 class=post-title>用 Google Apps Script 建立 Google Calendar event</h1><div class=post-meta>&lt;span title='2018-10-17 14:49:46 +0800 +0800'>October 17, 2018&lt;/span></div></header><div class=post-content><p><a href=https://developers.google.com/apps-script/>Google Apps Script</a> 是一套以 JavaScript 造的 API，可以讓你寫程式控制 Google Apps 內 Docs、Spreadsheet、Gmail、Drive 等等的功能。這次介紹如何用 Google Apps Script 建立 Google Calendar 的 event。我們會把部分建立 event 時所需要的資料放入 spreadsheet 內（會以 2019 年香港公眾假期作例子），然後用 Google Apps Script 讀取 spreadsheet 的內容再建立 event，效果就像 mail merge 般。</p><h2 id=準備內容>準備內容<a hidden class=anchor aria-hidden=true href=#準備內容>#</a></h2><p>首先，去 Google Drive 建立一個 Spreadsheet。</p><figure><img loading=lazy src=holiday-sheet.png><figcaption>我們會將這些假期加到 Google Calendar 內</figcaption></figure><h2 id=找出-calendar-id>找出 Calendar ID<a hidden class=anchor aria-hidden=true href=#找出-calendar-id>#</a></h2><p>因為每人的 Google Calendar 可以有多於一個 calendar，所以第一件事就是要找到你想加入 event 那一個行事曆的 calendar ID。按 Tools > Script editor 進入 Google Apps Script 的編輯工具。</p><figure><img loading=lazy src=spreadsheet-menu-script-editor.png><figcaption>進入 Google Apps Script 的方法</figcaption></figure><p>這個編輯工具左邊是檔案列表，右邊是讓你修改程式碼。</p><p>我們首先試試下面的一個 function：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>function</span> <span class=nx>listAllCalendars</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>var</span> <span class=nx>calendars</span> <span class=o>=</span> <span class=nx>CalendarApp</span><span class=p>.</span><span class=nx>getAllCalendars</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=nx>calendars</span><span class=p>.</span><span class=nx>forEach</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>c</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>Logger</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>getName</span><span class=p>()</span> <span class=o>+</span> <span class=s2>&#34; &gt;&gt;&gt; &#34;</span> <span class=o>+</span> <span class=nx>c</span><span class=p>.</span><span class=nx>getId</span><span class=p>())</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>在工具列，有一個選單，是用來選擇執行的 function。</p><figure><img loading=lazy src=run-script.png><figcaption>執行 function 的方法</figcaption></figure><p>選擇「listAllCalendars」，然後按 Run，你首先會看到 Google 要求授權窗口，授權後你就會看到「Running function listAllCalendars&mldr;」。這表示 <code>listAllCalendars</code> 正在執行中。</p><figure><img loading=lazy src=running-script.png><figcaption>執行中</figcaption></figure><p>執行完成後它會自動消失。消失後你可以按 <kbd>Ctrl</kbd> + <kbd>Enter</kbd> 開啟 Logs 窗口，你可以看到經由 <code>Logger.log</code> 記錄下來的 log。在 <code>listAllCalendars</code> 中，我們把 calendar 的名稱和對應的 ID 都記錄下來。因為之後建立 calendar event 是要利用到 calendar ID，所以你要把 calendar ID 抄起來備用。</p><figure><img loading=lazy src=apps-script-log.png><figcaption>Logs 窗口</figcaption></figure><h2 id=準備-event-描述範本>準備 event 描述範本<a hidden class=anchor aria-hidden=true href=#準備-event-描述範本>#</a></h2><p>接着就返回 Script editor。Google Calendar 的 event 描述可以用一些基本的 HTML 標籤（例如 <code>&lt;a></code>、<code>&lt;b></code>、<code>&lt;br></code>、<code>&lt;ul></code>、<code>&lt;li></code>）。這次我們會用到 Google Apps Script 的 HTML template 功能。</p><p>在選單中揀選 File > New > HTML file，之後輸入名稱「Calendar Template」。</p><figure><img loading=lazy src=apps-script-create-html.png><figcaption>建立 HTML template</figcaption></figure><p><a href=https://developers.google.com/apps-script/reference/html/html-service><code>HtmlService</code></a> 的 template 功能主要是用 <code>&lt;? ?></code> 和 <code>&lt;?= ?></code> 兩款 tag。如果要用到 <code>if</code>、<code>for</code> 的話，就可以這樣做：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=cp>&lt;? if (foo == 1) { ?&gt;</span>bar<span class=cp>&lt;? } ?&gt;</span></span></span></code></pre></div><p>如果要輸出 <code>bar</code> 的內容（連 HTML escape），可以用：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=cp>&lt;?= bar ?&gt;</span></span></span></code></pre></div><p>我們會在每個 event 的描述顯示假期的中英文名稱。雖然看起來沒有甚麼用，但可以簡單示範這個功能。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>b</span><span class=p>&gt;</span>英文名：<span class=p>&lt;/</span><span class=nt>b</span><span class=p>&gt;</span> <span class=cp>&lt;?= enTitle ?&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>br</span><span class=p>&gt;&lt;</span><span class=nt>b</span><span class=p>&gt;</span>中文名：<span class=p>&lt;/</span><span class=nt>b</span><span class=p>&gt;</span> <span class=cp>&lt;?= zhTitle ?&gt;</span></span></span></code></pre></div><p>留意一點就是 Google Calendar 的 event 描述如果用 HTML 的話，它對空白字符的處理方式和網頁瀏覽器不同。網頁瀏覽器會將多於一個空白字符當成一個空白字符顯示（除非用 <code>&amp;nbsp;</code>）；但 Google Calendar 就會把所有空白字符顯示。所以如果講究排版效果的話就可能會令 HTML template 的 HTML code 混亂一點。</p><h2 id=讀取試算表內容>讀取試算表內容<a hidden class=anchor aria-hidden=true href=#讀取試算表內容>#</a></h2><p>做好 HTML template 之後我們就要寫一個 function 把開首準備好的內容讀取並變成 JavaScript 的 object array。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>function</span> <span class=nx>extractHolidays</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>var</span> <span class=nx>sheet</span> <span class=o>=</span> <span class=nx>SpreadsheetApp</span><span class=p>.</span><span class=nx>getActiveSpreadsheet</span><span class=p>().</span><span class=nx>getSheetByName</span><span class=p>(</span><span class=s1>&#39;Holidays&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=kd>var</span> <span class=nx>values</span> <span class=o>=</span> <span class=nx>sheet</span><span class=p>.</span><span class=nx>getRange</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=nx>sheet</span><span class=p>.</span><span class=nx>getMaxRows</span><span class=p>()</span> <span class=o>-</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>3</span><span class=p>).</span><span class=nx>getValues</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=kd>var</span> <span class=nx>results</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=kd>var</span> <span class=nx>row</span> <span class=k>in</span> <span class=nx>values</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>rowValues</span> <span class=o>=</span> <span class=nx>values</span><span class=p>[</span><span class=nx>row</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=c1>// early termination if empty row is found
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>rowValues</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>===</span> <span class=s1>&#39;&#39;</span> <span class=o>||</span> <span class=nx>rowValues</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>===</span> <span class=s1>&#39;&#39;</span> <span class=o>||</span> <span class=nx>rowValues</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>===</span> <span class=s1>&#39;&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>break</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>results</span><span class=p>.</span><span class=nx>push</span><span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=nx>zhTitle</span><span class=o>:</span> <span class=nx>rowValues</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span>
</span></span><span class=line><span class=cl>      <span class=nx>enTitle</span><span class=o>:</span> <span class=nx>rowValues</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span>
</span></span><span class=line><span class=cl>      <span class=nx>date</span><span class=o>:</span> <span class=nx>rowValues</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>results</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p><code>SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Holidays')</code> 其實就是取得當前檔案中的「Holidays」試算表的 <a href=https://developers.google.com/apps-script/reference/spreadsheet/sheet><code>Sheet</code></a>。拿到 <code>sheet</code> 之後就可以讀寫試算表內的 cell。</p><p>下一步就是要讀取指定範圍的 cell，那就是用 [<code>getRange(row, column, numRows, numColumns)</code>](<a href=https://developers.google.com/apps-script/reference/spreadsheet/sheet#getRange(Integer,Integer,Integer,Integer)>https://developers.google.com/apps-script/reference/spreadsheet/sheet#getRange(Integer,Integer,Integer,Integer)</a>。</p><ul><li><code>row</code> 填 <code>2</code> 是因為我們第一行是標題，第二行開始才是內容</li><li><code>column</code> 填 <code>1</code> 是因為我們在 Column A 開始就是內容（由 1 開始數起）</li><li><code>numRows</code> 填 <code>sheet.getMaxRows() - 1</code> 即是我們要 sheet 的全部行，但扣除第一行標題（實際內容沒有那麼多行，所以之後會有 early termination 的部分）</li><li><code>numColumns</code> 填 <code>3</code> 是因為我們要讀取的內容是由 Column A 至 C，共三列</li></ul><p>之後就做一個 JavaScript object 來儲起每筆記錄，方便之後使用。留意 Column C 我們的格式是 <code>DateTime</code>，Google Apps Script 會自動取得 JavaScript <code>Date</code> object。時區可參考 Spreadsheet 的 Spreadsheet settings 及 Script editor 的 Project properties。最後把生成的 array return 就行了。</p><h2 id=把-event-加到-calendar-內>把 event 加到 calendar 內<a hidden class=anchor aria-hidden=true href=#把-event-加到-calendar-內>#</a></h2><p>最後的部分就是建立 Google calendar 的 event。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>CALENDAR_ID</span> <span class=o>=</span> <span class=s1>&#39;xxxxxxxxxx@group.calendar.google.com&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>createCalendarEvents</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>var</span> <span class=nx>holidays</span> <span class=o>=</span> <span class=nx>extractHolidays</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=kd>var</span> <span class=nx>template</span> <span class=o>=</span> <span class=nx>HtmlService</span><span class=p>.</span><span class=nx>createTemplateFromFile</span><span class=p>(</span><span class=s1>&#39;Calendar Template&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=nx>holidays</span><span class=p>.</span><span class=nx>forEach</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>holiday</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>title</span> <span class=o>=</span> <span class=nx>holiday</span><span class=p>.</span><span class=nx>zhTitle</span>
</span></span><span class=line><span class=cl>    <span class=nx>template</span><span class=p>.</span><span class=nx>zhTitle</span> <span class=o>=</span> <span class=nx>holiday</span><span class=p>.</span><span class=nx>zhTitle</span>
</span></span><span class=line><span class=cl>    <span class=nx>template</span><span class=p>.</span><span class=nx>enTitle</span> <span class=o>=</span> <span class=nx>holiday</span><span class=p>.</span><span class=nx>enTitle</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>html</span> <span class=o>=</span> <span class=nx>template</span><span class=p>.</span><span class=nx>evaluate</span><span class=p>().</span><span class=nx>getContent</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>CalendarApp</span><span class=p>.</span><span class=nx>getCalendarById</span><span class=p>(</span><span class=nx>CALENDAR_ID</span><span class=p>).</span><span class=nx>createAllDayEvent</span><span class=p>(</span><span class=nx>title</span><span class=p>,</span> <span class=nx>holiday</span><span class=p>.</span><span class=nx>date</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>description</span><span class=o>:</span> <span class=nx>html</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p><code>CALENDAR_ID</code> 就是最初抄下來的 calendar ID；<code>holidays</code> 就是剛才讀取 spreadsheet 的部分；<code>template</code> 就是建立之前準備好的 HTML template。</p><p>然後就為每筆記錄（公眾假期）套進 HTML template 並生成 HTML code，之後就用 <a href=https://developers.google.com/apps-script/reference/calendar/calendar-app#createalldayeventtitle-date-options><code>createAllDayEvent(title, date, options)</code></a> 來建立 all-day event（因為公眾假期是全日的，如果你的 event 不是全日的話就改用 <a href=https://developers.google.com/apps-script/reference/calendar/calendar#createEvent(String,Date,Date,Object)><code>createEvent(title, startTime, endTime, options)</code></a> 或其他 method）。</p><p>HTML template 要把 template 內用過的 variable（即是 <code>zhTitle</code> 和 <code>enTitle</code>）設定好才可以生成 HTML code（<code>template.evaluate().getContent()</code> 這一句）。</p><p>最後執行 <code>createCalendarEvents</code> 就可以建立 event。</p><figure><img loading=lazy src=google-calendar-event-created.png><figcaption>成品效果</figcaption></figure><figure><img loading=lazy src=edit-calendar-event.png><figcaption>編輯 event 會看到 HTML 格式的內容</figcaption></figure><p>留意每執行一次 <code>createCalendarEvents</code> 就會建立新的 event 而不是修改現有的 event。</p><p>如果你想在再執行時跳過已建立過的 event 的話，可以在 spreadsheet 加多一個 column 標記來記錄這一筆資料是否已經建立過 event。下面兩句可供參考（記錄當前用戶電郵地址、時間）：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>sheet</span><span class=p>.</span><span class=nx>getRange</span><span class=p>(</span><span class=nx>row</span><span class=p>,</span> <span class=nx>column</span><span class=p>).</span><span class=nx>setValue</span><span class=p>(</span><span class=nx>Session</span><span class=p>.</span><span class=nx>getActiveUser</span><span class=p>().</span><span class=nx>getEmail</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=nx>sheet</span><span class=p>.</span><span class=nx>getRange</span><span class=p>(</span><span class=nx>row</span><span class=p>,</span> <span class=nx>column</span><span class=p>).</span><span class=nx>setValue</span><span class=p>(</span><span class=k>new</span> <span class=nb>Date</span><span class=p>())</span></span></span></code></pre></div><h2 id=完整程式碼>完整程式碼<a hidden class=anchor aria-hidden=true href=#完整程式碼>#</a></h2><p>Google Apps Script 程式碼、HTML 和試算表內容已經放到 <a href=https://gist.github.com/ericksli/662e2edf7f5bd327990960ed03029bdf>Gist</a> 上。</p><p><a href=https://eric.swiftzer.net/2019/04/google-apps-script-send-email/>下一篇</a>會講解利用 Google Apps Script 發送電郵（即是 mail merge）。</p><hr><h2 id=補充>補充<a hidden class=anchor aria-hidden=true href=#補充>#</a></h2><p>在處理時間時難免會想用 <a href=https://momentjs.com/>Moment.js</a> 來格式化、計算時間，又或者用 <a href=https://lodash.com/>Lodash</a> 之類的 JavaScript library。Google Apps Script 是有機制 (App Script library) 讓你調用這些 library。詳情可以參考 <a href=https://stackoverflow.com/a/16928369>Stack Overflow</a> 的答案。</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://eric.swiftzer.net/tags/google/>Google</a></li></ul><nav class=paginav><a class=prev href=https://eric.swiftzer.net/2019/02/openrefine-snippets/><span class=title>« 上一頁</span><br><span>OpenRefine GREL 筆記</span>
</a><a class=next href=https://eric.swiftzer.net/2018/04/octopus-acquiring-business/><span class=title>下一頁 »</span><br><span>八達通新方向</span></a></nav></footer><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//efilm.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></article></main><footer class=footer><span>&copy; 2024 <a href=https://eric.swiftzer.net/>EricLog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>