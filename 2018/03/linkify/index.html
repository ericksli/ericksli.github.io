<!doctype html><html lang=zh-hant-hk dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Linkify 自動轉換成網址 | EricLog</title><meta name=keywords content="Android"><meta name=description content="最近工作需要將不完整的網址變成網址，但輸入的 string 可以是普通的文字，亦可以是一個沒有 http:// 或 https:// 的網址，亦可以一個完整的網址。但 TLD 有太多，如果自己寫 regular"><meta name=author content><link rel=canonical href=http://eric.swiftzer.net/2018/03/linkify/><link href=/assets/css/stylesheet.min.540e9d13c320add066cf1c3f0e0b529a475da4f4256e42083a40e3205f46886a.css integrity="sha256-VA6dE8MgrdBmzxw/DgtSmkddpPQlbkIIOkDjIF9GiGo=" rel="preload stylesheet" as=style><link rel=icon href=http://eric.swiftzer.net/favicon.ico><link rel=icon type=image/png sizes=16x16 href=http://eric.swiftzer.net/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=http://eric.swiftzer.net/favicon-32x32.png><link rel=apple-touch-icon href=http://eric.swiftzer.net/apple-touch-icon.png><link rel=mask-icon href=http://eric.swiftzer.net/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.80.0"><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=JetBrains+Mono:wght@300&display=swap" rel=stylesheet><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-1268728-8','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><meta property="og:title" content="Linkify 自動轉換成網址"><meta property="og:description" content="最近工作需要將不完整的網址變成網址，但輸入的 string 可以是普通的文字，亦可以是一個沒有 http:// 或 https:// 的網址，亦可以一個完整的網址。但 TLD 有太多，如果自己寫 regular"><meta property="og:type" content="article"><meta property="og:url" content="http://eric.swiftzer.net/2018/03/linkify/"><meta property="article:published_time" content="2018-03-10T11:18:56+08:00"><meta property="article:modified_time" content="2018-03-10T11:18:56+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Linkify 自動轉換成網址"><meta name=twitter:description content="最近工作需要將不完整的網址變成網址，但輸入的 string 可以是普通的文字，亦可以是一個沒有 http:// 或 https:// 的網址，亦可以一個完整的網址。但 TLD 有太多，如果自己寫 regular"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Linkify 自動轉換成網址","name":"Linkify 自動轉換成網址","description":"最近工作需要將不完整的網址變成網址，但輸入的 string 可以是普通的文字，亦可以是一個沒有 http:// 或 https:// 的網址，亦可以一個完整的網址。但 TLD 有太多，如果自己寫 regular","keywords":["Android"],"articleBody":"最近工作需要將不完整的網址變成網址，但輸入的 string 可以是普通的文字，亦可以是一個沒有 http:// 或 https:// 的網址，亦可以一個完整的網址。但 TLD 有太多，如果自己寫 regular expression 做檢查的話那句 regular expression 就會好長，而且要定時補上日後新推出的 TLD。\n之後查過原來 Android 有 Linkify/LinkifyCompat 這個 class：\n Linkify take a piece of text and a regular expression and turns all of the regex matches in the text into clickable links. This is particularly useful for matching things like email addresses, web URLs, etc. and making them actionable. Alone with the pattern that is to be matched, a URL scheme prefix is also required. Any pattern match that does not begin with the supplied scheme will have the scheme prepended to the matched text when the clickable URL is created. For instance, if you are matching web URLs you would supply the scheme http://. If the pattern matches example.com, which does not have a URL scheme prefix, the supplied scheme will be prepended to create http://example.com when the clickable URL link is created.\n 看起來應該合用，不過一般用法都是用來將 TextView 的合適文字變成可點擊的超連結。下面是我的做法：\nval query = \"example.com\" val spannable = SpannableString(query) LinkifyCompat.addLinks(spannable, Linkify.WEB_URLS) val linkifyUrl = spannable.getSpans(0, spannable.length, URLSpan::class.java) .filter { urlSpan - spannable.getSpanStart(urlSpan) == 0 \u0026\u0026 spannable.getSpanEnd(urlSpan) == spannable.length } .map { urlSpan - urlSpan.url } .firstOrNull() 首先將疑似網址的 string 變成 SpannableString。之後用 LinkifyCompat#addLinks 來檢查整個 string 有沒有網址。如果有的話，SpannableString 中的網址部分會有 span 包住。\n這次的要求是整個 query string 最多只有一個網址，如果沒有網址或出現多於一個網址的話，就當作沒有網址處理。所以要加上 filter 來篩走出現多於一個網址的情況。\n最後 linkifyUrl 會是 http://example.com；如果 query 沒有網址的話，那 linkifyUrl 會是 null。\n至於 LinkifyCompat 會不會定期更新 TLD 清單，我不太清楚，但當初出現 LinkifyCompat 就是用來補回新出的 TLD。\n","wordCount":"548","inLanguage":"en","datePublished":"2018-03-10T11:18:56+08:00","dateModified":"2018-03-10T11:18:56+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://eric.swiftzer.net/2018/03/linkify/"},"publisher":{"@type":"Organization","name":"EricLog","logo":{"@type":"ImageObject","url":"http://eric.swiftzer.net/favicon.ico"}}}</script></head><body id=top><script>if(localStorage.getItem("pref-theme")==="dark"){document.body.classList.add('dark');}else if(localStorage.getItem("pref-theme")==="light"){document.body.classList.remove('dark')}else if(window.matchMedia('(prefers-color-scheme: dark)').matches){document.body.classList.add('dark');}</script><noscript><style type=text/css>.theme-toggle,.top-link{display:none}</style></noscript><header class=header><nav class=nav><div class=logo><a href=http://eric.swiftzer.net/ accesskey=h title="EricLog (Alt + H)">EricLog</a>
<span class=logo-switches><span class=theme-toggle title="(Alt + T)"><a id=theme-toggle accesskey=t><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></a></span></span></div><ul class=menu id=menu onscroll=menu_on_scroll()><li><a href=http://eric.swiftzer.net/fonts/ title=Fonts><span>Fonts</span></a></li><li><a href=http://eric.swiftzer.net/archives/ title=Archives><span>Archives</span></a></li><li><a href=http://eric.swiftzer.net/tags/ title=Tags><span>Tags</span></a></li><li><a href=http://eric.swiftzer.net/about/ title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Linkify 自動轉換成網址</h1><div class=post-meta>March 10, 2018</div></header><div class=post-content><p>最近工作需要將不完整的網址變成網址，但輸入的 string 可以是普通的文字，亦可以是一個沒有 <code>http://</code> 或 <code>https://</code> 的網址，亦可以一個完整的網址。但 TLD 有太多，如果自己寫 regular expression 做檢查的話那句 regular expression 就會好長，而且要定時補上日後新推出的 TLD。</p><p>之後查過原來 Android 有 <a href=https://developer.android.com/reference/android/text/util/Linkify.html><code>Linkify</code></a>/<a href=https://developer.android.com/reference/android/support/v4/text/util/LinkifyCompat.html><code>LinkifyCompat</code></a> 這個 class：</p><blockquote><p>Linkify take a piece of text and a regular expression and turns all of the regex matches in the text into clickable links. This is particularly useful for matching things like email addresses, web URLs, etc. and making them actionable. Alone with the pattern that is to be matched, a URL scheme prefix is also required. Any pattern match that does not begin with the supplied scheme will have the scheme prepended to the matched text when the clickable URL is created. For instance, if you are matching web URLs you would supply the scheme <code>http://</code>. If the pattern matches example.com, which does not have a URL scheme prefix, the supplied scheme will be prepended to create <code>http://example.com</code> when the clickable URL link is created.</p></blockquote><p>看起來應該合用，不過一般用法都是用來將 <code>TextView</code> 的合適文字變成可點擊的超連結。下面是我的做法：</p><div class=highlight><pre class=chroma><code class=language-kotlin data-lang=kotlin><span class=k>val</span> <span class=py>query</span> <span class=p>=</span> <span class=s2>&#34;example.com&#34;</span>
<span class=k>val</span> <span class=py>spannable</span> <span class=p>=</span> <span class=n>SpannableString</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
<span class=n>LinkifyCompat</span><span class=p>.</span><span class=n>addLinks</span><span class=p>(</span><span class=n>spannable</span><span class=p>,</span> <span class=n>Linkify</span><span class=p>.</span><span class=n>WEB_URLS</span><span class=p>)</span>
<span class=k>val</span> <span class=py>linkifyUrl</span> <span class=p>=</span> <span class=n>spannable</span><span class=p>.</span><span class=n>getSpans</span><span class=p>(</span><span class=m>0</span><span class=p>,</span> <span class=n>spannable</span><span class=p>.</span><span class=n>length</span><span class=p>,</span> <span class=n>URLSpan</span><span class=o>::</span><span class=k>class</span><span class=p>.</span><span class=n>java</span><span class=p>)</span>
    <span class=p>.</span><span class=n>filter</span> <span class=p>{</span> <span class=n>urlSpan</span> <span class=o>-&gt;</span> <span class=n>spannable</span><span class=p>.</span><span class=n>getSpanStart</span><span class=p>(</span><span class=n>urlSpan</span><span class=p>)</span> <span class=o>==</span> <span class=m>0</span> <span class=o>&amp;&amp;</span> <span class=n>spannable</span><span class=p>.</span><span class=n>getSpanEnd</span><span class=p>(</span><span class=n>urlSpan</span><span class=p>)</span> <span class=o>==</span> <span class=n>spannable</span><span class=p>.</span><span class=n>length</span> <span class=p>}</span>
    <span class=p>.</span><span class=n>map</span> <span class=p>{</span> <span class=n>urlSpan</span> <span class=o>-&gt;</span> <span class=n>urlSpan</span><span class=p>.</span><span class=n>url</span> <span class=p>}</span>
    <span class=p>.</span><span class=n>firstOrNull</span><span class=p>()</span></code></pre></div><p>首先將疑似網址的 string 變成 <code>SpannableString</code>。之後用 <code>LinkifyCompat#addLinks</code> 來檢查整個 string 有沒有網址。如果有的話，<code>SpannableString</code> 中的網址部分會有 span 包住。</p><p>這次的要求是整個 <code>query</code> string 最多只有一個網址，如果沒有網址或出現多於一個網址的話，就當作沒有網址處理。所以要加上 <code>filter</code> 來篩走出現多於一個網址的情況。</p><p>最後 <code>linkifyUrl</code> 會是 <code>http://example.com</code>；如果 <code>query</code> 沒有網址的話，那 <code>linkifyUrl</code> 會是 <code>null</code>。</p><p>至於 <code>LinkifyCompat</code> 會不會定期更新 TLD 清單，我不太清楚，但當初出現 <code>LinkifyCompat</code> 就是用來<a href=https://www.reddit.com/r/androiddev/comments/52ye0h/heads_up_on_a_new_linkifycompat_that_brings_the/>補回新出的 TLD</a>。</p></div><footer class=post-footer><ul class=post-tags><li><a href=http://eric.swiftzer.net/tags/android/>Android</a></li></ul></footer><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"efilm"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></article></main><footer class=footer><span>&copy; 2021 <a href=http://eric.swiftzer.net/>EricLog</a></span>
<span>&#183;</span>
<span>Powered by <a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a></span>
<span>&#183;</span>
<span>Theme <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>window.onload=function(){if(localStorage.getItem("menu-scroll-position")){document.getElementById('menu').scrollLeft=localStorage.getItem("menu-scroll-position");}}
document.querySelectorAll('a[href^="#"]').forEach(anchor=>{anchor.addEventListener("click",function(e){e.preventDefault();var id=this.getAttribute("href").substr(1);if(!window.matchMedia('(prefers-reduced-motion: reduce)').matches){document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({behavior:"smooth"});}else{document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();}
if(id==="top"){history.replaceState(null,null," ");}else{history.pushState(null,null,`#${id}`);}});});var mybutton=document.getElementById("top-link");window.onscroll=function(){if(document.body.scrollTop>800||document.documentElement.scrollTop>800){mybutton.style.visibility="visible";mybutton.style.opacity="1";}else{mybutton.style.visibility="hidden";mybutton.style.opacity="0";}};function menu_on_scroll(){localStorage.setItem("menu-scroll-position",document.getElementById('menu').scrollLeft);}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{if(document.body.className.includes("dark")){document.body.classList.remove('dark');localStorage.setItem("pref-theme",'light');}else{document.body.classList.add('dark');localStorage.setItem("pref-theme",'dark');}})</script></body></html>