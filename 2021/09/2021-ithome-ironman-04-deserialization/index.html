<!doctype html><html lang=zh-tw dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>2021 iThome 鐵人賽 Day 4：Deserialization | EricLog</title><meta name=keywords content="2021 iThome 鐵人賽,Android"><meta name=description content="本篇文章是 2021 iThome 鐵人賽參賽題目「寫一個列車抵站時間 Android App」的第 4 篇，你可到 iThome 查看原文。 文章目錄 JSON serialization/deserialization 應該是不少 Android app 都會做的事，基本上近乎每個 Android"><meta name=author content><link rel=canonical href=https://ithelp.ithome.com.tw/articles/10267288><link crossorigin=anonymous href=/assets/css/stylesheet.min.249b1770ac429c01ffa746cc012a310192d174c913b1527f312e3294a0766d1c.css integrity="sha256-JJsXcKxCnAH/p0bMASoxAZLRdMkTsVJ/MS4ylKB2bRw=" rel="preload stylesheet" as=style><link rel=icon href=https://eric.swiftzer.net/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://eric.swiftzer.net/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://eric.swiftzer.net/favicon-32x32.png><link rel=apple-touch-icon href=https://eric.swiftzer.net/apple-touch-icon.png><link rel=mask-icon href=https://eric.swiftzer.net/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.101.0"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=JetBrains+Mono:wght@300&display=swap" rel=stylesheet><script async src="https://www.googletagmanager.com/gtag/js?id=G-D93F946T73"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-D93F946T73",{anonymize_ip:!1})}</script><meta property="og:title" content="2021 iThome 鐵人賽 Day 4：Deserialization"><meta property="og:description" content="本篇文章是 2021 iThome 鐵人賽參賽題目「寫一個列車抵站時間 Android App」的第 4 篇，你可到 iThome 查看原文。 文章目錄 JSON serialization/deserialization 應該是不少 Android app 都會做的事，基本上近乎每個 Android"><meta property="og:type" content="article"><meta property="og:url" content="https://eric.swiftzer.net/2021/09/2021-ithome-ironman-04-deserialization/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-09-19T00:00:00+08:00"><meta property="article:modified_time" content="2021-09-19T00:00:00+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="2021 iThome 鐵人賽 Day 4：Deserialization"><meta name=twitter:description content="本篇文章是 2021 iThome 鐵人賽參賽題目「寫一個列車抵站時間 Android App」的第 4 篇，你可到 iThome 查看原文。 文章目錄 JSON serialization/deserialization 應該是不少 Android app 都會做的事，基本上近乎每個 Android"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://eric.swiftzer.net/posts/"},{"@type":"ListItem","position":2,"name":"2021 iThome 鐵人賽 Day 4：Deserialization","item":"https://eric.swiftzer.net/2021/09/2021-ithome-ironman-04-deserialization/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"2021 iThome 鐵人賽 Day 4：Deserialization","name":"2021 iThome 鐵人賽 Day 4：Deserialization","description":"本篇文章是 2021 iThome 鐵人賽參賽題目「寫一個列車抵站時間 Android App」的第 4 篇，你可到 iThome 查看原文。 文章目錄 JSON serialization/deserialization 應該是不少 Android app 都會做的事，基本上近乎每個 Android","keywords":["2021 iThome 鐵人賽","Android"],"articleBody":" 本篇文章是 2021 iThome 鐵人賽參賽題目「寫一個列車抵站時間 Android App」的第 4 篇，你可到 iThome 查看原文。\n文章目錄\nJSON serialization/deserialization 應該是不少 Android app 都會做的事，基本上近乎每個 Android project 都會用了一個或幾個這些 library，而 Android 都有好幾個選擇。除了上一篇提過的 org.json 套件之外，Gson、Moshi 和 Kotlin serialization 都是熱門的選擇。\n一般的 deserialization library 都是透過 Java/Kotlin class 的 property 名和 data type 來跟 JSON 做轉換，例如你在 Java class 有一個叫 createdAt 的 String property，deserialization library 就會找 JSON object 有沒有一個叫 createdAt 的 property。如果有就把它以 String 的方式讀取，然後塞進去那個 Java class 的 createdAt property 入面。如果是 serialization 的話，就是把這個動作掉轉來做，就是看到 Java class 的 createdAt property 是 String，然後跟 Java String 最相近的 JSON data type 是 string，那 JSON object 就會出現 {\"createdAt\": \"2021-09-01\"}。\nGson Gson 是由 Google 開發，是上面三個 library 最早出現的一個，功能亦都很強大。例如可以設定 JSON 和 Java class property 之間的命名轉換規則（FieldNamingPolicy），亦都支援 streaming parsing，適合處理巨大的 JSON 文檔。\nMoshi Moshi 是 Square 開發的 JSON serialization/deserialization library。特色是它們功能上沒 Gson 那麼多，專注在主要的功能上，所以比 Gson 小巧。另外一大特色是它提供了 Kotlin codegen（一個 annotation processor 生成 Moshi 的 adapter），就是 Moshi 能感知你的 Kotlin class property 是不是 nullable 而決定是不是把那個 Kotlin class property 設定成那個 property 的預設值還是用 JSON document 找到的值。\nGson 是不會知道你那個 property 是不是 nullable，因為它是 Kotlin 的 language feature。所以在 Gson 做 deserialization 時的做法是：\n用 Java reflection 執行 default constructor（即是沒有參數的 constructor）建立那一個 object 看到那 JSON 有一個 property，就用 Java reflection 找那個 class 有沒有對應的 property，如果有就把 JSON property 的值塞進去那個 Java object 入面 問題就是出現在第二步，即使你在 default constructor 入面把那些 property 塞了不是 null 的值（如果是 Kotlin data class 就是在定義 property 時提供了預設值），但是如果 JSON property 的 value 是 null 的話 Gson 仍會把 null 塞入去那個 property。如果那個是 Kotlin 的 non-null property 那就會去到調用 property 的地方突然出現 NullPointerException。同樣的情況如果是用 Moshi 配合 Kotlin 支援的話，它就會在 deserialization 拋出 JsonDataException，不會把問題延到其他地方才發現。\nKotlin Serialization Kotlin Serialization 是那三個 library 最新的一個，我們將會用這個 library 來做 API JSON response 的 deserialization。這個 library 的特色是它是用 Kotlin compiler plugin 來生成 visitor 的 code（就是類似 Moshi 生成 adapter 般）、它本身的設計是支援多種格式諸如 Protobuf、Properties 等等還有是支援 Kotlin multiplatform。\nMoshi 有個問題是如果 property 是 non-null 但 JSON 對應的 property 是 null 的話它就會 throw exception，但 Kotlin serialization 經過設定後可以讓它設定那個 property 的預設值而不是 throw exception。\n如果你有 Protobuf 的需求的話，可以看看你是在那些地方用。如果是只有 app 自己在用（例如是 DataStore 的話）用 Kotlin serialization 都是不錯的選擇。但如果是和其他地方（例如跟 backend 之間通訊）那就不如考慮其他的 library。因為 Kotlin serialization 的野心是如果 backend、mobile 都是用 Kotlin 寫的話，那就只需要交換那個加了 Kotlin serialization annotation 的 data class 原檔就可以了，不需要再交換 proto 檔作中轉。另外，Kotlin serialization 是用 proto2，如果要用 proto3 還是用其他 library。\nResponse data class 我們選好了 Kotlin serialization，那就為先前的 data class 補回 annotation。其實要補回的 annotation 只有兩個：\n@Serializable 放在 class 開頭 @SerialName 放在 property 開頭，用以指明 JSON 的 property 名 @Serializable data class EtaResponse( /** * system status code. */ @SerialName(\"status\") val status: Int = STATUS_ERROR_OR_ALERT, /** * Alert message. */ @SerialName(\"message\") val message: String = \"\", /** * URL for Special Train Services Arrangement case. */ @SerialName(\"url\") val url: String = \"\", /** * Indicate if the train is delayed. */ @SerialName(\"isdelay\") val isDelay: String = IS_DELAY_FALSE, @SerialName(\"data\") val data: Map\u003cString, Data\u003e = emptyMap() ) { @Serializable data class Data( /** * Indicate the destinations of the train in the specific line (up trip). */ @SerialName(\"UP\") val up: List\u003cEta\u003e = emptyList(), /** * Indicate the destinations of the train in the specific line (down trip). */ @SerialName(\"DOWN\") val down: List\u003cEta\u003e = emptyList() ) @Serializable data class Eta( /** * Platform numbers for the departure / arrival train. */ @SerialName(\"plat\") val plat: String = \"1\", /** * Estimated arrival time (or departure time) of the train. */ @SerialName(\"time\") val time: String = EMPTY_TIMESTAMP, /** * MTR Station Code in capital letters. */ @SerialName(\"dest\") val dest: String = \"\", /** * The sequence of the 4 upcoming trains. */ @SerialName(\"seq\") val seq: String = \"0\" ) companion object { const val EMPTY_TIMESTAMP = \"-\" const val STATUS_NORMAL = 1 const val STATUS_ERROR_OR_ALERT = 0 const val IS_DELAY_TRUE = \"Y\" const val IS_DELAY_FALSE = \"N\" } } R8 rules 不要忘記在 proguard-rules.pro 加入對應的 R8 rule。如果不加就會有問題。\n-keepattributes *Annotation*, InnerClasses -dontnote kotlinx.serialization.AnnotationsKt # core serialization annotations # kotlinx-serialization-json specific. Add this if you have java.lang.NoClassDefFoundError kotlinx.serialization.json.JsonObjectSerializer -keepclassmembers class kotlinx.serialization.json.** { *** Companion; } -keepclasseswithmembers class kotlinx.serialization.json.** { kotlinx.serialization.KSerializer serializer(...); } # Change here net.swiftzer.etademo -keep,includedescriptorclasses class net.swiftzer.etademo.**$$serializer { *; } # \u003c-- change package name to your app's -keepclassmembers class net.swiftzer.etademo.** { # \u003c-- change package name to your app's *** Companion; } -keepclasseswithmembers class net.swiftzer.etademo.** { # \u003c-- change package name to your app's kotlinx.serialization.KSerializer serializer(...); } ","wordCount":"1698","inLanguage":"zh-tw","datePublished":"2021-09-19T00:00:00+08:00","dateModified":"2021-09-19T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://eric.swiftzer.net/2021/09/2021-ithome-ironman-04-deserialization/"},"publisher":{"@type":"Organization","name":"EricLog","logo":{"@type":"ImageObject","url":"https://eric.swiftzer.net/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://eric.swiftzer.net/ accesskey=h title="EricLog (Alt + H)">EricLog</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://eric.swiftzer.net/fonts/ title=Fonts><span>Fonts</span></a></li><li><a href=https://eric.swiftzer.net/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://eric.swiftzer.net/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://eric.swiftzer.net/about/ title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://eric.swiftzer.net/>首頁</a>&nbsp;»&nbsp;<a href=https://eric.swiftzer.net/posts/>Posts</a></div><h1 class=post-title>2021 iThome 鐵人賽 Day 4：Deserialization</h1><div class=post-meta>September 19, 2021</div></header><div class=post-content><blockquote><p>本篇文章是 <a href=https://ithelp.ithome.com.tw/2021ironman>2021 iThome 鐵人賽</a>參賽題目「<a href=https://ithelp.ithome.com.tw/users/20139666/ironman/4661>寫一個列車抵站時間 Android App</a>」的第 4 篇，你可到 iThome <a href=https://ithelp.ithome.com.tw/articles/10267288>查看原文</a>。</p><p><a href=https://eric.swiftzer.net/2021-ithome-ironman/>文章目錄</a></p></blockquote><p>JSON serialization/deserialization 應該是不少 Android app 都會做的事，基本上近乎每個 Android project 都會用了一個或幾個這些 library，而 Android 都有好幾個選擇。除了上一篇提過的 <a href=https://developer.android.com/reference/org/json/package-summary>org.json 套件</a>之外，<a href=https://github.com/google/gson>Gson</a>、<a href=https://github.com/square/moshi>Moshi</a> 和 <a href=https://github.com/Kotlin/kotlinx.serialization>Kotlin serialization</a> 都是熱門的選擇。</p><p>一般的 deserialization library 都是透過 Java/Kotlin class 的 property 名和 data type 來跟 JSON 做轉換，例如你在 Java class 有一個叫 <code>createdAt</code> 的 <code>String</code> property，deserialization library 就會找 JSON object 有沒有一個叫 <code>createdAt</code> 的 property。如果有就把它以 <code>String</code> 的方式讀取，然後塞進去那個 Java class 的 <code>createdAt</code> property 入面。如果是 serialization 的話，就是把這個動作掉轉來做，就是看到 Java class 的 <code>createdAt</code> property 是 <code>String</code>，然後跟 Java <code>String</code> 最相近的 JSON data type 是 <code>string</code>，那 JSON object 就會出現 <code>{"createdAt": "2021-09-01"}</code>。</p><h2 id=gson>Gson<a hidden class=anchor aria-hidden=true href=#gson>#</a></h2><p><a href=https://github.com/google/gson>Gson</a> 是由 Google 開發，是上面三個 library 最早出現的一個，功能亦都很強大。例如可以設定 JSON 和 Java class property 之間的命名轉換規則（<a href=https://www.javadoc.io/doc/com.google.code.gson/gson/2.8.5/com/google/gson/FieldNamingPolicy.html><code>FieldNamingPolicy</code></a>），亦都支援 <a href=https://sites.google.com/site/gson/streaming>streaming parsing</a>，適合處理巨大的 JSON 文檔。</p><h2 id=moshi>Moshi<a hidden class=anchor aria-hidden=true href=#moshi>#</a></h2><p>Moshi 是 Square 開發的 JSON serialization/deserialization library。特色是它們功能上沒 Gson 那麼多，專注在主要的功能上，所以比 Gson 小巧。另外一大特色是它提供了 Kotlin codegen（一個 annotation processor 生成 Moshi 的 adapter），就是 Moshi 能感知你的 Kotlin class property 是不是 nullable 而決定是不是把那個 Kotlin class property 設定成那個 property 的預設值還是用 JSON document 找到的值。</p><p>Gson 是不會知道你那個 property 是不是 nullable，因為它是 Kotlin 的 language feature。所以在 Gson 做 deserialization 時的做法是：</p><ol><li>用 Java reflection 執行 default constructor（即是沒有參數的 constructor）建立那一個 object</li><li>看到那 JSON 有一個 property，就用 Java reflection 找那個 class 有沒有對應的 property，如果有就把 JSON property 的值塞進去那個 Java object 入面</li></ol><p>問題就是出現在第二步，即使你在 default constructor 入面把那些 property 塞了不是 null 的值（如果是 Kotlin data class 就是在定義 property 時提供了預設值），但是如果 JSON property 的 value 是 null 的話 Gson 仍會把 null 塞入去那個 property。如果那個是 Kotlin 的 non-null property 那就會去到調用 property 的地方突然出現 <code>NullPointerException</code>。同樣的情況如果是用 Moshi 配合 Kotlin 支援的話，它就會在 deserialization 拋出 <code>JsonDataException</code>，不會把問題延到其他地方才發現。</p><h2 id=kotlin-serialization>Kotlin Serialization<a hidden class=anchor aria-hidden=true href=#kotlin-serialization>#</a></h2><p>Kotlin Serialization 是那三個 library 最新的一個，我們將會用這個 library 來做 API JSON response 的 deserialization。這個 library 的特色是它是用 Kotlin compiler plugin 來生成 visitor 的 code（就是類似 Moshi 生成 adapter 般）、它本身的設計是支援多種格式諸如 Protobuf、Properties 等等還有是支援 Kotlin multiplatform。</p><p>Moshi 有個問題是如果 property 是 non-null 但 JSON 對應的 property 是 null 的話它就會 throw exception，但 Kotlin serialization 經過設定後可以讓它設定那個 property 的預設值而不是 throw exception。</p><p>如果你有 Protobuf 的需求的話，可以看看你是在那些地方用。如果是只有 app 自己在用（例如是 <a href=https://developer.android.com/topic/libraries/architecture/datastore>DataStore</a> 的話）用 Kotlin serialization 都是不錯的選擇。但如果是和其他地方（例如跟 backend 之間通訊）那就不如考慮其他的 library。因為 Kotlin serialization 的<a href=https://github.com/Kotlin/kotlinx.serialization/issues/477#issuecomment-498019273>野心</a>是如果 backend、mobile 都是用 Kotlin 寫的話，那就只需要交換那個加了 Kotlin serialization annotation 的 data class 原檔就可以了，不需要再交換 proto 檔作中轉。另外，Kotlin serialization 是用 proto2，如果要用 proto3 還是用其他 library。</p><h2 id=response-data-class>Response data class<a hidden class=anchor aria-hidden=true href=#response-data-class>#</a></h2><p>我們選好了 Kotlin serialization，那就為先前的 data class 補回 annotation。其實要補回的 annotation 只有兩個：</p><ul><li><code>@Serializable</code> 放在 class 開頭</li><li><code>@SerialName</code> 放在 property 開頭，用以指明 JSON 的 property 名</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=nd>@Serializable</span>
</span></span><span class=line><span class=cl><span class=k>data</span> <span class=k>class</span> <span class=nc>EtaResponse</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * system status code.
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=nd>@SerialName</span><span class=p>(</span><span class=s2>&#34;status&#34;</span><span class=p>)</span> <span class=k>val</span> <span class=py>status</span><span class=p>:</span> <span class=n>Int</span> <span class=p>=</span> <span class=n>STATUS_ERROR_OR_ALERT</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Alert message.
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=nd>@SerialName</span><span class=p>(</span><span class=s2>&#34;message&#34;</span><span class=p>)</span> <span class=k>val</span> <span class=py>message</span><span class=p>:</span> <span class=n>String</span> <span class=p>=</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * URL for Special Train Services Arrangement case.
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=nd>@SerialName</span><span class=p>(</span><span class=s2>&#34;url&#34;</span><span class=p>)</span> <span class=k>val</span> <span class=py>url</span><span class=p>:</span> <span class=n>String</span> <span class=p>=</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Indicate if the train is delayed.
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=nd>@SerialName</span><span class=p>(</span><span class=s2>&#34;isdelay&#34;</span><span class=p>)</span> <span class=k>val</span> <span class=py>isDelay</span><span class=p>:</span> <span class=n>String</span> <span class=p>=</span> <span class=n>IS_DELAY_FALSE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nd>@SerialName</span><span class=p>(</span><span class=s2>&#34;data&#34;</span><span class=p>)</span> <span class=k>val</span> <span class=py>data</span><span class=p>:</span> <span class=n>Map</span><span class=p>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>Data</span><span class=p>&gt;</span> <span class=p>=</span> <span class=n>emptyMap</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Serializable</span>
</span></span><span class=line><span class=cl>    <span class=k>data</span> <span class=k>class</span> <span class=nc>Data</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>         * Indicate the destinations of the train in the specific line (up trip).
</span></span></span><span class=line><span class=cl><span class=cm>         */</span>
</span></span><span class=line><span class=cl>        <span class=nd>@SerialName</span><span class=p>(</span><span class=s2>&#34;UP&#34;</span><span class=p>)</span> <span class=k>val</span> <span class=py>up</span><span class=p>:</span> <span class=n>List</span><span class=p>&lt;</span><span class=n>Eta</span><span class=p>&gt;</span> <span class=p>=</span> <span class=n>emptyList</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>         * Indicate the destinations of the train in the specific line (down trip).
</span></span></span><span class=line><span class=cl><span class=cm>         */</span>
</span></span><span class=line><span class=cl>        <span class=nd>@SerialName</span><span class=p>(</span><span class=s2>&#34;DOWN&#34;</span><span class=p>)</span> <span class=k>val</span> <span class=py>down</span><span class=p>:</span> <span class=n>List</span><span class=p>&lt;</span><span class=n>Eta</span><span class=p>&gt;</span> <span class=p>=</span> <span class=n>emptyList</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Serializable</span>
</span></span><span class=line><span class=cl>    <span class=k>data</span> <span class=k>class</span> <span class=nc>Eta</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>         * Platform numbers for the departure / arrival train.
</span></span></span><span class=line><span class=cl><span class=cm>         */</span>
</span></span><span class=line><span class=cl>        <span class=nd>@SerialName</span><span class=p>(</span><span class=s2>&#34;plat&#34;</span><span class=p>)</span> <span class=k>val</span> <span class=py>plat</span><span class=p>:</span> <span class=n>String</span> <span class=p>=</span> <span class=s2>&#34;1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>         * Estimated arrival time (or departure time) of the train.
</span></span></span><span class=line><span class=cl><span class=cm>         */</span>
</span></span><span class=line><span class=cl>        <span class=nd>@SerialName</span><span class=p>(</span><span class=s2>&#34;time&#34;</span><span class=p>)</span> <span class=k>val</span> <span class=py>time</span><span class=p>:</span> <span class=n>String</span> <span class=p>=</span> <span class=n>EMPTY_TIMESTAMP</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>         * MTR Station Code in capital letters.
</span></span></span><span class=line><span class=cl><span class=cm>         */</span>
</span></span><span class=line><span class=cl>        <span class=nd>@SerialName</span><span class=p>(</span><span class=s2>&#34;dest&#34;</span><span class=p>)</span> <span class=k>val</span> <span class=py>dest</span><span class=p>:</span> <span class=n>String</span> <span class=p>=</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>         * The sequence of the 4 upcoming trains.
</span></span></span><span class=line><span class=cl><span class=cm>         */</span>
</span></span><span class=line><span class=cl>        <span class=nd>@SerialName</span><span class=p>(</span><span class=s2>&#34;seq&#34;</span><span class=p>)</span> <span class=k>val</span> <span class=py>seq</span><span class=p>:</span> <span class=n>String</span> <span class=p>=</span> <span class=s2>&#34;0&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>companion</span> <span class=k>object</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>const</span> <span class=k>val</span> <span class=py>EMPTY</span><span class=n>_TIMESTAMP</span> <span class=p>=</span> <span class=s2>&#34;-&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>const</span> <span class=k>val</span> <span class=py>STATUS</span><span class=n>_NORMAL</span> <span class=p>=</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>        <span class=k>const</span> <span class=k>val</span> <span class=py>STATUS</span><span class=n>_ERROR_OR_ALERT</span> <span class=p>=</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>        <span class=k>const</span> <span class=k>val</span> <span class=py>IS</span><span class=n>_DELAY_TRUE</span> <span class=p>=</span> <span class=s2>&#34;Y&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>const</span> <span class=k>val</span> <span class=py>IS</span><span class=n>_DELAY_FALSE</span> <span class=p>=</span> <span class=s2>&#34;N&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=r8-rules>R8 rules<a hidden class=anchor aria-hidden=true href=#r8-rules>#</a></h2><p>不要忘記在 <a href=http://proguard-rules.pro/>proguard-rules.pro</a> 加入<a href=https://github.com/Kotlin/kotlinx.serialization#android>對應的 R8 rule</a>。如果不加就會有問題。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>-keepattributes *Annotation*, InnerClasses
</span></span><span class=line><span class=cl>-dontnote kotlinx.serialization.AnnotationsKt # core serialization annotations
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># kotlinx-serialization-json specific. Add this if you have java.lang.NoClassDefFoundError kotlinx.serialization.json.JsonObjectSerializer
</span></span><span class=line><span class=cl>-keepclassmembers class kotlinx.serialization.json.** {
</span></span><span class=line><span class=cl>    *** Companion;
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>-keepclasseswithmembers class kotlinx.serialization.json.** {
</span></span><span class=line><span class=cl>    kotlinx.serialization.KSerializer serializer(...);
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># Change here net.swiftzer.etademo
</span></span><span class=line><span class=cl>-keep,includedescriptorclasses class net.swiftzer.etademo.**$$serializer { *; } # &lt;-- change package name to your app&#39;s
</span></span><span class=line><span class=cl>-keepclassmembers class net.swiftzer.etademo.** { # &lt;-- change package name to your app&#39;s
</span></span><span class=line><span class=cl>    *** Companion;
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>-keepclasseswithmembers class net.swiftzer.etademo.** { # &lt;-- change package name to your app&#39;s
</span></span><span class=line><span class=cl>    kotlinx.serialization.KSerializer serializer(...);
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://eric.swiftzer.net/tags/2021-ithome-%E9%90%B5%E4%BA%BA%E8%B3%BD/>2021 iThome 鐵人賽</a></li><li><a href=https://eric.swiftzer.net/tags/android/>Android</a></li></ul><nav class=paginav><a class=prev href=https://eric.swiftzer.net/2021/09/2021-ithome-ironman-05-dependency-injection/><span class=title>« 上一篇</span><br><span>2021 iThome 鐵人賽 Day 5：Dependency injection</span></a>
<a class=next href=https://eric.swiftzer.net/2021/09/2021-ithome-ironman-03-endpoint/><span class=title>下一篇 »</span><br><span>2021 iThome 鐵人賽 Day 3：Endpoint</span></a></nav></footer><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//efilm.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></article></main><footer class=footer><span>&copy; 2022 <a href=https://eric.swiftzer.net/>EricLog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>