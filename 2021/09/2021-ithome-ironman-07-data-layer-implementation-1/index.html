<!doctype html><html lang=zh-tw dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>2021 iThome 鐵人賽 Day 7：Data layer implementation (1) | EricLog</title>
<meta name=keywords content="2021 iThome 鐵人賽,Android"><meta name=description content="本篇文章是 2021 iThome 鐵人賽參賽題目「寫一個列車抵站時間 Android App」的第 7 篇，你可到 iThome 查看原文。 文章目錄 在上一篇，我們把 Ktor client 加到 Dagger 的 object graph 內。現在我們就"><meta name=author content><link rel=canonical href=https://ithelp.ithome.com.tw/articles/10269457><link crossorigin=anonymous href=/assets/css/stylesheet.014d92f7e42768013bc6e6c6aaf7562cad235ef48b65d729ba2e6b2ceb3a58e1.css integrity="sha256-AU2S9+QnaAE7xubGqvdWLK0jXvSLZdcpui5rLOs6WOE=" rel="preload stylesheet" as=style><link rel=icon href=https://eric.swiftzer.net/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://eric.swiftzer.net/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://eric.swiftzer.net/favicon-32x32.png><link rel=apple-touch-icon href=https://eric.swiftzer.net/apple-touch-icon.png><link rel=mask-icon href=https://eric.swiftzer.net/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh-tw href=https://eric.swiftzer.net/2021/09/2021-ithome-ironman-07-data-layer-implementation-1/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=JetBrains+Mono:wght@300&display=swap" rel=stylesheet><script async src="https://www.googletagmanager.com/gtag/js?id=G-D93F946T73"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-D93F946T73",{anonymize_ip:!1})}</script><meta property="og:title" content="2021 iThome 鐵人賽 Day 7：Data layer implementation (1)"><meta property="og:description" content="本篇文章是 2021 iThome 鐵人賽參賽題目「寫一個列車抵站時間 Android App」的第 7 篇，你可到 iThome 查看原文。 文章目錄 在上一篇，我們把 Ktor client 加到 Dagger 的 object graph 內。現在我們就"><meta property="og:type" content="article"><meta property="og:url" content="https://eric.swiftzer.net/2021/09/2021-ithome-ironman-07-data-layer-implementation-1/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-09-22T00:00:00+08:00"><meta property="article:modified_time" content="2021-09-22T00:00:00+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="2021 iThome 鐵人賽 Day 7：Data layer implementation (1)"><meta name=twitter:description content="本篇文章是 2021 iThome 鐵人賽參賽題目「寫一個列車抵站時間 Android App」的第 7 篇，你可到 iThome 查看原文。 文章目錄 在上一篇，我們把 Ktor client 加到 Dagger 的 object graph 內。現在我們就"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://eric.swiftzer.net/posts/"},{"@type":"ListItem","position":2,"name":"2021 iThome 鐵人賽 Day 7：Data layer implementation (1)","item":"https://eric.swiftzer.net/2021/09/2021-ithome-ironman-07-data-layer-implementation-1/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"2021 iThome 鐵人賽 Day 7：Data layer implementation (1)","name":"2021 iThome 鐵人賽 Day 7：Data layer implementation (1)","description":"本篇文章是 2021 iThome 鐵人賽參賽題目「寫一個列車抵站時間 Android App」的第 7 篇，你可到 iThome 查看原文。 文章目錄 在上一篇，我們把 Ktor client 加到 Dagger 的 object graph 內。現在我們就","keywords":["2021 iThome 鐵人賽","Android"],"articleBody":" 本篇文章是 2021 iThome 鐵人賽參賽題目「寫一個列車抵站時間 Android App」的第 7 篇，你可到 iThome 查看原文。\n文章目錄\n在上一篇，我們把 Ktor client 加到 Dagger 的 object graph 內。現在我們就繼續寫 data layer 部分。\n跨 layer 共用部分 不過在繼續之前，我們要先準備一些通用的 enum。這些 enum 分別是用來表示路綫、車站和語言。因為這次的示範 app 所用到的車站和路綫的數量有限，我們就簡化用 enum 寫死在 app 入面就算了，但如果數量多的話或許會改用 SQLite database 之類去儲存它們。在這種情況下，我們一般都會每個 layer 都有對應的 data class 表示，而不會好像現在把 data class/enum 放在 common 的地方。\nenum class Line(val zh: String, val en: String) { AEL(\"機場快綫\", \"Airport Express\"), TCL(\"東涌綫\", \"Tung Chung Line\"), TML(\"屯馬綫\", \"Tuen Ma Line\"), TKL(\"將軍澳綫\", \"Tseung Kwan O Line\"), } enum class Station(val zh: String, val en: String) { UNKNOWN(\"\", \"\"), HOK(\"香港\", \"Hong Kong\"), KOW(\"九龍\", \"Kowloon\"), OLY(\"奧運\", \"Olympic\"), NAC(\"南昌\", \"Nam Cheong\"), LAK(\"茘景\", \"Lai King\"), TSY(\"青衣\", \"Tsing Yi\"), SUN(\"欣澳\", \"Sunny Bay\"), TUC(\"東涌\", \"Tung Chung\"), AIR(\"機場\", \"Airport\"), AWE(\"博覽館\", \"AsiaWorld-Expo\"), WKS(\"烏溪沙\", \"Wu Kai Sha\"), MOS(\"馬鞍山\", \"Ma On Shan\"), HEO(\"恆安\", \"Heng On\"), TSH(\"大水坑\", \"Tai Shui Hang\"), SHM(\"石門\", \"Shek Mun\"), CIO(\"第一城\", \"City One\"), STW(\"沙田圍\", \"Sha Tin Wai\"), CKT(\"車公廟\", \"Che Kung Temple\"), TAW(\"大圍\", \"Tai Wai\"), HIK(\"顯徑\", \"Hin Keng\"), DIH(\"鑽石山\", \"Diamond Hill\"), KAT(\"啟德\", \"Kai Tak\"), SUW(\"宋皇臺\", \"Sung Wong Toi\"), TKW(\"土瓜灣\", \"To Kwa Wan\"), HOM(\"何文田\", \"Ho Man Tin\"), HUH(\"紅磡\", \"Hung Hom\"), ETS(\"尖東\", \"East Tsim Sha Tsui\"), AUS(\"柯士甸\", \"Austin\"), MEF(\"美孚\", \"Mei Foo\"), TWW(\"荃灣西\", \"Tsuen Wan West\"), KSR(\"錦上路\", \"Kam Sheung Road\"), YUL(\"元朗\", \"Yuen Long\"), LOP(\"朗屏\", \"Long Ping\"), TIS(\"天水圍\", \"Tin Shui Wai\"), SIH(\"兆康\", \"Siu Hong\"), TUM(\"屯門\", \"Tuen Mun\"), NOP(\"北角\", \"North Point\"), QUB(\"鰂魚涌\", \"Quarry Bay\"), YAT(\"油塘\", \"Yau Tong\"), TIK(\"調景嶺\", \"Tiu Keng Leng\"), TKO(\"將軍澳\", \"Tseung Kwan O\"), HAH(\"坑口\", \"Hang Hau\"), POA(\"寶琳\", \"Po Lam\"), LHP(\"康城\", \"LOHAS Park\"), } enum class Language { CHINESE, ENGLISH, } Domain layer 準備工作 雖然本篇題目是 data layer，但因為 data layer 需要實作 domain layer 的 interface。所以我們要先定義好那些東西才能回到 data layer。\n首先是 EtaRepository 的部分，裏面有兩個 function。一個是提供路綫和車站的關連，用來做揀選車站的 UI；另一個是 call API 取得某路綫的某車站的抵站時間。\ninterface EtaRepository { fun getLinesAndStations(): Map\u003cLine, Set\u003cStation\u003e\u003e suspend fun getEta(language: Language, line: Line, station: Station): EtaResult } getLinesAndStations 是普通 function 但 getEta 是 suspending function 是因為 getLinesAndStations return value 就是一個寫死的 Map，不會有耗時的工作。而 getEta 會 call API endpoint（非同步），所以就用 suspending function。\n由於我們目標是顯示班次的目的地名稱、月台編號和倒數分鐘，所以不能直接拿 response 來用，要經過處理才可以拿去 UI 那邊用。\n如果 response 的 status 是 0 的話，我們就用另一個 data class 表示目前綫路有事故。\n至於 HTTP 429、HTTP 500、其餘的例外情況我們會另外用 object 和 data class 表示，這樣就可以不用 throw exception 去調用那一邊。\n我們會把這幾款 class 都繼承同一個 sealed interface EtaResult，用來表達這個 API 所有可能輸出的結果。而交給 domain layer 調用的 method 會是一個 suspend fun 並回傳那個 sealed interface，那樣之後就算找不到 API 文檔只看 code 大概都會知道有甚麼情景。\nsealed interface EtaResult { data class Success( val schedule: List\u003cEta\u003e = emptyList(), ) : EtaResult { data class Eta( val direction: Direction = Direction.UP, val platform: String = \"\", val time: Instant = Instant.EPOCH, val destination: Station = Station.UNKNOWN, val sequence: Int = 0, ) { enum class Direction { UP, DOWN } } } object Delay : EtaResult data class Incident( val message: String = \"\", val url: String = \"\", ) : EtaResult object TooManyRequests : EtaResult object InternalServerError : EtaResult data class Error(val e: Throwable?) : EtaResult } 有部分 class 用了 object 是因為它們沒有 field 在儲東西，所以全個 app 只用同一個 instance 都沒問題。\n實作接駁 API endpoint 由於先前已經準備了 EtaResponse data class，我們可以把上一篇的 Ktor client 稍為改小許就可以完成今天要做的部分。\nclass EtaRepositoryImpl @Inject constructor( private val httpClient: HttpClient, private val etaResponseMapper: Mapper\u003cHttpResponse, EtaResult\u003e, ) : EtaRepository { override fun getLinesAndStations(): Map\u003cLine, Set\u003cStation\u003e\u003e = linkedMapOf( AEL to linkedSetOf(HOK, KOW, TSY, AIR, AWE), TCL to linkedSetOf(HOK, KOW, OLY, NAC, LAK, TSY, SUN, TUC), TML to linkedSetOf( WKS, MOS, HEO, TSH, SHM, CIO, STW, CKT, TAW, HIK, DIH, KAT, SUW, TKW, HOM, HUH, ETS, AUS, MEF, TWW, KSR, YUL, LOP, TIS, SIH, TUM, ), TKL to linkedSetOf(NOP, QUB, YAT, TIK, TKO, HAH, POA, LHP), ) override suspend fun getEta(language: Language, line: Line, station: Station) = try { val response = httpClient.get\u003cHttpResponse\u003e(\"https://rt.data.gov.hk/v1/transport/mtr/getSchedule.php\") { parameter(\"line\", line.name) parameter(\"sta\", station.name) parameter( \"lang\", when (language) { Language.CHINESE -\u003e \"TC\" Language.ENGLISH -\u003e \"EN\" } ) } // 這部分我們下一篇會做 etaResponseMapper.map(response) } catch (e: Throwable) { EtaResult.Error(e) } } getLinesAndStations 的實作沒甚麼特別，就是一個 immutable 的 Map。至於 getEta 其實就分為兩個部分：用 Ktor client call API 並取得 response 和把 API response 變成 domain layer 的 EtaResult（亦即是這個 function 的 return type）。\n第一部分我們會用到上一篇所準備的 DataModule 入面的 HttpClient，我們只需要在 EtaRepositoryImpl constructor 加上 @Inject 並在 constructor 加上 HttpClient 的 parameter 就能讓 Dagger 幫我們取得 dependency。etaResponseMapper 我們會在下一篇處理。回到 getEta 裏面，第一句那個 get 基本上跟上一篇的寫法一樣，只是這次 get 那個 generic type 用了 HttpResponse 而不是 EtaResponse。這是因為我們要取得 HTTP response 的 status code。取得 response 後就交去 mapper 轉換成 EtaResult。另外，在整句調用 Ktor client 的部分包裹着 try-catch block，為的就是把不能連接網路之類的 exception 接住，那調用 repository 的一方不用再包 try-catch block，而且用了 sealed interface 亦能保證對方知悉這個情景從而寫對應的 code 處理。\n在完成 EtaRepositoryImpl 後，我們要把 EtaRepository 和 EtaRepositoryImpl 的關連告訴給 Dagger 知道，否則 Dagger 看到有其他地方依賴 EtaRepository 時就不知道要給它甚麼實作。我們會用 @Binds 向 Dagger 指明凡是其他地方依賴 EtaRepository 我們都會給它 instantiate 一個新的 EtaRepositoryImpl。@Binds 跟 @Provides 不同的地方是 @Binds 是 @Provides 的簡化版，如果要指明依賴某個 abstract class 或 interface 時要 instantiate 那個 concrete implementation 的話，我們就可以用 @Binds 寫一個 abstract function，Dagger 就會幫我們補上那個 abstract function 的實作。注意的是如果那個 concrete implementation 的 class 的 constructor 也是需要用到其他 dependency，你的 constructor 亦都需要加上 @Inject，這樣 Dagger 才能替你自動替你做 dependency injection。但如果那個 class 是人家寫的（即是 library 提供你又不能幫它加 @Inject）的話，你就只能用 @Provides 並在 method parameter 自行補上要用到的 dependency，然後在 method body 用那些 method parameter 來 instantiate 那個 class 並將它 return 出去，就像之前準備 Ktor client 般的做法。\n@Module @InstallIn(SingletonComponent::class) interface DataModule { @BindsOptionalOf fun bindLogging(): HttpClientFeature\u003cLogging.Config, Logging\u003e // 本節新加的部分 @Binds fun bindEtaRepository(impl: EtaRepositoryImpl): EtaRepository // 之前準備 Ktor client/OkHttp 所寫的東西 companion object { // ... } } 跟 Retrofit 的比較 如果是用 OkHttp 及 Retrofit 的話，寫法會比較簡潔一點。因為那些 parameter 和 API endpoint 的 URL 都是寫在 interface function 的 Retrofit 專門 annotation。現在我們用 Ktor client 感覺上會像直接用 OkHttp 發送 HTTP request 般，但有一點不同是 Ktor client 還是有跟 JSON deserialization library 有整合，只需一句 httpClient.get 就能拿到 deserialize 後的 object。如果你的 app 要駁不同的 API，每個的 base URL 都不相同的話或許用 Ktor client 這種寫法比起 Retrofit 要寫 interface 還要方便。\n下一篇我們會實作 EtaResponseMapper。\n","wordCount":"2917","inLanguage":"zh-tw","datePublished":"2021-09-22T00:00:00+08:00","dateModified":"2021-09-22T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://eric.swiftzer.net/2021/09/2021-ithome-ironman-07-data-layer-implementation-1/"},"publisher":{"@type":"Organization","name":"EricLog","logo":{"@type":"ImageObject","url":"https://eric.swiftzer.net/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://eric.swiftzer.net/ accesskey=h title="EricLog (Alt + H)">EricLog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li></ul></div></div><ul id=menu><li><a href=https://eric.swiftzer.net/fonts/ title=Fonts><span>Fonts</span></a></li><li><a href=https://eric.swiftzer.net/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://eric.swiftzer.net/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://eric.swiftzer.net/about/ title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://eric.swiftzer.net/>首頁</a>&nbsp;»&nbsp;<a href=https://eric.swiftzer.net/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">2021 iThome 鐵人賽 Day 7：Data layer implementation (1)</h1><div class=post-meta><span title='2021-09-22 00:00:00 +0800 +0800'>September 22, 2021</span></div></header><div class=post-content><blockquote><p>本篇文章是 <a href=https://ithelp.ithome.com.tw/2021ironman>2021 iThome 鐵人賽</a>參賽題目「<a href=https://ithelp.ithome.com.tw/users/20139666/ironman/4661>寫一個列車抵站時間 Android App</a>」的第 7 篇，你可到 iThome <a href=https://ithelp.ithome.com.tw/articles/10269457>查看原文</a>。</p><p><a href=https://eric.swiftzer.net/2021-ithome-ironman/>文章目錄</a></p></blockquote><p>在上一篇，我們把 Ktor client 加到 Dagger 的 object graph 內。現在我們就繼續寫 data layer 部分。</p><h2 id=跨-layer-共用部分>跨 layer 共用部分<a hidden class=anchor aria-hidden=true href=#跨-layer-共用部分>#</a></h2><p>不過在繼續之前，我們要先準備一些通用的 enum。這些 enum 分別是用來表示路綫、車站和語言。因為這次的示範 app 所用到的車站和路綫的數量有限，我們就簡化用 enum 寫死在 app 入面就算了，但如果數量多的話或許會改用 SQLite database 之類去儲存它們。在這種情況下，我們一般都會每個 layer 都有對應的 data class 表示，而不會好像現在把 data class/enum 放在 common 的地方。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>enum</span> <span class=k>class</span> <span class=nc>Line</span><span class=p>(</span><span class=k>val</span> <span class=py>zh</span><span class=p>:</span> <span class=n>String</span><span class=p>,</span> <span class=k>val</span> <span class=py>en</span><span class=p>:</span> <span class=n>String</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>AEL</span><span class=p>(</span><span class=s2>&#34;機場快綫&#34;</span><span class=p>,</span> <span class=s2>&#34;Airport Express&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>TCL</span><span class=p>(</span><span class=s2>&#34;東涌綫&#34;</span><span class=p>,</span> <span class=s2>&#34;Tung Chung Line&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>TML</span><span class=p>(</span><span class=s2>&#34;屯馬綫&#34;</span><span class=p>,</span> <span class=s2>&#34;Tuen Ma Line&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>TKL</span><span class=p>(</span><span class=s2>&#34;將軍澳綫&#34;</span><span class=p>,</span> <span class=s2>&#34;Tseung Kwan O Line&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>enum</span> <span class=k>class</span> <span class=nc>Station</span><span class=p>(</span><span class=k>val</span> <span class=py>zh</span><span class=p>:</span> <span class=n>String</span><span class=p>,</span> <span class=k>val</span> <span class=py>en</span><span class=p>:</span> <span class=n>String</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>UNKNOWN</span><span class=p>(</span><span class=s2>&#34;&#34;</span><span class=p>,</span> <span class=s2>&#34;&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>HOK</span><span class=p>(</span><span class=s2>&#34;香港&#34;</span><span class=p>,</span> <span class=s2>&#34;Hong Kong&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>KOW</span><span class=p>(</span><span class=s2>&#34;九龍&#34;</span><span class=p>,</span> <span class=s2>&#34;Kowloon&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>OLY</span><span class=p>(</span><span class=s2>&#34;奧運&#34;</span><span class=p>,</span> <span class=s2>&#34;Olympic&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>NAC</span><span class=p>(</span><span class=s2>&#34;南昌&#34;</span><span class=p>,</span> <span class=s2>&#34;Nam Cheong&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>LAK</span><span class=p>(</span><span class=s2>&#34;茘景&#34;</span><span class=p>,</span> <span class=s2>&#34;Lai King&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>TSY</span><span class=p>(</span><span class=s2>&#34;青衣&#34;</span><span class=p>,</span> <span class=s2>&#34;Tsing Yi&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>SUN</span><span class=p>(</span><span class=s2>&#34;欣澳&#34;</span><span class=p>,</span> <span class=s2>&#34;Sunny Bay&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>TUC</span><span class=p>(</span><span class=s2>&#34;東涌&#34;</span><span class=p>,</span> <span class=s2>&#34;Tung Chung&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>AIR</span><span class=p>(</span><span class=s2>&#34;機場&#34;</span><span class=p>,</span> <span class=s2>&#34;Airport&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>AWE</span><span class=p>(</span><span class=s2>&#34;博覽館&#34;</span><span class=p>,</span> <span class=s2>&#34;AsiaWorld-Expo&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>WKS</span><span class=p>(</span><span class=s2>&#34;烏溪沙&#34;</span><span class=p>,</span> <span class=s2>&#34;Wu Kai Sha&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>MOS</span><span class=p>(</span><span class=s2>&#34;馬鞍山&#34;</span><span class=p>,</span> <span class=s2>&#34;Ma On Shan&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>HEO</span><span class=p>(</span><span class=s2>&#34;恆安&#34;</span><span class=p>,</span> <span class=s2>&#34;Heng On&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>TSH</span><span class=p>(</span><span class=s2>&#34;大水坑&#34;</span><span class=p>,</span> <span class=s2>&#34;Tai Shui Hang&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>SHM</span><span class=p>(</span><span class=s2>&#34;石門&#34;</span><span class=p>,</span> <span class=s2>&#34;Shek Mun&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>CIO</span><span class=p>(</span><span class=s2>&#34;第一城&#34;</span><span class=p>,</span> <span class=s2>&#34;City One&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>STW</span><span class=p>(</span><span class=s2>&#34;沙田圍&#34;</span><span class=p>,</span> <span class=s2>&#34;Sha Tin Wai&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>CKT</span><span class=p>(</span><span class=s2>&#34;車公廟&#34;</span><span class=p>,</span> <span class=s2>&#34;Che Kung Temple&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>TAW</span><span class=p>(</span><span class=s2>&#34;大圍&#34;</span><span class=p>,</span> <span class=s2>&#34;Tai Wai&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>HIK</span><span class=p>(</span><span class=s2>&#34;顯徑&#34;</span><span class=p>,</span> <span class=s2>&#34;Hin Keng&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>DIH</span><span class=p>(</span><span class=s2>&#34;鑽石山&#34;</span><span class=p>,</span> <span class=s2>&#34;Diamond Hill&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>KAT</span><span class=p>(</span><span class=s2>&#34;啟德&#34;</span><span class=p>,</span> <span class=s2>&#34;Kai Tak&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>SUW</span><span class=p>(</span><span class=s2>&#34;宋皇臺&#34;</span><span class=p>,</span> <span class=s2>&#34;Sung Wong Toi&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>TKW</span><span class=p>(</span><span class=s2>&#34;土瓜灣&#34;</span><span class=p>,</span> <span class=s2>&#34;To Kwa Wan&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>HOM</span><span class=p>(</span><span class=s2>&#34;何文田&#34;</span><span class=p>,</span> <span class=s2>&#34;Ho Man Tin&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>HUH</span><span class=p>(</span><span class=s2>&#34;紅磡&#34;</span><span class=p>,</span> <span class=s2>&#34;Hung Hom&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>ETS</span><span class=p>(</span><span class=s2>&#34;尖東&#34;</span><span class=p>,</span> <span class=s2>&#34;East Tsim Sha Tsui&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>AUS</span><span class=p>(</span><span class=s2>&#34;柯士甸&#34;</span><span class=p>,</span> <span class=s2>&#34;Austin&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>MEF</span><span class=p>(</span><span class=s2>&#34;美孚&#34;</span><span class=p>,</span> <span class=s2>&#34;Mei Foo&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>TWW</span><span class=p>(</span><span class=s2>&#34;荃灣西&#34;</span><span class=p>,</span> <span class=s2>&#34;Tsuen Wan West&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>KSR</span><span class=p>(</span><span class=s2>&#34;錦上路&#34;</span><span class=p>,</span> <span class=s2>&#34;Kam Sheung Road&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>YUL</span><span class=p>(</span><span class=s2>&#34;元朗&#34;</span><span class=p>,</span> <span class=s2>&#34;Yuen Long&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>LOP</span><span class=p>(</span><span class=s2>&#34;朗屏&#34;</span><span class=p>,</span> <span class=s2>&#34;Long Ping&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>TIS</span><span class=p>(</span><span class=s2>&#34;天水圍&#34;</span><span class=p>,</span> <span class=s2>&#34;Tin Shui Wai&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>SIH</span><span class=p>(</span><span class=s2>&#34;兆康&#34;</span><span class=p>,</span> <span class=s2>&#34;Siu Hong&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>TUM</span><span class=p>(</span><span class=s2>&#34;屯門&#34;</span><span class=p>,</span> <span class=s2>&#34;Tuen Mun&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>NOP</span><span class=p>(</span><span class=s2>&#34;北角&#34;</span><span class=p>,</span> <span class=s2>&#34;North Point&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>QUB</span><span class=p>(</span><span class=s2>&#34;鰂魚涌&#34;</span><span class=p>,</span> <span class=s2>&#34;Quarry Bay&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>YAT</span><span class=p>(</span><span class=s2>&#34;油塘&#34;</span><span class=p>,</span> <span class=s2>&#34;Yau Tong&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>TIK</span><span class=p>(</span><span class=s2>&#34;調景嶺&#34;</span><span class=p>,</span> <span class=s2>&#34;Tiu Keng Leng&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>TKO</span><span class=p>(</span><span class=s2>&#34;將軍澳&#34;</span><span class=p>,</span> <span class=s2>&#34;Tseung Kwan O&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>HAH</span><span class=p>(</span><span class=s2>&#34;坑口&#34;</span><span class=p>,</span> <span class=s2>&#34;Hang Hau&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>POA</span><span class=p>(</span><span class=s2>&#34;寶琳&#34;</span><span class=p>,</span> <span class=s2>&#34;Po Lam&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>LHP</span><span class=p>(</span><span class=s2>&#34;康城&#34;</span><span class=p>,</span> <span class=s2>&#34;LOHAS Park&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>enum</span> <span class=k>class</span> <span class=nc>Language</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>CHINESE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>ENGLISH</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=domain-layer-準備工作>Domain layer 準備工作<a hidden class=anchor aria-hidden=true href=#domain-layer-準備工作>#</a></h2><p>雖然本篇題目是 data layer，但因為 data layer 需要實作 domain layer 的 interface。所以我們要先定義好那些東西才能回到 data layer。</p><p>首先是 <code>EtaRepository</code> 的部分，裏面有兩個 function。一個是提供路綫和車站的關連，用來做揀選車站的 UI；另一個是 call API 取得某路綫的某車站的抵站時間。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>interface</span> <span class=nc>EtaRepository</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>getLinesAndStations</span><span class=p>():</span> <span class=n>Map</span><span class=p>&lt;</span><span class=n>Line</span><span class=p>,</span> <span class=n>Set</span><span class=p>&lt;</span><span class=n>Station</span><span class=p>&gt;&gt;</span>
</span></span><span class=line><span class=cl>    <span class=k>suspend</span> <span class=k>fun</span> <span class=nf>getEta</span><span class=p>(</span><span class=n>language</span><span class=p>:</span> <span class=n>Language</span><span class=p>,</span> <span class=n>line</span><span class=p>:</span> <span class=n>Line</span><span class=p>,</span> <span class=n>station</span><span class=p>:</span> <span class=n>Station</span><span class=p>):</span> <span class=n>EtaResult</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><code>getLinesAndStations</code> 是普通 function 但 <code>getEta</code> 是 suspending function 是因為 <code>getLinesAndStations</code> return value 就是一個寫死的 <code>Map</code>，不會有耗時的工作。而 <code>getEta</code> 會 call API endpoint（非同步），所以就用 suspending function。</p><p>由於我們目標是顯示班次的目的地名稱、月台編號和倒數分鐘，所以不能直接拿 response 來用，要經過處理才可以拿去 UI 那邊用。</p><p>如果 response 的 <code>status</code> 是 <code>0</code> 的話，我們就用另一個 data class 表示目前綫路有事故。</p><p>至於 HTTP 429、HTTP 500、其餘的例外情況我們會另外用 object 和 data class 表示，這樣就可以不用 throw exception 去調用那一邊。</p><p>我們會把這幾款 class 都繼承同一個 sealed interface <code>EtaResult</code>，用來表達這個 API 所有可能輸出的結果。而交給 domain layer 調用的 method 會是一個 suspend fun 並回傳那個 sealed interface，那樣之後就算找不到 API 文檔只看 code 大概都會知道有甚麼情景。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>sealed</span> <span class=k>interface</span> <span class=nc>EtaResult</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>data</span> <span class=k>class</span> <span class=nc>Success</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=py>schedule</span><span class=p>:</span> <span class=n>List</span><span class=p>&lt;</span><span class=n>Eta</span><span class=p>&gt;</span> <span class=p>=</span> <span class=n>emptyList</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=p>:</span> <span class=n>EtaResult</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>data</span> <span class=k>class</span> <span class=nc>Eta</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=k>val</span> <span class=py>direction</span><span class=p>:</span> <span class=n>Direction</span> <span class=p>=</span> <span class=nc>Direction</span><span class=p>.</span><span class=n>UP</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=k>val</span> <span class=py>platform</span><span class=p>:</span> <span class=n>String</span> <span class=p>=</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=k>val</span> <span class=py>time</span><span class=p>:</span> <span class=n>Instant</span> <span class=p>=</span> <span class=nc>Instant</span><span class=p>.</span><span class=n>EPOCH</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=k>val</span> <span class=py>destination</span><span class=p>:</span> <span class=n>Station</span> <span class=p>=</span> <span class=nc>Station</span><span class=p>.</span><span class=n>UNKNOWN</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=k>val</span> <span class=py>sequence</span><span class=p>:</span> <span class=n>Int</span> <span class=p>=</span> <span class=m>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>enum</span> <span class=k>class</span> <span class=nc>Direction</span> <span class=p>{</span> <span class=n>UP</span><span class=p>,</span> <span class=n>DOWN</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>object</span> <span class=nc>Delay</span> <span class=p>:</span> <span class=n>EtaResult</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>data</span> <span class=k>class</span> <span class=nc>Incident</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=py>message</span><span class=p>:</span> <span class=n>String</span> <span class=p>=</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=py>url</span><span class=p>:</span> <span class=n>String</span> <span class=p>=</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=p>:</span> <span class=n>EtaResult</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>object</span> <span class=nc>TooManyRequests</span> <span class=p>:</span> <span class=n>EtaResult</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>object</span> <span class=nc>InternalServerError</span> <span class=p>:</span> <span class=n>EtaResult</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>data</span> <span class=k>class</span> <span class=nc>Error</span><span class=p>(</span><span class=k>val</span> <span class=py>e</span><span class=p>:</span> <span class=n>Throwable</span><span class=p>?)</span> <span class=p>:</span> <span class=n>EtaResult</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>有部分 class 用了 <code>object</code> 是因為它們沒有 field 在儲東西，所以全個 app 只用同一個 instance 都沒問題。</p><h2 id=實作接駁-api-endpoint>實作接駁 API endpoint<a hidden class=anchor aria-hidden=true href=#實作接駁-api-endpoint>#</a></h2><p>由於先前已經準備了 <code>EtaResponse</code> data class，我們可以把上一篇的 Ktor client 稍為改小許就可以完成今天要做的部分。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>class</span> <span class=nc>EtaRepositoryImpl</span> <span class=nd>@Inject</span> <span class=k>constructor</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>val</span> <span class=py>httpClient</span><span class=p>:</span> <span class=n>HttpClient</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>val</span> <span class=py>etaResponseMapper</span><span class=p>:</span> <span class=n>Mapper</span><span class=p>&lt;</span><span class=n>HttpResponse</span><span class=p>,</span> <span class=n>EtaResult</span><span class=p>&gt;,</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>:</span> <span class=n>EtaRepository</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>getLinesAndStations</span><span class=p>():</span> <span class=n>Map</span><span class=p>&lt;</span><span class=n>Line</span><span class=p>,</span> <span class=n>Set</span><span class=p>&lt;</span><span class=n>Station</span><span class=p>&gt;&gt;</span> <span class=p>=</span> <span class=n>linkedMapOf</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>AEL</span> <span class=n>to</span> <span class=n>linkedSetOf</span><span class=p>(</span><span class=n>HOK</span><span class=p>,</span> <span class=n>KOW</span><span class=p>,</span> <span class=n>TSY</span><span class=p>,</span> <span class=n>AIR</span><span class=p>,</span> <span class=n>AWE</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>TCL</span> <span class=n>to</span> <span class=n>linkedSetOf</span><span class=p>(</span><span class=n>HOK</span><span class=p>,</span> <span class=n>KOW</span><span class=p>,</span> <span class=n>OLY</span><span class=p>,</span> <span class=n>NAC</span><span class=p>,</span> <span class=n>LAK</span><span class=p>,</span> <span class=n>TSY</span><span class=p>,</span> <span class=n>SUN</span><span class=p>,</span> <span class=n>TUC</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>TML</span> <span class=n>to</span> <span class=n>linkedSetOf</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>WKS</span><span class=p>,</span> <span class=n>MOS</span><span class=p>,</span> <span class=n>HEO</span><span class=p>,</span> <span class=n>TSH</span><span class=p>,</span> <span class=n>SHM</span><span class=p>,</span> <span class=n>CIO</span><span class=p>,</span> <span class=n>STW</span><span class=p>,</span> <span class=n>CKT</span><span class=p>,</span> <span class=n>TAW</span><span class=p>,</span> <span class=n>HIK</span><span class=p>,</span> <span class=n>DIH</span><span class=p>,</span> <span class=n>KAT</span><span class=p>,</span> <span class=n>SUW</span><span class=p>,</span> <span class=n>TKW</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>HOM</span><span class=p>,</span> <span class=n>HUH</span><span class=p>,</span> <span class=n>ETS</span><span class=p>,</span> <span class=n>AUS</span><span class=p>,</span> <span class=n>MEF</span><span class=p>,</span> <span class=n>TWW</span><span class=p>,</span> <span class=n>KSR</span><span class=p>,</span> <span class=n>YUL</span><span class=p>,</span> <span class=n>LOP</span><span class=p>,</span> <span class=n>TIS</span><span class=p>,</span> <span class=n>SIH</span><span class=p>,</span> <span class=n>TUM</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>TKL</span> <span class=n>to</span> <span class=n>linkedSetOf</span><span class=p>(</span><span class=n>NOP</span><span class=p>,</span> <span class=n>QUB</span><span class=p>,</span> <span class=n>YAT</span><span class=p>,</span> <span class=n>TIK</span><span class=p>,</span> <span class=n>TKO</span><span class=p>,</span> <span class=n>HAH</span><span class=p>,</span> <span class=n>POA</span><span class=p>,</span> <span class=n>LHP</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>suspend</span> <span class=k>fun</span> <span class=nf>getEta</span><span class=p>(</span><span class=n>language</span><span class=p>:</span> <span class=n>Language</span><span class=p>,</span> <span class=n>line</span><span class=p>:</span> <span class=n>Line</span><span class=p>,</span> <span class=n>station</span><span class=p>:</span> <span class=n>Station</span><span class=p>)</span> <span class=p>=</span> <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=py>response</span> <span class=p>=</span>
</span></span><span class=line><span class=cl>            <span class=n>httpClient</span><span class=p>.</span><span class=k>get</span><span class=p>&lt;</span><span class=n>HttpResponse</span><span class=p>&gt;(</span><span class=s2>&#34;https://rt.data.gov.hk/v1/transport/mtr/getSchedule.php&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>parameter</span><span class=p>(</span><span class=s2>&#34;line&#34;</span><span class=p>,</span> <span class=n>line</span><span class=p>.</span><span class=n>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>parameter</span><span class=p>(</span><span class=s2>&#34;sta&#34;</span><span class=p>,</span> <span class=n>station</span><span class=p>.</span><span class=n>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>parameter</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;lang&#34;</span><span class=p>,</span> <span class=k>when</span> <span class=p>(</span><span class=n>language</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=nc>Language</span><span class=p>.</span><span class=n>CHINESE</span> <span class=o>-&gt;</span> <span class=s2>&#34;TC&#34;</span>
</span></span><span class=line><span class=cl>                        <span class=nc>Language</span><span class=p>.</span><span class=n>ENGLISH</span> <span class=o>-&gt;</span> <span class=s2>&#34;EN&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 這部分我們下一篇會做
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>etaResponseMapper</span><span class=p>.</span><span class=n>map</span><span class=p>(</span><span class=n>response</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>e</span><span class=p>:</span> <span class=n>Throwable</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nc>EtaResult</span><span class=p>.</span><span class=n>Error</span><span class=p>(</span><span class=n>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><code>getLinesAndStations</code> 的實作沒甚麼特別，就是一個 immutable 的 <code>Map</code>。至於 <code>getEta</code> 其實就分為兩個部分：用 Ktor client call API 並取得 response 和把 API response 變成 domain layer 的 <code>EtaResult</code>（亦即是這個 function 的 return type）。</p><p>第一部分我們會用到上一篇所準備的 <code>DataModule</code> 入面的 <code>HttpClient</code>，我們只需要在 <code>EtaRepositoryImpl</code> constructor 加上 <code>@Inject</code> 並在 constructor 加上 <code>HttpClient</code> 的 parameter 就能讓 Dagger 幫我們取得 dependency。<code>etaResponseMapper</code> 我們會在下一篇處理。回到 <code>getEta</code> 裏面，第一句那個 <code>get</code> 基本上跟上一篇的寫法一樣，只是這次 <code>get</code> 那個 generic type 用了 <code>HttpResponse</code> 而不是 <code>EtaResponse</code>。這是因為我們要取得 HTTP response 的 status code。取得 response 後就交去 mapper 轉換成 <code>EtaResult</code>。另外，在整句調用 Ktor client 的部分包裹着 try-catch block，為的就是把不能連接網路之類的 exception 接住，那調用 repository 的一方不用再包 try-catch block，而且用了 sealed interface 亦能保證對方知悉這個情景從而寫對應的 code 處理。</p><p>在完成 <code>EtaRepositoryImpl</code> 後，我們要把 <code>EtaRepository</code> 和 <code>EtaRepositoryImpl</code> 的關連告訴給 Dagger 知道，否則 Dagger 看到有其他地方依賴 <code>EtaRepository</code> 時就不知道要給它甚麼實作。我們會用 <code>@Binds</code> 向 Dagger 指明凡是其他地方依賴 <code>EtaRepository</code> 我們都會給它 instantiate 一個新的 <code>EtaRepositoryImpl</code>。<code>@Binds</code> 跟 <code>@Provides</code> 不同的地方是 <code>@Binds</code> 是 <code>@Provides</code> 的簡化版，如果要指明依賴某個 abstract class 或 interface 時要 instantiate 那個 concrete implementation 的話，我們就可以用 <code>@Binds</code> 寫一個 abstract function，Dagger 就會幫我們補上那個 abstract function 的實作。注意的是如果那個 concrete implementation 的 class 的 constructor 也是需要用到其他 dependency，你的 constructor 亦都需要加上 <code>@Inject</code>，這樣 Dagger 才能替你自動替你做 dependency injection。但如果那個 class 是人家寫的（即是 library 提供你又不能幫它加 <code>@Inject</code>）的話，你就只能用 <code>@Provides</code> 並在 method parameter 自行補上要用到的 dependency，然後在 method body 用那些 method parameter 來 instantiate 那個 class 並將它 return 出去，就像之前準備 Ktor client 般的做法。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=nd>@Module</span>
</span></span><span class=line><span class=cl><span class=nd>@InstallIn</span><span class=p>(</span><span class=n>SingletonComponent</span><span class=o>::</span><span class=k>class</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>interface</span> <span class=nc>DataModule</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@BindsOptionalOf</span>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>bindLogging</span><span class=p>():</span> <span class=n>HttpClientFeature</span><span class=p>&lt;</span><span class=nc>Logging</span><span class=p>.</span><span class=n>Config</span><span class=p>,</span> <span class=n>Logging</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 本節新加的部分
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nd>@Binds</span>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>bindEtaRepository</span><span class=p>(</span><span class=n>impl</span><span class=p>:</span> <span class=n>EtaRepositoryImpl</span><span class=p>):</span> <span class=n>EtaRepository</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 之前準備 Ktor client/OkHttp 所寫的東西
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>companion</span> <span class=k>object</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=跟-retrofit-的比較>跟 Retrofit 的比較<a hidden class=anchor aria-hidden=true href=#跟-retrofit-的比較>#</a></h2><p>如果是用 OkHttp 及 Retrofit 的話，寫法會比較簡潔一點。因為那些 parameter 和 API endpoint 的 URL 都是寫在 interface function 的 Retrofit 專門 annotation。現在我們用 Ktor client 感覺上會像直接用 OkHttp 發送 HTTP request 般，但有一點不同是 Ktor client 還是有跟 JSON deserialization library 有整合，只需一句 <code>httpClient.get&lt;EtaResponse></code> 就能拿到 deserialize 後的 object。如果你的 app 要駁不同的 API，每個的 base URL 都不相同的話或許用 Ktor client 這種寫法比起 Retrofit 要寫 interface 還要方便。</p><p>下一篇我們會實作 <code>EtaResponseMapper</code>。</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://eric.swiftzer.net/tags/2021-ithome-%E9%90%B5%E4%BA%BA%E8%B3%BD/>2021 IThome 鐵人賽</a></li><li><a href=https://eric.swiftzer.net/tags/android/>Android</a></li></ul><nav class=paginav><a class=prev href=https://eric.swiftzer.net/2021/09/2021-ithome-ironman-08-data-layer-implementation-2/><span class=title>« 上一頁</span><br><span>2021 iThome 鐵人賽 Day 8：Data layer implementation (2)</span>
</a><a class=next href=https://eric.swiftzer.net/2021/09/2021-ithome-ironman-06-http-client/><span class=title>下一頁 »</span><br><span>2021 iThome 鐵人賽 Day 6：HTTP Client</span></a></nav></footer><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//efilm.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></article></main><footer class=footer><span>&copy; 2024 <a href=https://eric.swiftzer.net/>EricLog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>