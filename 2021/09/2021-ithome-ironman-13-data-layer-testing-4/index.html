<!doctype html><html lang=zh-tw dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>2021 iThome 鐵人賽 Day 13：Data layer testing (4) | EricLog</title><meta name=keywords content="2021 iThome 鐵人賽,Android"><meta name=description content="本篇文章是 2021 iThome 鐵人賽參賽題目「寫一個列車抵站時間 Android App」的第 13 篇，你可到 iThome 查看原文。 文章目錄 上一篇示範了 Ktor mock engine 的設定和測試了如果出現 exception 時能"><meta name=author content><link rel=canonical href=https://ithelp.ithome.com.tw/articles/10273796><link crossorigin=anonymous href=/assets/css/stylesheet.48ed1b8bd3873bc86534e1a6b0ba618b6c80d8a975cf0cf1f1835c2b89c5c5b0.css integrity="sha256-SO0bi9OHO8hlNOGmsLphi2yA2Kl1zwzx8YNcK4nFxbA=" rel="preload stylesheet" as=style><link rel=icon href=https://eric.swiftzer.net/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://eric.swiftzer.net/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://eric.swiftzer.net/favicon-32x32.png><link rel=apple-touch-icon href=https://eric.swiftzer.net/apple-touch-icon.png><link rel=mask-icon href=https://eric.swiftzer.net/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=JetBrains+Mono:wght@300&display=swap" rel=stylesheet><script async src="https://www.googletagmanager.com/gtag/js?id=G-D93F946T73"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-D93F946T73",{anonymize_ip:!1})}</script><meta property="og:title" content="2021 iThome 鐵人賽 Day 13：Data layer testing (4)"><meta property="og:description" content="本篇文章是 2021 iThome 鐵人賽參賽題目「寫一個列車抵站時間 Android App」的第 13 篇，你可到 iThome 查看原文。 文章目錄 上一篇示範了 Ktor mock engine 的設定和測試了如果出現 exception 時能"><meta property="og:type" content="article"><meta property="og:url" content="https://eric.swiftzer.net/2021/09/2021-ithome-ironman-13-data-layer-testing-4/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-09-28T00:00:00+08:00"><meta property="article:modified_time" content="2021-09-28T00:00:00+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="2021 iThome 鐵人賽 Day 13：Data layer testing (4)"><meta name=twitter:description content="本篇文章是 2021 iThome 鐵人賽參賽題目「寫一個列車抵站時間 Android App」的第 13 篇，你可到 iThome 查看原文。 文章目錄 上一篇示範了 Ktor mock engine 的設定和測試了如果出現 exception 時能"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://eric.swiftzer.net/posts/"},{"@type":"ListItem","position":2,"name":"2021 iThome 鐵人賽 Day 13：Data layer testing (4)","item":"https://eric.swiftzer.net/2021/09/2021-ithome-ironman-13-data-layer-testing-4/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"2021 iThome 鐵人賽 Day 13：Data layer testing (4)","name":"2021 iThome 鐵人賽 Day 13：Data layer testing (4)","description":"本篇文章是 2021 iThome 鐵人賽參賽題目「寫一個列車抵站時間 Android App」的第 13 篇，你可到 iThome 查看原文。 文章目錄 上一篇示範了 Ktor mock engine 的設定和測試了如果出現 exception 時能","keywords":["2021 iThome 鐵人賽","Android"],"articleBody":" 本篇文章是 2021 iThome 鐵人賽參賽題目「寫一個列車抵站時間 Android App」的第 13 篇，你可到 iThome 查看原文。\n文章目錄\n上一篇示範了 Ktor mock engine 的設定和測試了如果出現 exception 時能否順利地處理。現在就測試 getEta 輸出班次的情景。\nTest case 的目標是：\n檢查交去 Ktor client 的 request parameter（即是語言、路綫、車站）是否正確 看看加在 Ktor client 的 Kotlinx serialization 能否正常地把我們提供的 response JSON 轉成 EtaResponse 由於我們已針對 EtaResponseMapper 寫了 unit test，我們就乾脆 mock 那個 mapper 然後隨便 return 一個 EtaResult.Success 就算了。當然你亦可以 instantiate 一個真的 mapper 來做轉換，因為本身有 mapper 的 unit test，所以即使 repository test 有錯都可以容易剔除 mapper 有錯這個因素。\n同樣地，我們都是用之前寫的 mockHttpClient 來假裝 server response。首先我們會檢查 HTTP request 的 query parameter 是否正確。\n@Test fun `getEta normal`() { runBlocking { val (client, requestSlot) = mockHttpClient( HttpStatusCode.OK, \"api/schedule_tkl_tko_normal.json\" ) val repository = EtaRepositoryImpl(client, etaResponseMapper) val responseSlot = slot\u003cHttpResponse\u003e() coEvery { etaResponseMapper.map(capture(responseSlot)) } returns EtaResult.Success() val result = repository.getEta(Language.ENGLISH, Line.TKL, Station.TKO) expectThat(requestSlot).assert(\"EN\", \"TKL\", \"TKO\") // 檢查 deserialize 後的 EtaResponse 會在稍後提供 expectThat(result).isA\u003cEtaResult.Success\u003e() } } 那句 expectThat(requestSlot).assert(\"EN\", \"TKL\", \"TKO\") 就是檢查 query parameter。但那個 assert(\"EN\", \"TKL\", \"TKO\") 是甚麼來的？我在 Strikt 找不到呢。其實這是我另外寫的 function。\n之前我們示範了用 Strikt 寫巢狀的 assertion（就是一層層 object 走入去檢查），雖然在 fail 時能得到清晰的錯誤訊息，但如果每個 test case 都這樣寫就變得很長。Strikt 其實是可以寫自定義的 assertion。本身 assertion function 就是 Assertion.Builder 的 extension function，只要我們學它寫 extension function 就能做到類似 Strikt 提供的 assertion function。那個 assert(\"EN\", \"TKL\", \"TKO\") 其實是這樣寫的：\n@JvmName(\"assert_CapturingSlot_HttpRequestData\") private fun Assertion.Builder\u003cCapturingSlot\u003cHttpRequestData\u003e\u003e.assert( lang: String, line: String, sta: String, ): Assertion.Builder\u003cCapturingSlot\u003cHttpRequestData\u003e\u003e = withCaptured { get { url.parameters }.and { get(Parameters::names).containsExactlyInAnyOrder(\"lang\", \"line\", \"sta\") get { get(\"lang\") }.isEqualTo(lang) get { get(\"line\") }.isEqualTo(line) get { get(\"sta\") }.isEqualTo(sta) } } 這段 code 的大意是檢查 HttpRequestData.url.parameters 的 names 是不是有齊 lang、line、 sta。而它們三個 parameter 的值分別是參數指明的值。它的寫法基本上和在 test case 直接寫那些 assertion 一樣，只是把它們抽出來放在一個 function 裏面，那下次在其他 test case 寫同樣的 assertion 就不用寫那麼長。\n而 function 的 @JvmName(\"assert_CapturingSlot_HttpRequestData\") 是用來告訴 compiler 要把這個 function 在 JVM bytecode 更名為 assert_CapturingSlot_HttpRequestData。原因是我們之後會再有其他的 assert function，但 Assertion.Builder 的 generic type 不同。因為 Java 有 type erasure 的特性，compile 出來的 JVM bytecode return type 只會是 Assertion.Builder 而不是 Assertion.Builder","wordCount":"1625","inLanguage":"zh-tw","datePublished":"2021-09-28T00:00:00+08:00","dateModified":"2021-09-28T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://eric.swiftzer.net/2021/09/2021-ithome-ironman-13-data-layer-testing-4/"},"publisher":{"@type":"Organization","name":"EricLog","logo":{"@type":"ImageObject","url":"https://eric.swiftzer.net/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://eric.swiftzer.net/ accesskey=h title="EricLog (Alt + H)">EricLog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://eric.swiftzer.net/fonts/ title=Fonts><span>Fonts</span></a></li><li><a href=https://eric.swiftzer.net/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://eric.swiftzer.net/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://eric.swiftzer.net/about/ title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://eric.swiftzer.net/>首頁</a>&nbsp;»&nbsp;<a href=https://eric.swiftzer.net/posts/>Posts</a></div><h1 class=post-title>2021 iThome 鐵人賽 Day 13：Data layer testing (4)</h1><div class=post-meta><span title='2021-09-28 00:00:00 +0800 +0800'>September 28, 2021</span></div></header><div class=post-content><blockquote><p>本篇文章是 <a href=https://ithelp.ithome.com.tw/2021ironman>2021 iThome 鐵人賽</a>參賽題目「<a href=https://ithelp.ithome.com.tw/users/20139666/ironman/4661>寫一個列車抵站時間 Android App</a>」的第 13 篇，你可到 iThome <a href=https://ithelp.ithome.com.tw/articles/10273796>查看原文</a>。</p><p><a href=https://eric.swiftzer.net/2021-ithome-ironman/>文章目錄</a></p></blockquote><p>上一篇示範了 Ktor mock engine 的設定和測試了如果出現 exception 時能否順利地處理。現在就測試 <code>getEta</code> 輸出班次的情景。</p><p>Test case 的目標是：</p><ol><li>檢查交去 Ktor client 的 request parameter（即是語言、路綫、車站）是否正確</li><li>看看加在 Ktor client 的 Kotlinx serialization 能否正常地把我們提供的 response JSON 轉成 <code>EtaResponse</code></li></ol><p>由於我們已針對 <code>EtaResponseMapper</code> 寫了 unit test，我們就乾脆 mock 那個 mapper 然後隨便 return 一個 <code>EtaResult.Success</code> 就算了。當然你亦可以 instantiate 一個真的 mapper 來做轉換，因為本身有 mapper 的 unit test，所以即使 repository test 有錯都可以容易剔除 mapper 有錯這個因素。</p><p>同樣地，我們都是用之前寫的 <code>mockHttpClient</code> 來假裝 server response。首先我們會檢查 HTTP request 的 query parameter 是否正確。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=nd>@Test</span>
</span></span><span class=line><span class=cl><span class=k>fun</span> <span class=nf>`getEta normal`</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>runBlocking</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=err>(</span><span class=py>client</span><span class=p>,</span> <span class=n>requestSlot</span><span class=p>)</span> <span class=p>=</span> <span class=n>mockHttpClient</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>HttpStatusCode</span><span class=p>.</span><span class=n>OK</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;api/schedule_tkl_tko_normal.json&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=py>repository</span> <span class=p>=</span> <span class=n>EtaRepositoryImpl</span><span class=p>(</span><span class=n>client</span><span class=p>,</span> <span class=n>etaResponseMapper</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=py>responseSlot</span> <span class=p>=</span> <span class=n>slot</span><span class=p>&lt;</span><span class=n>HttpResponse</span><span class=p>&gt;()</span>
</span></span><span class=line><span class=cl>        <span class=n>coEvery</span> <span class=p>{</span> <span class=n>etaResponseMapper</span><span class=p>.</span><span class=n>map</span><span class=p>(</span><span class=n>capture</span><span class=p>(</span><span class=n>responseSlot</span><span class=p>))</span> <span class=p>}</span> <span class=n>returns</span> <span class=n>EtaResult</span><span class=p>.</span><span class=n>Success</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=py>result</span> <span class=p>=</span> <span class=n>repository</span><span class=p>.</span><span class=n>getEta</span><span class=p>(</span><span class=n>Language</span><span class=p>.</span><span class=n>ENGLISH</span><span class=p>,</span> <span class=n>Line</span><span class=p>.</span><span class=n>TKL</span><span class=p>,</span> <span class=n>Station</span><span class=p>.</span><span class=n>TKO</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>expectThat</span><span class=p>(</span><span class=n>requestSlot</span><span class=p>).</span><span class=n>assert</span><span class=p>(</span><span class=s2>&#34;EN&#34;</span><span class=p>,</span> <span class=s2>&#34;TKL&#34;</span><span class=p>,</span> <span class=s2>&#34;TKO&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// 檢查 deserialize 後的 EtaResponse 會在稍後提供
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>        <span class=n>expectThat</span><span class=p>(</span><span class=n>result</span><span class=p>).</span><span class=n>isA</span><span class=p>&lt;</span><span class=n>EtaResult</span><span class=p>.</span><span class=n>Success</span><span class=p>&gt;()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>那句 <code>expectThat(requestSlot).assert("EN", "TKL", "TKO")</code> 就是檢查 query parameter。但那個 <code>assert("EN", "TKL", "TKO")</code> 是甚麼來的？我在 Strikt 找不到呢。其實這是我另外寫的 function。</p><p>之前我們示範了用 Strikt 寫巢狀的 assertion（就是一層層 object 走入去檢查），雖然在 fail 時能得到清晰的錯誤訊息，但如果每個 test case 都這樣寫就變得很長。Strikt 其實是可以寫<a href=https://strikt.io/wiki/custom-assertions/>自定義的 assertion</a>。本身 assertion function 就是 <code>Assertion.Builder&lt;T></code> 的 <a href=https://kotlinlang.org/docs/extensions.html>extension function</a>，只要我們學它寫 extension function 就能做到類似 Strikt 提供的 assertion function。那個 <code>assert("EN", "TKL", "TKO")</code> 其實是這樣寫的：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=nd>@JvmName</span><span class=p>(</span><span class=s2>&#34;assert_CapturingSlot_HttpRequestData&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>private</span> <span class=k>fun</span> <span class=nf>Assertion</span><span class=p>.</span><span class=n>Builder</span><span class=p>&lt;</span><span class=n>CapturingSlot</span><span class=p>&lt;</span><span class=n>HttpRequestData</span><span class=p>&gt;&gt;.</span><span class=n>assert</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>lang</span><span class=p>:</span> <span class=n>String</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>line</span><span class=p>:</span> <span class=n>String</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>sta</span><span class=p>:</span> <span class=n>String</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>):</span> <span class=n>Assertion</span><span class=p>.</span><span class=n>Builder</span><span class=p>&lt;</span><span class=n>CapturingSlot</span><span class=p>&lt;</span><span class=n>HttpRequestData</span><span class=p>&gt;&gt;</span> <span class=p>=</span> <span class=n>withCaptured</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>get</span> <span class=p>{</span> <span class=n>url</span><span class=p>.</span><span class=n>parameters</span> <span class=p>}.</span><span class=n>and</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>get</span><span class=p>(</span><span class=n>Parameters</span><span class=o>::</span><span class=n>names</span><span class=p>).</span><span class=n>containsExactlyInAnyOrder</span><span class=p>(</span><span class=s2>&#34;lang&#34;</span><span class=p>,</span> <span class=s2>&#34;line&#34;</span><span class=p>,</span> <span class=s2>&#34;sta&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>get</span> <span class=p>{</span> <span class=k>get</span><span class=p>(</span><span class=s2>&#34;lang&#34;</span><span class=p>)</span> <span class=p>}.</span><span class=n>isEqualTo</span><span class=p>(</span><span class=n>lang</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>get</span> <span class=p>{</span> <span class=k>get</span><span class=p>(</span><span class=s2>&#34;line&#34;</span><span class=p>)</span> <span class=p>}.</span><span class=n>isEqualTo</span><span class=p>(</span><span class=n>line</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>get</span> <span class=p>{</span> <span class=k>get</span><span class=p>(</span><span class=s2>&#34;sta&#34;</span><span class=p>)</span> <span class=p>}.</span><span class=n>isEqualTo</span><span class=p>(</span><span class=n>sta</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>這段 code 的大意是檢查 <code>HttpRequestData.url.parameters</code> 的 <code>names</code> 是不是有齊 <code>lang</code>、<code>line</code>、 <code>sta</code>。而它們三個 parameter 的值分別是參數指明的值。它的寫法基本上和在 test case 直接寫那些 assertion 一樣，只是把它們抽出來放在一個 function 裏面，那下次在其他 test case 寫同樣的 assertion 就不用寫那麼長。</p><p>而 function 的 <code>@JvmName("assert_CapturingSlot_HttpRequestData")</code> 是用來告訴 compiler 要把這個 function 在 JVM bytecode 更名為 <code>assert_CapturingSlot_HttpRequestData</code>。原因是我們之後會再有其他的 <code>assert</code> function，但 <code>Assertion.Builder</code> 的 generic type 不同。因為 Java 有 type erasure 的特性，compile 出來的 JVM bytecode return type 只會是 <code>Assertion.Builder</code> 而不是 <code>Assertion.Builder&lt;CapturingSlot&lt;HttpRequestData>></code>。所以再寫多幾個 <code>assert</code> function 就很容易撞名（跟其他 method signature 相同）。所以 Kotlin 有 <code>@JvmName</code> annotation 讓你改變 function 名來避免撞名問題。其實 type erasure 是因為令在 generic 功能出現前所 compile 出來的 bytecode 向後相容，因為 generic 不是 Java「自古以來」就有的功能，所以 generic type 只會在 compile 時檢查一下，但 bytecode 是不會記錄那個 generic type。</p><p>然後我們就可以用同樣方法做 <code>EtaResponse</code> 的 custom assertion function。我們先寫班次那個 assertion function（即是 <code>EtaResponse.Eta</code>）：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=nd>@JvmName</span><span class=p>(</span><span class=s2>&#34;assert_EtaResponse_Eta&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>private</span> <span class=k>fun</span> <span class=nf>Assertion</span><span class=p>.</span><span class=n>Builder</span><span class=p>&lt;</span><span class=n>EtaResponse</span><span class=p>.</span><span class=n>Eta</span><span class=p>&gt;.</span><span class=n>assert</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>plat</span><span class=p>:</span> <span class=n>String</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>time</span><span class=p>:</span> <span class=n>String</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>dest</span><span class=p>:</span> <span class=n>String</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>seq</span><span class=p>:</span> <span class=n>String</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>):</span> <span class=n>Assertion</span><span class=p>.</span><span class=n>Builder</span><span class=p>&lt;</span><span class=n>EtaResponse</span><span class=p>.</span><span class=n>Eta</span><span class=p>&gt;</span> <span class=p>=</span> <span class=n>and</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>get</span><span class=p>(</span><span class=n>EtaResponse</span><span class=p>.</span><span class=n>Eta</span><span class=o>::</span><span class=n>plat</span><span class=p>).</span><span class=n>isEqualTo</span><span class=p>(</span><span class=n>plat</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>get</span><span class=p>(</span><span class=n>EtaResponse</span><span class=p>.</span><span class=n>Eta</span><span class=o>::</span><span class=n>time</span><span class=p>).</span><span class=n>isEqualTo</span><span class=p>(</span><span class=n>time</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>get</span><span class=p>(</span><span class=n>EtaResponse</span><span class=p>.</span><span class=n>Eta</span><span class=o>::</span><span class=n>dest</span><span class=p>).</span><span class=n>isEqualTo</span><span class=p>(</span><span class=n>dest</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>get</span><span class=p>(</span><span class=n>EtaResponse</span><span class=p>.</span><span class=n>Eta</span><span class=o>::</span><span class=n>seq</span><span class=p>).</span><span class=n>isEqualTo</span><span class=p>(</span><span class=n>seq</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>這個應該沒甚麼特別，之後再看看上一層 <code>EtaResponse</code> 的 custom assertion：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=nd>@JvmName</span><span class=p>(</span><span class=s2>&#34;assert_EtaResponse&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>private</span> <span class=k>fun</span> <span class=nf>Assertion</span><span class=p>.</span><span class=n>Builder</span><span class=p>&lt;</span><span class=n>EtaResponse</span><span class=p>&gt;.</span><span class=n>assert</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>status</span><span class=p>:</span> <span class=n>Int</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>message</span><span class=p>:</span> <span class=n>String</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>url</span><span class=p>:</span> <span class=n>String</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>isDelay</span><span class=p>:</span> <span class=n>String</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>dataKey</span><span class=p>:</span> <span class=n>String</span><span class=p>?</span> <span class=p>=</span> <span class=k>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>upAssertionBlock</span><span class=p>:</span> <span class=n>Assertion</span><span class=p>.</span><span class=n>Builder</span><span class=p>&lt;</span><span class=n>List</span><span class=p>&lt;</span><span class=n>EtaResponse</span><span class=p>.</span><span class=n>Eta</span><span class=p>&gt;&gt;.()</span> <span class=o>-&gt;</span> <span class=n>Unit</span> <span class=p>=</span> <span class=p>{},</span>
</span></span><span class=line><span class=cl>    <span class=n>downAssertionBlock</span><span class=p>:</span> <span class=n>Assertion</span><span class=p>.</span><span class=n>Builder</span><span class=p>&lt;</span><span class=n>List</span><span class=p>&lt;</span><span class=n>EtaResponse</span><span class=p>.</span><span class=n>Eta</span><span class=p>&gt;&gt;.()</span> <span class=o>-&gt;</span> <span class=n>Unit</span> <span class=p>=</span> <span class=p>{},</span>
</span></span><span class=line><span class=cl><span class=p>):</span> <span class=n>Assertion</span><span class=p>.</span><span class=n>Builder</span><span class=p>&lt;</span><span class=n>EtaResponse</span><span class=p>&gt;</span> <span class=p>=</span> <span class=n>and</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>get</span><span class=p>(</span><span class=n>EtaResponse</span><span class=o>::</span><span class=n>status</span><span class=p>).</span><span class=n>isEqualTo</span><span class=p>(</span><span class=n>status</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>get</span><span class=p>(</span><span class=n>EtaResponse</span><span class=o>::</span><span class=n>message</span><span class=p>).</span><span class=n>isEqualTo</span><span class=p>(</span><span class=n>message</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>get</span><span class=p>(</span><span class=n>EtaResponse</span><span class=o>::</span><span class=n>url</span><span class=p>).</span><span class=n>isEqualTo</span><span class=p>(</span><span class=n>url</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>get</span><span class=p>(</span><span class=n>EtaResponse</span><span class=o>::</span><span class=n>isDelay</span><span class=p>).</span><span class=n>isEqualTo</span><span class=p>(</span><span class=n>isDelay</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>dataKey</span> <span class=o>==</span> <span class=k>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>get</span><span class=p>(</span><span class=n>EtaResponse</span><span class=o>::</span><span class=k>data</span><span class=p>).</span><span class=n>isEmpty</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>get</span><span class=p>(</span><span class=n>EtaResponse</span><span class=o>::</span><span class=k>data</span><span class=p>).</span><span class=n>hasSize</span><span class=p>(</span><span class=m>1</span><span class=p>).</span><span class=n>and</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>get</span><span class=p>(</span><span class=n>dataKey</span><span class=p>).</span><span class=n>isNotNull</span><span class=p>().</span><span class=n>and</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>upAssertionBlock</span><span class=p>(</span><span class=k>get</span><span class=p>(</span><span class=n>EtaResponse</span><span class=p>.</span><span class=n>Data</span><span class=o>::</span><span class=n>up</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                <span class=n>downAssertionBlock</span><span class=p>(</span><span class=k>get</span><span class=p>(</span><span class=n>EtaResponse</span><span class=p>.</span><span class=n>Data</span><span class=o>::</span><span class=n>down</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>大部分的 code 都是拿某個 property 再做 assertion。不過特別的地方是 function parameter 的 <code>upAssertionBlock</code> 和 <code>downAssertionBlock</code>。<code>EtaResponse</code> 有兩個 <code>List&lt;EtaResponse.Eta></code> 的 property（用來表示上行和下行的班次），我們打算用剛才的 custom assertion 來做 assertion。<code>upAssertionBlock</code> 和 <code>downAssertionBlock</code> 兩個 lambda 就是用來放針對 <code>List&lt;EtaResponse.Eta></code> 的 assertion（我們會在 lambda 入面 call 剛才那個 custom assertion）。</p><p>至於 <code>dataKey</code> 要檢查是否 null 是因為有時候 response 的 <code>data: Map&lt;String, Data></code> 可以是 empty map，如果我們交了 null 的 <code>dataKey</code> 那就檢查 <code>data</code> 是不是 empty map，否則就檢查那個 map 是不是有那一個 entry 然後就調用 <code>upAssertionBlock</code> 和 <code>downAssertionBlock</code> 兩個 lambda，把 <code>Assertion.Builder&lt;List&lt;EtaResponse.Eta>></code> 交去 lambda 內。</p><p>其實這個 custom assertion 有 lambda 的 parameter，如果<a href=https://www.baeldung.com/kotlin/inline-functions>考慮到效能問題</a>的話可以改成 <a href=https://kotlinlang.org/docs/inline-functions.html>inline function</a>。</p><p>所以最後 <code>EtaResponse</code> 的 assertion 會是這樣：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=n>expectThat</span><span class=p>(</span><span class=n>responseSlot</span><span class=p>.</span><span class=n>captured</span><span class=p>.</span><span class=n>receive</span><span class=p>&lt;</span><span class=n>EtaResponse</span><span class=p>&gt;()).</span><span class=n>assert</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>status</span> <span class=p>=</span> <span class=n>EtaResponse</span><span class=p>.</span><span class=n>STATUS_NORMAL</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>message</span> <span class=p>=</span> <span class=s2>&#34;successful&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>url</span> <span class=p>=</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>isDelay</span> <span class=p>=</span> <span class=n>EtaResponse</span><span class=p>.</span><span class=n>IS_DELAY_FALSE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>dataKey</span> <span class=p>=</span> <span class=s2>&#34;TKL-TKO&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>upAssertionBlock</span> <span class=p>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>hasSize</span><span class=p>(</span><span class=m>4</span><span class=p>).</span><span class=n>and</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>get</span><span class=p>(</span><span class=m>0</span><span class=p>).</span><span class=n>assert</span><span class=p>(</span><span class=s2>&#34;1&#34;</span><span class=p>,</span> <span class=s2>&#34;2020-01-11 14:28:00&#34;</span><span class=p>,</span> <span class=s2>&#34;POA&#34;</span><span class=p>,</span> <span class=s2>&#34;1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>get</span><span class=p>(</span><span class=m>1</span><span class=p>).</span><span class=n>assert</span><span class=p>(</span><span class=s2>&#34;1&#34;</span><span class=p>,</span> <span class=s2>&#34;2020-01-11 14:32:00&#34;</span><span class=p>,</span> <span class=s2>&#34;POA&#34;</span><span class=p>,</span> <span class=s2>&#34;2&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>get</span><span class=p>(</span><span class=m>2</span><span class=p>).</span><span class=n>assert</span><span class=p>(</span><span class=s2>&#34;1&#34;</span><span class=p>,</span> <span class=s2>&#34;2020-01-11 14:36:00&#34;</span><span class=p>,</span> <span class=s2>&#34;LHP&#34;</span><span class=p>,</span> <span class=s2>&#34;3&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>get</span><span class=p>(</span><span class=m>3</span><span class=p>).</span><span class=n>assert</span><span class=p>(</span><span class=s2>&#34;1&#34;</span><span class=p>,</span> <span class=s2>&#34;2020-01-11 14:38:00&#34;</span><span class=p>,</span> <span class=s2>&#34;POA&#34;</span><span class=p>,</span> <span class=s2>&#34;4&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=n>downAssertionBlock</span> <span class=p>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>hasSize</span><span class=p>(</span><span class=m>4</span><span class=p>).</span><span class=n>and</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>get</span><span class=p>(</span><span class=m>0</span><span class=p>).</span><span class=n>assert</span><span class=p>(</span><span class=s2>&#34;2&#34;</span><span class=p>,</span> <span class=s2>&#34;2020-01-11 14:26:00&#34;</span><span class=p>,</span> <span class=s2>&#34;NOP&#34;</span><span class=p>,</span> <span class=s2>&#34;1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>get</span><span class=p>(</span><span class=m>1</span><span class=p>).</span><span class=n>assert</span><span class=p>(</span><span class=s2>&#34;2&#34;</span><span class=p>,</span> <span class=s2>&#34;2020-01-11 14:29:00&#34;</span><span class=p>,</span> <span class=s2>&#34;NOP&#34;</span><span class=p>,</span> <span class=s2>&#34;2&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>get</span><span class=p>(</span><span class=m>2</span><span class=p>).</span><span class=n>assert</span><span class=p>(</span><span class=s2>&#34;2&#34;</span><span class=p>,</span> <span class=s2>&#34;2020-01-11 14:35:00&#34;</span><span class=p>,</span> <span class=s2>&#34;NOP&#34;</span><span class=p>,</span> <span class=s2>&#34;3&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>get</span><span class=p>(</span><span class=m>3</span><span class=p>).</span><span class=n>assert</span><span class=p>(</span><span class=s2>&#34;2&#34;</span><span class=p>,</span> <span class=s2>&#34;2020-01-11 14:37:00&#34;</span><span class=p>,</span> <span class=s2>&#34;TIK&#34;</span><span class=p>,</span> <span class=s2>&#34;4&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></div><p>因為寫法都是大同小異，所以就不再逐一介紹。其餘的 <a href=https://github.com/ericksli/eta-demo/blob/main/app/src/test/java/net/swiftzer/etademo/data/EtaRepositoryImplTest.kt>test case</a> 和 <a href=https://github.com/ericksli/eta-demo/tree/main/app/src/test/resources/api>JSON response 檔</a>可以到 GitHub repo 查閱，而 data layer 的 unit test 部分亦告一段落。</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://eric.swiftzer.net/tags/2021-ithome-%E9%90%B5%E4%BA%BA%E8%B3%BD/>2021 iThome 鐵人賽</a></li><li><a href=https://eric.swiftzer.net/tags/android/>Android</a></li></ul><nav class=paginav><a class=prev href=https://eric.swiftzer.net/2021/09/2021-ithome-ironman-14-flipper/><span class=title>« 上一頁</span><br><span>2021 iThome 鐵人賽 Day 14：Flipper</span></a>
<a class=next href=https://eric.swiftzer.net/2021/09/2021-ithome-ironman-12-data-layer-testing-3/><span class=title>下一頁 »</span><br><span>2021 iThome 鐵人賽 Day 12：Data layer testing (3)</span></a></nav></footer><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//efilm.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></article></main><footer class=footer><span>&copy; 2023 <a href=https://eric.swiftzer.net/>EricLog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>