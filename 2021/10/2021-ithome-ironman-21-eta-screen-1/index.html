<!doctype html><html lang=zh-tw dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>2021 iThome 鐵人賽 Day 21：ETA screen (1) | EricLog</title><meta name=keywords content="2021 iThome 鐵人賽,Android"><meta name=description content="本篇文章是 2021 iThome 鐵人賽參賽題目「寫一個列車抵站時間 Android App」的第 21 篇，你可到 iThome 查看原文。 文章目錄 現在來到整個 app 最重要的頁面：抵站時間頁。這個頁"><meta name=author content><link rel=canonical href=https://ithelp.ithome.com.tw/articles/10278274><link crossorigin=anonymous href=/assets/css/stylesheet.48ed1b8bd3873bc86534e1a6b0ba618b6c80d8a975cf0cf1f1835c2b89c5c5b0.css integrity="sha256-SO0bi9OHO8hlNOGmsLphi2yA2Kl1zwzx8YNcK4nFxbA=" rel="preload stylesheet" as=style><link rel=icon href=https://eric.swiftzer.net/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://eric.swiftzer.net/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://eric.swiftzer.net/favicon-32x32.png><link rel=apple-touch-icon href=https://eric.swiftzer.net/apple-touch-icon.png><link rel=mask-icon href=https://eric.swiftzer.net/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=JetBrains+Mono:wght@300&display=swap" rel=stylesheet><script async src="https://www.googletagmanager.com/gtag/js?id=G-D93F946T73"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-D93F946T73",{anonymize_ip:!1})}</script><meta property="og:title" content="2021 iThome 鐵人賽 Day 21：ETA screen (1)"><meta property="og:description" content="本篇文章是 2021 iThome 鐵人賽參賽題目「寫一個列車抵站時間 Android App」的第 21 篇，你可到 iThome 查看原文。 文章目錄 現在來到整個 app 最重要的頁面：抵站時間頁。這個頁"><meta property="og:type" content="article"><meta property="og:url" content="https://eric.swiftzer.net/2021/10/2021-ithome-ironman-21-eta-screen-1/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-10-06T00:00:00+08:00"><meta property="article:modified_time" content="2021-10-06T00:00:00+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="2021 iThome 鐵人賽 Day 21：ETA screen (1)"><meta name=twitter:description content="本篇文章是 2021 iThome 鐵人賽參賽題目「寫一個列車抵站時間 Android App」的第 21 篇，你可到 iThome 查看原文。 文章目錄 現在來到整個 app 最重要的頁面：抵站時間頁。這個頁"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://eric.swiftzer.net/posts/"},{"@type":"ListItem","position":2,"name":"2021 iThome 鐵人賽 Day 21：ETA screen (1)","item":"https://eric.swiftzer.net/2021/10/2021-ithome-ironman-21-eta-screen-1/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"2021 iThome 鐵人賽 Day 21：ETA screen (1)","name":"2021 iThome 鐵人賽 Day 21：ETA screen (1)","description":"本篇文章是 2021 iThome 鐵人賽參賽題目「寫一個列車抵站時間 Android App」的第 21 篇，你可到 iThome 查看原文。 文章目錄 現在來到整個 app 最重要的頁面：抵站時間頁。這個頁","keywords":["2021 iThome 鐵人賽","Android"],"articleBody":" 本篇文章是 2021 iThome 鐵人賽參賽題目「寫一個列車抵站時間 Android App」的第 21 篇，你可到 iThome 查看原文。\n文章目錄\n現在來到整個 app 最重要的頁面：抵站時間頁。這個頁面基本上都是跟上一頁一樣，都是以 RecyclerView 為主。但因為這次的內容要從 API server 取得，即是說我們需要處理載入中、載入成功和載入失敗三個情景。當中載入成功時更要細分為顯示班次、事故和延誤三個情景。情況好像有點複雜，我們先看看各情景時的畫面：\n抵站時間頁畫面流程 大致上可以分為兩部分：首次成功載入前和首次成功載入後。在首次成功載入前我們要全頁顯示載入中和各式錯誤畫面，但在首次成功載入後我們就盡量停留在班次畫面，如果是不能連接互聯網這類普通錯誤類型的話我們就在頁頂顯示一個 banner，下方就維持顯示之前成功載入的班次資料。但如果是出現事故和延誤的話那就不適宜顯示之前載入的班次，因為很可能都不正確，所以就全頁顯示錯誤。我們會在每次 call 完 API endpoint 後隔一段時間再 call 一次 API endpoint 更新內容，這樣用戶就不用刻意手動更新。\n班次列表 現在我們就先實作 RecyclerView 的部分。做法其實跟之前都是差不多，還是分為行車方向和班次兩個 view type。\nList item types 跟上次一樣，我們都是會建立供 adapter 專用的 sealed interface 來表示顯示的 list item。留意我們不會把上下行標題 String 直接放進去，因為要避免 configuration change 後仍然顯示未切換語言前的文字。另外，因為 Header 只有一個 property，我們可以轉用 value class。\nValue class 以前是叫做 inline class，本身設計的用途是用來明確標明那個 parameter 的意義。Kotlin 的 Duration 本身都是 value class。在定義 value class 時是需要加上 @JvmInline。我們看看下面的例子，原本 getProduct 的參數是 Int，但 Int 的意義不夠明顯。我們可以開一個 value class ProductId 做這個 parameter 的 type。這樣要 call getProduct 就要特別地「instantiate」一個 ProductId，那用家就一定知道這個數字是 product ID 而不是 user ID 之類的東西。留意 value class 在 compile 的時候會盡量拆走那個 type，所以 compile 後的 getProduct 參數最終只會變成 Int，這樣就不用擔心額外的開銷。但如果你做了好幾個放 Int 的 value class 然後又用 when 去判斷那個是不是 ProductId 的話，Kotlin compiler 就只會把那些 variable 的 type 變回普通 Java class 般（因為不可能拿着幾個 Int variable 就可以分辨到是那個 value class）。\n// 原本的寫法 fun getProduct(productId: Int): Product // 用了 value class 的寫法 fun getProduct(productId: ProductId): Product @JvmInline value class ProductId(val id: Int) sealed interface EtaListItem { @JvmInline value class Header(val direction: EtaResult.Success.Eta.Direction) : EtaListItem data class Eta( val direction: EtaResult.Success.Eta.Direction, val destination: Station, val platform: String, val minuteCountdown: Int, ) : EtaListItem object DiffCallback : DiffUtil.ItemCallback\u003cEtaListItem\u003e() { override fun areItemsTheSame(oldItem: EtaListItem, newItem: EtaListItem): Boolean = when { oldItem is Header \u0026\u0026 newItem is Header -\u003e oldItem.direction == newItem.direction oldItem is Eta \u0026\u0026 newItem is Eta -\u003e oldItem == newItem else -\u003e false } override fun areContentsTheSame( oldItem: EtaListItem, newItem: EtaListItem ): Boolean = when { oldItem is Header \u0026\u0026 newItem is Header -\u003e oldItem == newItem oldItem is Eta \u0026\u0026 newItem is Eta -\u003e oldItem == newItem else -\u003e false } } } 由於每筆班次都沒有 ID，我們惟有直接寫 oldItem == newItem。\nList item view 首先是行車方向的 layout XML (eta_list_header_item.xml)：\n","wordCount":"4405","inLanguage":"zh-tw","datePublished":"2021-10-06T00:00:00+08:00","dateModified":"2021-10-06T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://eric.swiftzer.net/2021/10/2021-ithome-ironman-21-eta-screen-1/"},"publisher":{"@type":"Organization","name":"EricLog","logo":{"@type":"ImageObject","url":"https://eric.swiftzer.net/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://eric.swiftzer.net/ accesskey=h title="EricLog (Alt + H)">EricLog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://eric.swiftzer.net/fonts/ title=Fonts><span>Fonts</span></a></li><li><a href=https://eric.swiftzer.net/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://eric.swiftzer.net/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://eric.swiftzer.net/about/ title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://eric.swiftzer.net/>首頁</a>&nbsp;»&nbsp;<a href=https://eric.swiftzer.net/posts/>Posts</a></div><h1 class=post-title>2021 iThome 鐵人賽 Day 21：ETA screen (1)</h1><div class=post-meta><span title='2021-10-06 00:00:00 +0800 +0800'>October 6, 2021</span></div></header><div class=post-content><blockquote><p>本篇文章是 <a href=https://ithelp.ithome.com.tw/2021ironman>2021 iThome 鐵人賽</a>參賽題目「<a href=https://ithelp.ithome.com.tw/users/20139666/ironman/4661>寫一個列車抵站時間 Android App</a>」的第 21 篇，你可到 iThome <a href=https://ithelp.ithome.com.tw/articles/10278274>查看原文</a>。</p><p><a href=https://eric.swiftzer.net/2021-ithome-ironman/>文章目錄</a></p></blockquote><p>現在來到整個 app 最重要的頁面：抵站時間頁。這個頁面基本上都是跟上一頁一樣，都是以 <code>RecyclerView</code> 為主。但因為這次的內容要從 API server 取得，即是說我們需要處理載入中、載入成功和載入失敗三個情景。當中載入成功時更要細分為顯示班次、事故和延誤三個情景。情況好像有點複雜，我們先看看各情景時的畫面：</p><figure><img loading=lazy src=eta-screen-flow.png><figcaption>抵站時間頁畫面流程</figcaption></figure><p>大致上可以分為兩部分：首次成功載入前和首次成功載入後。在首次成功載入前我們要全頁顯示載入中和各式錯誤畫面，但在首次成功載入後我們就盡量停留在班次畫面，如果是不能連接互聯網這類普通錯誤類型的話我們就在頁頂顯示一個 banner，下方就維持顯示之前成功載入的班次資料。但如果是出現事故和延誤的話那就不適宜顯示之前載入的班次，因為很可能都不正確，所以就全頁顯示錯誤。我們會在每次 call 完 API endpoint 後隔一段時間再 call 一次 API endpoint 更新內容，這樣用戶就不用刻意手動更新。</p><h2 id=班次列表>班次列表<a hidden class=anchor aria-hidden=true href=#班次列表>#</a></h2><p>現在我們就先實作 <code>RecyclerView</code> 的部分。做法其實跟之前都是差不多，還是分為行車方向和班次兩個 view type。</p><h2 id=list-item-types>List item types<a hidden class=anchor aria-hidden=true href=#list-item-types>#</a></h2><p>跟上次一樣，我們都是會建立供 adapter 專用的 sealed interface 來表示顯示的 list item。留意我們不會把上下行標題 <code>String</code> 直接放進去，因為要避免 configuration change 後仍然顯示未切換語言前的文字。另外，因為 <code>Header</code> 只有一個 property，我們可以轉用 value class。</p><p>Value class 以前是叫做 inline class，本身設計的用途是用來明確標明那個 parameter 的意義。Kotlin 的 <code>Duration</code> 本身都是 value class。在定義 value class 時是需要加上 <code>@JvmInline</code>。我們看看下面的例子，原本 <code>getProduct</code> 的參數是 <code>Int</code>，但 <code>Int</code> 的意義不夠明顯。我們可以開一個 value class <code>ProductId</code> 做這個 parameter 的 type。這樣要 call <code>getProduct</code> 就要特別地「instantiate」一個 <code>ProductId</code>，那用家就一定知道這個數字是 product ID 而不是 user ID 之類的東西。留意 value class 在 compile 的時候會盡量拆走那個 type，所以 compile 後的 <code>getProduct</code> 參數最終只會變成 <code>Int</code>，這樣就不用擔心額外的開銷。但如果你做了好幾個放 <code>Int</code> 的 value class 然後又用 <code>when</code> 去判斷那個是不是 <code>ProductId</code> 的話，Kotlin compiler 就只會把那些 variable 的 type 變回普通 Java class 般（因為不可能拿着幾個 <code>Int</code> variable 就可以分辨到是那個 value class）。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=c1>// 原本的寫法
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>fun</span> <span class=nf>getProduct</span><span class=p>(</span><span class=n>productId</span><span class=p>:</span> <span class=n>Int</span><span class=p>):</span> <span class=n>Product</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 用了 value class 的寫法
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>fun</span> <span class=nf>getProduct</span><span class=p>(</span><span class=n>productId</span><span class=p>:</span> <span class=n>ProductId</span><span class=p>):</span> <span class=n>Product</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@JvmInline</span>
</span></span><span class=line><span class=cl><span class=k>value</span> <span class=k>class</span> <span class=nc>ProductId</span><span class=p>(</span><span class=k>val</span> <span class=py>id</span><span class=p>:</span> <span class=n>Int</span><span class=p>)</span>
</span></span></code></pre></div><hr><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>sealed</span> <span class=k>interface</span> <span class=nc>EtaListItem</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nd>@JvmInline</span>
</span></span><span class=line><span class=cl>    <span class=k>value</span> <span class=k>class</span> <span class=nc>Header</span><span class=p>(</span><span class=k>val</span> <span class=py>direction</span><span class=p>:</span> <span class=n>EtaResult</span><span class=p>.</span><span class=n>Success</span><span class=p>.</span><span class=n>Eta</span><span class=p>.</span><span class=n>Direction</span><span class=p>)</span> <span class=p>:</span> <span class=n>EtaListItem</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>data</span> <span class=k>class</span> <span class=nc>Eta</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=py>direction</span><span class=p>:</span> <span class=n>EtaResult</span><span class=p>.</span><span class=n>Success</span><span class=p>.</span><span class=n>Eta</span><span class=p>.</span><span class=n>Direction</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=py>destination</span><span class=p>:</span> <span class=n>Station</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=py>platform</span><span class=p>:</span> <span class=n>String</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=py>minuteCountdown</span><span class=p>:</span> <span class=n>Int</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=p>:</span> <span class=n>EtaListItem</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>object</span> <span class=nc>DiffCallback</span> <span class=p>:</span> <span class=n>DiffUtil</span><span class=p>.</span><span class=n>ItemCallback</span><span class=p>&lt;</span><span class=n>EtaListItem</span><span class=p>&gt;()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>override</span> <span class=k>fun</span> <span class=nf>areItemsTheSame</span><span class=p>(</span><span class=n>oldItem</span><span class=p>:</span> <span class=n>EtaListItem</span><span class=p>,</span> <span class=n>newItem</span><span class=p>:</span> <span class=n>EtaListItem</span><span class=p>):</span> <span class=n>Boolean</span> <span class=p>=</span>
</span></span><span class=line><span class=cl>            <span class=k>when</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>oldItem</span> <span class=k>is</span> <span class=n>Header</span> <span class=o>&amp;&amp;</span> <span class=n>newItem</span> <span class=k>is</span> <span class=n>Header</span> <span class=o>-&gt;</span> <span class=n>oldItem</span><span class=p>.</span><span class=n>direction</span> <span class=o>==</span> <span class=n>newItem</span><span class=p>.</span><span class=n>direction</span>
</span></span><span class=line><span class=cl>                <span class=n>oldItem</span> <span class=k>is</span> <span class=n>Eta</span> <span class=o>&amp;&amp;</span> <span class=n>newItem</span> <span class=k>is</span> <span class=n>Eta</span> <span class=o>-&gt;</span> <span class=n>oldItem</span> <span class=o>==</span> <span class=n>newItem</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span> <span class=o>-&gt;</span> <span class=k>false</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>override</span> <span class=k>fun</span> <span class=nf>areContentsTheSame</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>oldItem</span><span class=p>:</span> <span class=n>EtaListItem</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>newItem</span><span class=p>:</span> <span class=n>EtaListItem</span>
</span></span><span class=line><span class=cl>        <span class=p>):</span> <span class=n>Boolean</span> <span class=p>=</span> <span class=k>when</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>oldItem</span> <span class=k>is</span> <span class=n>Header</span> <span class=o>&amp;&amp;</span> <span class=n>newItem</span> <span class=k>is</span> <span class=n>Header</span> <span class=o>-&gt;</span> <span class=n>oldItem</span> <span class=o>==</span> <span class=n>newItem</span>
</span></span><span class=line><span class=cl>            <span class=n>oldItem</span> <span class=k>is</span> <span class=n>Eta</span> <span class=o>&amp;&amp;</span> <span class=n>newItem</span> <span class=k>is</span> <span class=n>Eta</span> <span class=o>-&gt;</span> <span class=n>oldItem</span> <span class=o>==</span> <span class=n>newItem</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span> <span class=o>-&gt;</span> <span class=k>false</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>由於每筆班次都沒有 ID，我們惟有直接寫 <code>oldItem == newItem</code>。</p><h3 id=list-item-view>List item view<a hidden class=anchor aria-hidden=true href=#list-item-view>#</a></h3><p>首先是行車方向的 layout XML (<em>eta_list_header_item.xml</em>)：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;com.google.android.material.textview.MaterialTextView</span> <span class=na>xmlns:android=</span><span class=s>&#34;http://schemas.android.com/apk/res/android&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>xmlns:tools=</span><span class=s>&#34;http://schemas.android.com/tools&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>android:layout_width=</span><span class=s>&#34;match_parent&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>android:layout_height=</span><span class=s>&#34;48dp&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>android:ellipsize=</span><span class=s>&#34;end&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>android:gravity=</span><span class=s>&#34;center_vertical|start&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>android:maxLines=</span><span class=s>&#34;1&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>android:paddingStart=</span><span class=s>&#34;16dp&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>android:paddingEnd=</span><span class=s>&#34;16dp&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>android:textAlignment=</span><span class=s>&#34;viewStart&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>android:textAppearance=</span><span class=s>&#34;?textAppearanceOverline&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>tools:text=</span><span class=s>&#34;@string/up_track&#34;</span> <span class=nt>/&gt;</span>
</span></span></code></pre></div><figure><img loading=lazy src=header.png><figcaption>行車方向 layout XML 預覽</figcaption></figure><p>對應的 <code>HeaderViewHolder</code>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>class</span> <span class=nc>HeaderViewHolder</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>val</span> <span class=py>binding</span><span class=p>:</span> <span class=n>EtaListHeaderItemBinding</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>:</span> <span class=n>RecyclerView</span><span class=p>.</span><span class=n>ViewHolder</span><span class=p>(</span><span class=n>binding</span><span class=p>.</span><span class=n>root</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>bind</span><span class=p>(</span><span class=n>header</span><span class=p>:</span> <span class=n>EtaListItem</span><span class=p>.</span><span class=n>Header</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>binding</span><span class=p>.</span><span class=n>root</span><span class=p>.</span><span class=n>text</span> <span class=p>=</span> <span class=n>binding</span><span class=p>.</span><span class=n>root</span><span class=p>.</span><span class=n>resources</span><span class=p>.</span><span class=n>getString</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=k>when</span> <span class=p>(</span><span class=n>header</span><span class=p>.</span><span class=n>direction</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>EtaResult</span><span class=p>.</span><span class=n>Success</span><span class=p>.</span><span class=n>Eta</span><span class=p>.</span><span class=n>Direction</span><span class=p>.</span><span class=n>UP</span> <span class=o>-&gt;</span> <span class=n>R</span><span class=p>.</span><span class=n>string</span><span class=p>.</span><span class=n>up_track</span>
</span></span><span class=line><span class=cl>                <span class=n>EtaResult</span><span class=p>.</span><span class=n>Success</span><span class=p>.</span><span class=n>Eta</span><span class=p>.</span><span class=n>Direction</span><span class=p>.</span><span class=n>DOWN</span> <span class=o>-&gt;</span> <span class=n>R</span><span class=p>.</span><span class=n>string</span><span class=p>.</span><span class=n>down_track</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>這次我們直接用 view binding 而不是 data binding，因為它只有一個 <code>TextView</code> 沒有其他東西，寫的 code 份量跟用 data binding 還是差不多。</p><p>然後是班次的部分，先看看 layout XML (<em>eta_list_eta_item.xml</em>)：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=cp>&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;layout</span> <span class=na>xmlns:android=</span><span class=s>&#34;http://schemas.android.com/apk/res/android&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>xmlns:app=</span><span class=s>&#34;http://schemas.android.com/apk/res-auto&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>xmlns:tools=</span><span class=s>&#34;http://schemas.android.com/tools&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;data&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;variable</span>
</span></span><span class=line><span class=cl>            <span class=na>name=</span><span class=s>&#34;eta&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>type=</span><span class=s>&#34;net.swiftzer.etademo.presentation.eta.EtaListItem.Eta&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;variable</span>
</span></span><span class=line><span class=cl>            <span class=na>name=</span><span class=s>&#34;presenter&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>type=</span><span class=s>&#34;net.swiftzer.etademo.presentation.stationlist.LineStationPresenter&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/data&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;androidx.constraintlayout.widget.ConstraintLayout</span>
</span></span><span class=line><span class=cl>        <span class=na>android:layout_width=</span><span class=s>&#34;match_parent&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:layout_height=</span><span class=s>&#34;wrap_content&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;androidx.constraintlayout.widget.Guideline</span>
</span></span><span class=line><span class=cl>            <span class=na>android:id=</span><span class=s>&#34;@+id/startGuideline&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>android:layout_width=</span><span class=s>&#34;wrap_content&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>android:layout_height=</span><span class=s>&#34;wrap_content&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>android:orientation=</span><span class=s>&#34;vertical&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>app:layout_constraintGuide_begin=</span><span class=s>&#34;16dp&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;androidx.constraintlayout.widget.Guideline</span>
</span></span><span class=line><span class=cl>            <span class=na>android:id=</span><span class=s>&#34;@+id/endGuideline&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>android:layout_width=</span><span class=s>&#34;wrap_content&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>android:layout_height=</span><span class=s>&#34;wrap_content&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>android:orientation=</span><span class=s>&#34;vertical&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>app:layout_constraintGuide_end=</span><span class=s>&#34;16dp&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;com.google.android.material.textview.MaterialTextView</span>
</span></span><span class=line><span class=cl>            <span class=na>android:id=</span><span class=s>&#34;@+id/destination&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>android:layout_width=</span><span class=s>&#34;0dp&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>android:layout_height=</span><span class=s>&#34;wrap_content&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>android:layout_marginTop=</span><span class=s>&#34;8dp&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>android:layout_marginEnd=</span><span class=s>&#34;16dp&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>android:ellipsize=</span><span class=s>&#34;end&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>android:maxLines=</span><span class=s>&#34;1&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>android:text=</span><span class=s>&#34;@{presenter.mapStation(eta.destination)}&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>android:textAlignment=</span><span class=s>&#34;viewStart&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>android:textAppearance=</span><span class=s>&#34;?textAppearanceListItem&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>app:layout_constraintEnd_toStartOf=</span><span class=s>&#34;@+id/countdown&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>app:layout_constraintStart_toStartOf=</span><span class=s>&#34;@id/startGuideline&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>app:layout_constraintTop_toTopOf=</span><span class=s>&#34;parent&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>app:layout_goneMarginEnd=</span><span class=s>&#34;0dp&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>tools:text=</span><span class=s>&#34;@tools:sample/cities&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;com.google.android.material.textview.MaterialTextView</span>
</span></span><span class=line><span class=cl>            <span class=na>android:id=</span><span class=s>&#34;@+id/platform&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>android:layout_width=</span><span class=s>&#34;0dp&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>android:layout_height=</span><span class=s>&#34;wrap_content&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>android:layout_marginTop=</span><span class=s>&#34;2dp&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>android:layout_marginEnd=</span><span class=s>&#34;16dp&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>android:layout_marginBottom=</span><span class=s>&#34;8dp&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>android:ellipsize=</span><span class=s>&#34;end&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>android:maxLines=</span><span class=s>&#34;1&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>android:text=</span><span class=s>&#34;@{@string/platform(eta.platform)}&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>android:textAlignment=</span><span class=s>&#34;viewStart&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>android:textAppearance=</span><span class=s>&#34;?textAppearanceListItemSecondary&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>app:layout_constraintBottom_toBottomOf=</span><span class=s>&#34;parent&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>app:layout_constraintEnd_toStartOf=</span><span class=s>&#34;@+id/countdown&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>app:layout_constraintStart_toStartOf=</span><span class=s>&#34;@id/startGuideline&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>app:layout_constraintTop_toBottomOf=</span><span class=s>&#34;@id/destination&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>app:layout_goneMarginEnd=</span><span class=s>&#34;0dp&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>tools:text=</span><span class=s>&#34;@string/platform&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;com.google.android.material.textview.MaterialTextView</span>
</span></span><span class=line><span class=cl>            <span class=na>android:id=</span><span class=s>&#34;@+id/countdown&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>isVisible=</span><span class=s>&#34;@{eta.minuteCountdown &amp;gt; 0}&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>android:layout_width=</span><span class=s>&#34;wrap_content&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>android:layout_height=</span><span class=s>&#34;wrap_content&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>android:ellipsize=</span><span class=s>&#34;end&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>android:maxLines=</span><span class=s>&#34;1&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>android:text=</span><span class=s>&#34;@{@plurals/countdown_minute(eta.minuteCountdown, eta.minuteCountdown)}&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>android:textAlignment=</span><span class=s>&#34;viewEnd&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>android:textAppearance=</span><span class=s>&#34;?textAppearanceButton&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>android:textColor=</span><span class=s>&#34;@color/purple_700&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>app:layout_constraintBottom_toBottomOf=</span><span class=s>&#34;parent&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>app:layout_constraintEnd_toEndOf=</span><span class=s>&#34;@id/endGuideline&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>app:layout_constraintTop_toTopOf=</span><span class=s>&#34;parent&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>tools:text=</span><span class=s>&#34;22 min&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/androidx.constraintlayout.widget.ConstraintLayout&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/layout&gt;</span>
</span></span></code></pre></div><p>在 <code>countdown</code> 我們用了 <code>@plurals/countdown_minute</code> 的 <a href=https://developer.android.com/guide/topics/resources/string-resource#Plurals>quantity string resource</a>。括號的兩個參數其實就是跟 <a href=https://developer.android.com/reference/android/content/res/Resources#getQuantityString(int,%20int)><code>getQuantityString</code></a> 一樣。</p><figure><img loading=lazy src=eta.png><figcaption>班次 layout XML 預覽</figcaption></figure><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>class</span> <span class=nc>EtaViewHolder</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>lifecycleOwner</span><span class=p>:</span> <span class=n>LifecycleOwner</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>val</span> <span class=py>binding</span><span class=p>:</span> <span class=n>EtaListEtaItemBinding</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>presenter</span><span class=p>:</span> <span class=n>LineStationPresenter</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>:</span> <span class=n>RecyclerView</span><span class=p>.</span><span class=n>ViewHolder</span><span class=p>(</span><span class=n>binding</span><span class=p>.</span><span class=n>root</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>init</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>binding</span><span class=p>.</span><span class=n>lifecycleOwner</span> <span class=p>=</span> <span class=n>lifecycleOwner</span>
</span></span><span class=line><span class=cl>        <span class=n>binding</span><span class=p>.</span><span class=n>presenter</span> <span class=p>=</span> <span class=n>presenter</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>bind</span><span class=p>(</span><span class=n>eta</span><span class=p>:</span> <span class=n>EtaListItem</span><span class=p>.</span><span class=n>Eta</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>binding</span><span class=p>.</span><span class=n>eta</span> <span class=p>=</span> <span class=n>eta</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>然後是對應的 <code>EtaViewHolder</code>，由於我們用了 data binding，所以裏面只有設定 data binding 的 code。</p><h3 id=adapter>Adapter<a hidden class=anchor aria-hidden=true href=#adapter>#</a></h3><p>接下來就是 <code>ListAdapter</code> 的部分，同樣地都是跟上一頁的差不多。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>class</span> <span class=nc>EtaListAdapter</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>lifecycleOwner</span><span class=p>:</span> <span class=n>LifecycleOwner</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>presenter</span><span class=p>:</span> <span class=n>LineStationPresenter</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>:</span> <span class=n>ListAdapter</span><span class=p>&lt;</span><span class=n>EtaListItem</span><span class=p>,</span> <span class=n>RecyclerView</span><span class=p>.</span><span class=n>ViewHolder</span><span class=p>&gt;(</span><span class=n>EtaListItem</span><span class=p>.</span><span class=n>DiffCallback</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>val</span> <span class=py>lifecycleOwner</span> <span class=p>=</span> <span class=n>WeakReference</span><span class=p>(</span><span class=n>lifecycleOwner</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>val</span> <span class=py>presenter</span> <span class=p>=</span> <span class=n>WeakReference</span><span class=p>(</span><span class=n>presenter</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>onCreateViewHolder</span><span class=p>(</span><span class=n>parent</span><span class=p>:</span> <span class=n>ViewGroup</span><span class=p>,</span> <span class=n>viewType</span><span class=p>:</span> <span class=n>Int</span><span class=p>):</span> <span class=n>RecyclerView</span><span class=p>.</span><span class=n>ViewHolder</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=py>inflater</span> <span class=p>=</span> <span class=n>LayoutInflater</span><span class=p>.</span><span class=n>from</span><span class=p>(</span><span class=n>parent</span><span class=p>.</span><span class=n>context</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>when</span> <span class=p>(</span><span class=n>viewType</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>R</span><span class=p>.</span><span class=n>layout</span><span class=p>.</span><span class=n>eta_list_header_item</span> <span class=o>-&gt;</span> <span class=n>HeaderViewHolder</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>binding</span> <span class=p>=</span> <span class=n>EtaListHeaderItemBinding</span><span class=p>.</span><span class=n>inflate</span><span class=p>(</span><span class=n>inflater</span><span class=p>,</span> <span class=n>parent</span><span class=p>,</span> <span class=k>false</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>R</span><span class=p>.</span><span class=n>layout</span><span class=p>.</span><span class=n>eta_list_eta_item</span> <span class=o>-&gt;</span> <span class=n>EtaViewHolder</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>lifecycleOwner</span> <span class=p>=</span> <span class=n>requireNotNull</span><span class=p>(</span><span class=n>lifecycleOwner</span><span class=p>.</span><span class=k>get</span><span class=p>()),</span>
</span></span><span class=line><span class=cl>                <span class=n>binding</span> <span class=p>=</span> <span class=n>EtaListEtaItemBinding</span><span class=p>.</span><span class=n>inflate</span><span class=p>(</span><span class=n>inflater</span><span class=p>,</span> <span class=n>parent</span><span class=p>,</span> <span class=k>false</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=n>presenter</span> <span class=p>=</span> <span class=n>requireNotNull</span><span class=p>(</span><span class=n>presenter</span><span class=p>.</span><span class=k>get</span><span class=p>()),</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span> <span class=o>-&gt;</span> <span class=k>throw</span> <span class=n>UnsupportedOperationException</span><span class=p>(</span><span class=s2>&#34;Unsupported view type </span><span class=si>$viewType</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>getItemViewType</span><span class=p>(</span><span class=n>position</span><span class=p>:</span> <span class=n>Int</span><span class=p>):</span> <span class=n>Int</span> <span class=p>=</span> <span class=k>when</span> <span class=p>(</span><span class=n>getItem</span><span class=p>(</span><span class=n>position</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>is</span> <span class=n>EtaListItem</span><span class=p>.</span><span class=n>Header</span> <span class=o>-&gt;</span> <span class=n>R</span><span class=p>.</span><span class=n>layout</span><span class=p>.</span><span class=n>eta_list_header_item</span>
</span></span><span class=line><span class=cl>        <span class=k>is</span> <span class=n>EtaListItem</span><span class=p>.</span><span class=n>Eta</span> <span class=o>-&gt;</span> <span class=n>R</span><span class=p>.</span><span class=n>layout</span><span class=p>.</span><span class=n>eta_list_eta_item</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>onBindViewHolder</span><span class=p>(</span><span class=n>holder</span><span class=p>:</span> <span class=n>RecyclerView</span><span class=p>.</span><span class=n>ViewHolder</span><span class=p>,</span> <span class=n>position</span><span class=p>:</span> <span class=n>Int</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>when</span> <span class=p>(</span><span class=k>val</span> <span class=py>item</span> <span class=p>=</span> <span class=n>getItem</span><span class=p>(</span><span class=n>position</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>is</span> <span class=n>EtaListItem</span><span class=p>.</span><span class=n>Header</span> <span class=o>-&gt;</span> <span class=p>(</span><span class=n>holder</span> <span class=k>as</span> <span class=n>HeaderViewHolder</span><span class=p>).</span><span class=n>bind</span><span class=p>(</span><span class=n>item</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>is</span> <span class=n>EtaListItem</span><span class=p>.</span><span class=n>Eta</span> <span class=o>-&gt;</span> <span class=p>(</span><span class=n>holder</span> <span class=k>as</span> <span class=n>EtaViewHolder</span><span class=p>).</span><span class=n>bind</span><span class=p>(</span><span class=n>item</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=頁面>頁面<a hidden class=anchor aria-hidden=true href=#頁面>#</a></h2><p>準備好 <code>RecyclerView</code> 的東西後，我們可以準備頁面的東西。</p><h3 id=layout-xml>Layout XML<a hidden class=anchor aria-hidden=true href=#layout-xml>#</a></h3><p>這頁的 layout XML 主要會放顯示班次的 <code>RecyclerView</code>、表示載入中的 <code>CircularProgressIndicator</code> 和顯示錯誤的 <code>NestedScrollView</code>，那個顯示在 <code>RecyclerView</code> 上方的 banner 會在之後補上。由於普通錯誤、延誤和事故三款錯誤所顯示的 UI 幾乎完全相同，我們會共用 <code>NestedScrollView</code> 入面的 view。</p><p>下面是 <em>eta_fragment.xml</em> 的內容：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=cp>&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;layout</span> <span class=na>xmlns:android=</span><span class=s>&#34;http://schemas.android.com/apk/res/android&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>xmlns:app=</span><span class=s>&#34;http://schemas.android.com/apk/res-auto&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>xmlns:tools=</span><span class=s>&#34;http://schemas.android.com/tools&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;data&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;variable</span>
</span></span><span class=line><span class=cl>            <span class=na>name=</span><span class=s>&#34;viewModel&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>type=</span><span class=s>&#34;net.swiftzer.etademo.presentation.eta.EtaViewModel&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;variable</span>
</span></span><span class=line><span class=cl>            <span class=na>name=</span><span class=s>&#34;lineStationPresenter&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>type=</span><span class=s>&#34;net.swiftzer.etademo.presentation.stationlist.LineStationPresenter&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;variable</span>
</span></span><span class=line><span class=cl>            <span class=na>name=</span><span class=s>&#34;etaPresenter&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>type=</span><span class=s>&#34;net.swiftzer.etademo.presentation.eta.EtaPresenter&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/data&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;androidx.coordinatorlayout.widget.CoordinatorLayout</span>
</span></span><span class=line><span class=cl>        <span class=na>android:layout_width=</span><span class=s>&#34;match_parent&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:layout_height=</span><span class=s>&#34;match_parent&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;com.google.android.material.appbar.AppBarLayout</span>
</span></span><span class=line><span class=cl>            <span class=na>android:layout_width=</span><span class=s>&#34;match_parent&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>android:layout_height=</span><span class=s>&#34;wrap_content&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;com.google.android.material.appbar.MaterialToolbar</span>
</span></span><span class=line><span class=cl>                <span class=na>android:id=</span><span class=s>&#34;@+id/topAppBar&#34;</span>
</span></span><span class=line><span class=cl>                <span class=na>style=</span><span class=s>&#34;@style/Widget.MaterialComponents.Toolbar.Primary&#34;</span>
</span></span><span class=line><span class=cl>                <span class=na>android:layout_width=</span><span class=s>&#34;match_parent&#34;</span>
</span></span><span class=line><span class=cl>                <span class=na>android:layout_height=</span><span class=s>&#34;?attr/actionBarSize&#34;</span>
</span></span><span class=line><span class=cl>                <span class=na>app:menu=</span><span class=s>&#34;@menu/eta&#34;</span>
</span></span><span class=line><span class=cl>                <span class=na>app:navigationIcon=</span><span class=s>&#34;@drawable/ic_baseline_arrow_back_24&#34;</span>
</span></span><span class=line><span class=cl>                <span class=na>app:navigationOnClickListener=</span><span class=s>&#34;@{() -&gt; viewModel.goBack()}&#34;</span>
</span></span><span class=line><span class=cl>                <span class=na>app:subtitle=</span><span class=s>&#34;@{lineStationPresenter.mapLine(viewModel.line)}&#34;</span>
</span></span><span class=line><span class=cl>                <span class=na>app:title=</span><span class=s>&#34;@{lineStationPresenter.mapStation(viewModel.station)}&#34;</span>
</span></span><span class=line><span class=cl>                <span class=na>tools:subtitle=</span><span class=s>&#34;@tools:sample/cities&#34;</span>
</span></span><span class=line><span class=cl>                <span class=na>tools:title=</span><span class=s>&#34;@tools:sample/cities&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;/com.google.android.material.appbar.AppBarLayout&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;androidx.recyclerview.widget.RecyclerView</span>
</span></span><span class=line><span class=cl>            <span class=na>android:id=</span><span class=s>&#34;@+id/recyclerView&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>isVisible=</span><span class=s>&#34;@{viewModel.showEtaList}&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>android:layout_width=</span><span class=s>&#34;match_parent&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>android:layout_height=</span><span class=s>&#34;match_parent&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>app:layout_behavior=</span><span class=s>&#34;@string/appbar_scrolling_view_behavior&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>tools:listitem=</span><span class=s>&#34;@layout/eta_list_eta_item&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;androidx.core.widget.NestedScrollView</span>
</span></span><span class=line><span class=cl>            <span class=na>isVisible=</span><span class=s>&#34;@{viewModel.showError}&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>android:layout_width=</span><span class=s>&#34;match_parent&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>android:layout_height=</span><span class=s>&#34;match_parent&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>android:fillViewport=</span><span class=s>&#34;true&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>app:layout_behavior=</span><span class=s>&#34;@string/appbar_scrolling_view_behavior&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;LinearLayout</span>
</span></span><span class=line><span class=cl>                <span class=na>android:layout_width=</span><span class=s>&#34;match_parent&#34;</span>
</span></span><span class=line><span class=cl>                <span class=na>android:layout_height=</span><span class=s>&#34;match_parent&#34;</span>
</span></span><span class=line><span class=cl>                <span class=na>android:gravity=</span><span class=s>&#34;center&#34;</span>
</span></span><span class=line><span class=cl>                <span class=na>android:orientation=</span><span class=s>&#34;vertical&#34;</span>
</span></span><span class=line><span class=cl>                <span class=na>android:padding=</span><span class=s>&#34;16dp&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=nt>&lt;com.google.android.material.textview.MaterialTextView</span>
</span></span><span class=line><span class=cl>                    <span class=na>android:layout_width=</span><span class=s>&#34;match_parent&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=na>android:layout_height=</span><span class=s>&#34;wrap_content&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=na>android:text=</span><span class=s>&#34;@{etaPresenter.mapErrorMessage(viewModel.errorResult)}&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=na>android:textAlignment=</span><span class=s>&#34;center&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=na>android:textAppearance=</span><span class=s>&#34;?textAppearanceBody1&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=na>tools:text=</span><span class=s>&#34;@string/delay&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=nt>&lt;com.google.android.material.button.MaterialButton</span>
</span></span><span class=line><span class=cl>                    <span class=na>isVisible=</span><span class=s>&#34;@{viewModel.showViewDetail}&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=na>android:layout_width=</span><span class=s>&#34;wrap_content&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=na>android:layout_height=</span><span class=s>&#34;wrap_content&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=na>android:layout_marginTop=</span><span class=s>&#34;16dp&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=na>android:onClick=</span><span class=s>&#34;@{() -&gt; viewModel.viewIncidentDetail()}&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=na>android:text=</span><span class=s>&#34;@string/incident_cta&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=nt>&lt;com.google.android.material.button.MaterialButton</span>
</span></span><span class=line><span class=cl>                    <span class=na>isVisible=</span><span class=s>&#34;@{viewModel.showTryAgain}&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=na>android:layout_width=</span><span class=s>&#34;wrap_content&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=na>android:layout_height=</span><span class=s>&#34;wrap_content&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=na>android:layout_marginTop=</span><span class=s>&#34;16dp&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=na>android:onClick=</span><span class=s>&#34;@{() -&gt; viewModel.refresh()}&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=na>android:text=</span><span class=s>&#34;@string/try_again&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;/LinearLayout&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;/androidx.core.widget.NestedScrollView&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;com.google.android.material.progressindicator.CircularProgressIndicator</span>
</span></span><span class=line><span class=cl>            <span class=na>isVisible=</span><span class=s>&#34;@{viewModel.showLoading}&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>android:layout_width=</span><span class=s>&#34;wrap_content&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>android:layout_height=</span><span class=s>&#34;wrap_content&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>android:layout_gravity=</span><span class=s>&#34;center&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>android:indeterminate=</span><span class=s>&#34;true&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>app:layout_behavior=</span><span class=s>&#34;@string/appbar_scrolling_view_behavior&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/androidx.coordinatorlayout.widget.CoordinatorLayout&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/layout&gt;</span>
</span></span></code></pre></div><figure><img loading=lazy src=screen.png><figcaption>整頁 layout XML 預覽</figcaption></figure><p><code>MaterialToolbar</code> 入面有一個切換班次排序的 menu item，下面是 menu resource XML：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=cp>&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;menu</span> <span class=na>xmlns:android=</span><span class=s>&#34;http://schemas.android.com/apk/res/android&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>xmlns:app=</span><span class=s>&#34;http://schemas.android.com/apk/res-auto&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;item</span>
</span></span><span class=line><span class=cl>        <span class=na>android:id=</span><span class=s>&#34;@+id/changeSorting&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:icon=</span><span class=s>&#34;@drawable/ic_baseline_sort_24&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>android:title=</span><span class=s>&#34;@string/change_sorting&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>app:showAsAction=</span><span class=s>&#34;ifRoom&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/menu&gt;</span>
</span></span></code></pre></div><h3 id=etafragment><code>EtaFragment</code><a hidden class=anchor aria-hidden=true href=#etafragment>#</a></h3><p>我們這次會先做成功顯示班次的情景，所以其他地方會留待之後的篇章討論。<code>EtaFragment</code> 主要的工作是初始化 layout XML data binding、因應 <code>EtaViewModel</code> 外露的 <code>Flow</code> 來更新 <code>RecyclerView</code> 內容和處理用戶按下返回鍵時的轉頁導航。</p><p>在 <code>onViewCreated</code> 入面有一句 <code>viewModel.setLanguage</code> 用來通知 <code>EtaViewModel</code> 當前語言。要從 <code>EtaFragment</code> 取得當前語言而非由 <code>EtaViewModel</code> 經 constructor 取得 <code>Application</code> <code>Context</code> 然後取得當前語言是因為 <code>ViewModel</code> 能夠在 configuration change 後生存（即是在 configuration change 後都能經 <code>ViewModelProvider</code> 取得同一個 <code>ViewModel</code> instance），這亦都是 <code>ViewModel</code> 只能用 <code>Application</code> <code>Context</code> 而非 <code>Activity</code> <code>Context</code> 的原因（因為 <code>Activity</code> 會在 configuration change 後 instantiate 一個新的 instance，如果 <code>ViewModel</code> 持有 <code>Activity</code> 的 instance 會在 configuration change 後 leak <code>Activity</code> 。）回到當前語言的問題，由於 <code>EtaViewModel</code> 在 instantiate 時就拿到 <code>Application</code> <code>Context</code>，那個 <code>Context</code> 在 configuration change 後就不能反映到當前用戶所選的語言，要取得用戶最新選用的語言就要靠 <code>Activity</code> 或 <code>Fragment</code> 的 <code>resources.configuration</code> 取得。這亦解釋了為甚麼我們不會在 <code>ViewModel</code> call <code>resources.getString</code> 這類 method。如果你的 app 本身有強行更改 app locale 的話你應該會儲存用戶想看的語言，這樣你可以在 use case constructor injection 取得語言設定而不用經 <code>Activity</code> 或 <code>Fragment</code>。</p><p><code>EtaPresenter</code> 是用來協助顯示錯誤文字，由於目前我們現在先處理成功的情景，我們暫時略過這部分。</p><p>而 <code>onCreate</code> 我們用了 <a href=https://developer.android.com/reference/androidx/activity/OnBackPressedDispatcher><code>onBackPressedDispatcher</code></a> 攔截用戶 back button 的原因是為了統一返回的處理。之前在 layout XML 我們按 <code>MaterialToolbar</code> 的返回按鈕會 call <code>EtaViewModel</code> 的 <code>goBack</code> 處理，然後 <code>EtaViewModel</code> 會觸發 <code>navigateBack</code> 的 <code>Flow</code> 發射一個訊號讓 <code>EtaFragment</code> 導航。如果不加攔截的話用戶按系統的 back button 就不會繞經這個流程，日後想更改返回的流程就要額外花時間理解為甚麼按上方的 back button 跟下方系統的 back button 會有不同效果。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=nd>@AndroidEntryPoint</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>EtaFragment</span> <span class=p>:</span> <span class=n>Fragment</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>val</span> <span class=py>viewModel</span> <span class=k>by</span> <span class=n>viewModels</span><span class=p>&lt;</span><span class=n>EtaViewModel</span><span class=p>&gt;()</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>var</span> <span class=py>_binding</span><span class=p>:</span> <span class=n>EtaFragmentBinding</span><span class=p>?</span> <span class=p>=</span> <span class=k>null</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>val</span> <span class=py>binding</span><span class=p>:</span> <span class=n>EtaFragmentBinding</span> <span class=k>get</span><span class=p>()</span> <span class=p>=</span> <span class=n>_binding</span><span class=o>!!</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>var</span> <span class=py>_adapter</span><span class=p>:</span> <span class=n>EtaListAdapter</span><span class=p>?</span> <span class=p>=</span> <span class=k>null</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>val</span> <span class=py>adapter</span><span class=p>:</span> <span class=n>EtaListAdapter</span> <span class=k>get</span><span class=p>()</span> <span class=p>=</span> <span class=n>_adapter</span><span class=o>!!</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Inject</span>
</span></span><span class=line><span class=cl>    <span class=k>lateinit</span> <span class=k>var</span> <span class=py>lineStationPresenter</span><span class=p>:</span> <span class=n>LineStationPresenter</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Inject</span>
</span></span><span class=line><span class=cl>    <span class=k>lateinit</span> <span class=k>var</span> <span class=py>etaPresenter</span><span class=p>:</span> <span class=n>EtaPresenter</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>onCreate</span><span class=p>(</span><span class=n>savedInstanceState</span><span class=p>:</span> <span class=n>Bundle</span><span class=p>?)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>super</span><span class=p>.</span><span class=n>onCreate</span><span class=p>(</span><span class=n>savedInstanceState</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>requireActivity</span><span class=p>().</span><span class=n>onBackPressedDispatcher</span><span class=p>.</span><span class=n>addCallback</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=k>true</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>viewModel</span><span class=p>.</span><span class=n>goBack</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>onCreateView</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>inflater</span><span class=p>:</span> <span class=n>LayoutInflater</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>container</span><span class=p>:</span> <span class=n>ViewGroup</span><span class=p>?,</span>
</span></span><span class=line><span class=cl>        <span class=n>savedInstanceState</span><span class=p>:</span> <span class=n>Bundle</span><span class=p>?</span>
</span></span><span class=line><span class=cl>    <span class=p>):</span> <span class=n>View</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>_binding</span> <span class=p>=</span> <span class=n>EtaFragmentBinding</span><span class=p>.</span><span class=n>inflate</span><span class=p>(</span><span class=n>inflater</span><span class=p>,</span> <span class=n>container</span><span class=p>,</span> <span class=k>false</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>binding</span><span class=p>.</span><span class=n>lifecycleOwner</span> <span class=p>=</span> <span class=n>viewLifecycleOwner</span>
</span></span><span class=line><span class=cl>        <span class=n>binding</span><span class=p>.</span><span class=n>viewModel</span> <span class=p>=</span> <span class=n>viewModel</span>
</span></span><span class=line><span class=cl>        <span class=n>binding</span><span class=p>.</span><span class=n>lineStationPresenter</span> <span class=p>=</span> <span class=n>lineStationPresenter</span>
</span></span><span class=line><span class=cl>        <span class=n>binding</span><span class=p>.</span><span class=n>etaPresenter</span> <span class=p>=</span> <span class=n>etaPresenter</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>binding</span><span class=p>.</span><span class=n>root</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>onViewCreated</span><span class=p>(</span><span class=n>view</span><span class=p>:</span> <span class=n>View</span><span class=p>,</span> <span class=n>savedInstanceState</span><span class=p>:</span> <span class=n>Bundle</span><span class=p>?)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>super</span><span class=p>.</span><span class=n>onViewCreated</span><span class=p>(</span><span class=n>view</span><span class=p>,</span> <span class=n>savedInstanceState</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>viewModel</span><span class=p>.</span><span class=n>setLanguage</span><span class=p>(</span><span class=n>resources</span><span class=p>.</span><span class=n>configuration</span><span class=p>.</span><span class=n>appLanguage</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>binding</span><span class=p>.</span><span class=n>topAppBar</span><span class=p>.</span><span class=n>setOnMenuItemClickListener</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>when</span> <span class=p>(</span><span class=k>it</span><span class=p>.</span><span class=n>itemId</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>R</span><span class=p>.</span><span class=n>id</span><span class=p>.</span><span class=n>changeSorting</span> <span class=o>-&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>viewModel</span><span class=p>.</span><span class=n>toggleSorting</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                    <span class=k>true</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span> <span class=o>-&gt;</span> <span class=k>false</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>_adapter</span> <span class=p>=</span> <span class=n>EtaListAdapter</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>lifecycleOwner</span> <span class=p>=</span> <span class=n>viewLifecycleOwner</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>presenter</span> <span class=p>=</span> <span class=n>lineStationPresenter</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>with</span><span class=p>(</span><span class=n>binding</span><span class=p>.</span><span class=n>recyclerView</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>layoutManager</span> <span class=p>=</span> <span class=n>LinearLayoutManager</span><span class=p>(</span><span class=n>requireContext</span><span class=p>())</span>
</span></span><span class=line><span class=cl>            <span class=n>adapter</span> <span class=p>=</span> <span class=k>this</span><span class=nd>@EtaFragment</span><span class=p>.</span><span class=n>adapter</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>observeViewModel</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>fun</span> <span class=nf>observeViewModel</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>viewLifecycleOwner</span><span class=p>.</span><span class=n>lifecycleScope</span><span class=p>.</span><span class=n>launch</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>viewLifecycleOwner</span><span class=p>.</span><span class=n>repeatOnLifecycle</span><span class=p>(</span><span class=n>Lifecycle</span><span class=p>.</span><span class=n>State</span><span class=p>.</span><span class=n>STARTED</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>viewModel</span><span class=p>.</span><span class=n>navigateBack</span><span class=p>.</span><span class=n>collect</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>findNavController</span><span class=p>().</span><span class=n>popBackStack</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>viewLifecycleOwner</span><span class=p>.</span><span class=n>lifecycleScope</span><span class=p>.</span><span class=n>launch</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>viewLifecycleOwner</span><span class=p>.</span><span class=n>repeatOnLifecycle</span><span class=p>(</span><span class=n>Lifecycle</span><span class=p>.</span><span class=n>State</span><span class=p>.</span><span class=n>STARTED</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>viewModel</span><span class=p>.</span><span class=n>etaList</span><span class=p>.</span><span class=n>collect</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>adapter</span><span class=p>.</span><span class=n>submitList</span><span class=p>(</span><span class=k>it</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>onDestroyView</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>super</span><span class=p>.</span><span class=n>onDestroyView</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>binding</span><span class=p>.</span><span class=n>recyclerView</span><span class=p>.</span><span class=n>adapter</span> <span class=p>=</span> <span class=k>null</span>
</span></span><span class=line><span class=cl>        <span class=n>_adapter</span> <span class=p>=</span> <span class=k>null</span>
</span></span><span class=line><span class=cl>        <span class=n>_binding</span> <span class=p>=</span> <span class=k>null</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=etaviewmodel><code>EtaViewModel</code><a hidden class=anchor aria-hidden=true href=#etaviewmodel>#</a></h3><p>最後來到 <code>EtaViewModel</code> 的部分，部分 code 放了 <code>TODO()</code> 是因為這些部分會留待之後講解。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>import</span> <span class=nn>java.time.Duration</span> <span class=k>as</span> <span class=n>JavaDuration</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@HiltViewModel</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>EtaViewModel</span> <span class=nd>@Inject</span> <span class=k>constructor</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>val</span> <span class=py>savedStateHandle</span><span class=p>:</span> <span class=n>SavedStateHandle</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>val</span> <span class=py>clock</span><span class=p>:</span> <span class=n>Clock</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>val</span> <span class=py>getEta</span><span class=p>:</span> <span class=n>GetEtaUseCase</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>:</span> <span class=n>ViewModel</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>val</span> <span class=py>args</span> <span class=k>by</span> <span class=n>navArgs</span><span class=p>&lt;</span><span class=n>EtaFragmentArgs</span><span class=p>&gt;(</span><span class=n>savedStateHandle</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>val</span> <span class=py>language</span> <span class=p>=</span> <span class=n>MutableStateFlow</span><span class=p>(</span><span class=n>Language</span><span class=p>.</span><span class=n>ENGLISH</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>val</span> <span class=py>sortedBy</span> <span class=p>=</span> <span class=n>savedStateHandle</span><span class=p>.</span><span class=n>getLiveData</span><span class=p>(</span><span class=n>SORT_BY</span><span class=p>,</span> <span class=m>0</span><span class=p>).</span><span class=n>asFlow</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>map</span> <span class=p>{</span> <span class=n>GetEtaUseCase</span><span class=p>.</span><span class=n>SortBy</span><span class=p>.</span><span class=n>values</span><span class=p>()[</span><span class=k>it</span><span class=p>]</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>line</span><span class=p>:</span> <span class=n>StateFlow</span><span class=p>&lt;</span><span class=n>Line</span><span class=p>&gt;</span> <span class=p>=</span> <span class=n>MutableStateFlow</span><span class=p>(</span><span class=n>args</span><span class=p>.</span><span class=n>line</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>station</span><span class=p>:</span> <span class=n>StateFlow</span><span class=p>&lt;</span><span class=n>Station</span><span class=p>&gt;</span> <span class=p>=</span> <span class=n>MutableStateFlow</span><span class=p>(</span><span class=n>args</span><span class=p>.</span><span class=n>station</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>val</span> <span class=py>_navigateBack</span> <span class=p>=</span> <span class=n>Channel</span><span class=p>&lt;</span><span class=n>Unit</span><span class=p>&gt;(</span><span class=n>Channel</span><span class=p>.</span><span class=n>BUFFERED</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>navigateBack</span><span class=p>:</span> <span class=n>Flow</span><span class=p>&lt;</span><span class=n>Unit</span><span class=p>&gt;</span> <span class=p>=</span> <span class=n>_navigateBack</span><span class=p>.</span><span class=n>receiveAsFlow</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>val</span> <span class=py>triggerRefresh</span> <span class=p>=</span> <span class=n>Channel</span><span class=p>&lt;</span><span class=n>Unit</span><span class=p>&gt;(</span><span class=n>Channel</span><span class=p>.</span><span class=n>BUFFERED</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>val</span> <span class=py>etaResult</span><span class=p>:</span> <span class=n>StateFlow</span><span class=p>&lt;</span><span class=n>Loadable</span><span class=p>&lt;</span><span class=n>EtaResult</span><span class=p>&gt;&gt;</span> <span class=p>=</span> <span class=n>combineTransform</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>language</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>line</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>station</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>sortedBy</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>triggerRefresh</span><span class=p>.</span><span class=n>receiveAsFlow</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=p>{</span> <span class=n>language</span><span class=p>,</span> <span class=n>line</span><span class=p>,</span> <span class=n>station</span><span class=p>,</span> <span class=n>sortedBy</span><span class=p>,</span> <span class=n>_</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>        <span class=n>emit</span><span class=p>(</span><span class=n>Loadable</span><span class=p>.</span><span class=n>Loading</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>emit</span><span class=p>(</span><span class=n>Loadable</span><span class=p>.</span><span class=n>Loaded</span><span class=p>(</span><span class=n>getEta</span><span class=p>(</span><span class=n>language</span><span class=p>,</span> <span class=n>line</span><span class=p>,</span> <span class=n>station</span><span class=p>,</span> <span class=n>sortedBy</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>    <span class=p>}.</span><span class=n>stateIn</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>scope</span> <span class=p>=</span> <span class=n>viewModelScope</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>started</span> <span class=p>=</span> <span class=n>SharingStarted</span><span class=p>.</span><span class=n>WhileSubscribed</span><span class=p>(</span><span class=n>STATE_FLOW_STOP_TIMEOUT_MILLIS</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>initialValue</span> <span class=p>=</span> <span class=n>Loadable</span><span class=p>.</span><span class=n>Loading</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>val</span> <span class=py>loadedEtaResult</span> <span class=p>=</span> <span class=n>etaResult</span><span class=p>.</span><span class=n>filterIsInstance</span><span class=p>&lt;</span><span class=n>Loadable</span><span class=p>.</span><span class=n>Loaded</span><span class=p>&lt;</span><span class=n>EtaResult</span><span class=p>&gt;&gt;()</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>map</span> <span class=p>{</span> <span class=k>it</span><span class=p>.</span><span class=k>value</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>showLoading</span><span class=p>:</span> <span class=n>StateFlow</span><span class=p>&lt;</span><span class=n>Boolean</span><span class=p>&gt;</span> <span class=p>=</span> <span class=n>etaResult</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>map</span> <span class=p>{</span> <span class=k>it</span> <span class=o>==</span> <span class=n>Loadable</span><span class=p>.</span><span class=n>Loading</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>stateIn</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>scope</span> <span class=p>=</span> <span class=n>viewModelScope</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>started</span> <span class=p>=</span> <span class=n>SharingStarted</span><span class=p>.</span><span class=n>WhileSubscribed</span><span class=p>(</span><span class=n>STATE_FLOW_STOP_TIMEOUT_MILLIS</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>initialValue</span> <span class=p>=</span> <span class=k>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>showError</span><span class=p>:</span> <span class=n>StateFlow</span><span class=p>&lt;</span><span class=n>Boolean</span><span class=p>&gt;</span> <span class=p>=</span> <span class=n>TODO</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>showViewDetail</span><span class=p>:</span> <span class=n>StateFlow</span><span class=p>&lt;</span><span class=n>Boolean</span><span class=p>&gt;</span> <span class=p>=</span> <span class=n>TODO</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>showTryAgain</span><span class=p>:</span> <span class=n>StateFlow</span><span class=p>&lt;</span><span class=n>Boolean</span><span class=p>&gt;</span> <span class=p>=</span> <span class=n>TODO</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>errorResult</span><span class=p>:</span> <span class=n>StateFlow</span><span class=p>&lt;</span><span class=n>EtaFailResult</span><span class=p>&gt;</span> <span class=p>=</span> <span class=n>TODO</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>showEtaList</span> <span class=p>=</span> <span class=n>etaResult</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>map</span> <span class=p>{</span> <span class=k>it</span> <span class=k>is</span> <span class=n>Loadable</span><span class=p>.</span><span class=n>Loaded</span> <span class=o>&amp;&amp;</span> <span class=k>it</span><span class=p>.</span><span class=k>value</span> <span class=k>is</span> <span class=n>EtaResult</span><span class=p>.</span><span class=n>Success</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>stateIn</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>scope</span> <span class=p>=</span> <span class=n>viewModelScope</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>started</span> <span class=p>=</span> <span class=n>SharingStarted</span><span class=p>.</span><span class=n>WhileSubscribed</span><span class=p>(</span><span class=n>STATE_FLOW_STOP_TIMEOUT_MILLIS</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>initialValue</span> <span class=p>=</span> <span class=k>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>etaList</span> <span class=p>=</span> <span class=n>loadedEtaResult</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>filterIsInstance</span><span class=p>&lt;</span><span class=n>EtaResult</span><span class=p>.</span><span class=n>Success</span><span class=p>&gt;()</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>map</span> <span class=p>{</span> <span class=k>it</span><span class=p>.</span><span class=n>schedule</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>combine</span><span class=p>(</span><span class=n>sortedBy</span><span class=p>)</span> <span class=p>{</span> <span class=n>schedule</span><span class=p>,</span> <span class=n>sortedBy</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>            <span class=n>sequence</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>var</span> <span class=py>lastDirection</span><span class=p>:</span> <span class=n>EtaResult</span><span class=p>.</span><span class=n>Success</span><span class=p>.</span><span class=n>Eta</span><span class=p>.</span><span class=n>Direction</span><span class=p>?</span> <span class=p>=</span> <span class=k>null</span>
</span></span><span class=line><span class=cl>                <span class=n>schedule</span><span class=p>.</span><span class=n>forEach</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=p>(</span><span class=n>lastDirection</span> <span class=o>!=</span> <span class=k>it</span><span class=p>.</span><span class=n>direction</span> <span class=o>&amp;&amp;</span> <span class=n>sortedBy</span> <span class=o>==</span> <span class=n>GetEtaUseCase</span><span class=p>.</span><span class=n>SortBy</span><span class=p>.</span><span class=n>DIRECTION</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=n>yield</span><span class=p>(</span><span class=n>EtaListItem</span><span class=p>.</span><span class=n>Header</span><span class=p>(</span><span class=k>it</span><span class=p>.</span><span class=n>direction</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                    <span class=n>yield</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                        <span class=n>EtaListItem</span><span class=p>.</span><span class=n>Eta</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                            <span class=n>direction</span> <span class=p>=</span> <span class=k>it</span><span class=p>.</span><span class=n>direction</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                            <span class=n>destination</span> <span class=p>=</span> <span class=k>it</span><span class=p>.</span><span class=n>destination</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                            <span class=n>platform</span> <span class=p>=</span> <span class=k>it</span><span class=p>.</span><span class=n>platform</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                            <span class=n>minuteCountdown</span> <span class=p>=</span> <span class=n>JavaDuration</span><span class=p>.</span><span class=n>between</span><span class=p>(</span><span class=n>clock</span><span class=p>.</span><span class=n>instant</span><span class=p>(),</span> <span class=k>it</span><span class=p>.</span><span class=n>time</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                                <span class=p>.</span><span class=n>toMinutes</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                                <span class=p>.</span><span class=n>toInt</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                        <span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>lastDirection</span> <span class=p>=</span> <span class=k>it</span><span class=p>.</span><span class=n>direction</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}.</span><span class=n>toList</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>stateIn</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>scope</span> <span class=p>=</span> <span class=n>viewModelScope</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>started</span> <span class=p>=</span> <span class=n>SharingStarted</span><span class=p>.</span><span class=n>WhileSubscribed</span><span class=p>(</span><span class=n>STATE_FLOW_STOP_TIMEOUT_MILLIS</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>initialValue</span> <span class=p>=</span> <span class=n>emptyList</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>val</span> <span class=py>_viewIncidentDetail</span> <span class=p>=</span> <span class=n>Channel</span><span class=p>&lt;</span><span class=n>String</span><span class=p>&gt;(</span><span class=n>Channel</span><span class=p>.</span><span class=n>BUFFERED</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>viewIncidentDetail</span><span class=p>:</span> <span class=n>Flow</span><span class=p>&lt;</span><span class=n>String</span><span class=p>&gt;</span> <span class=p>=</span> <span class=n>_viewIncidentDetail</span><span class=p>.</span><span class=n>receiveAsFlow</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>init</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>viewModelScope</span><span class=p>.</span><span class=n>launch</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>triggerRefresh</span><span class=p>.</span><span class=n>send</span><span class=p>(</span><span class=n>Unit</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>setLanguage</span><span class=p>(</span><span class=n>language</span><span class=p>:</span> <span class=n>Language</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=n>language</span><span class=p>.</span><span class=k>value</span> <span class=p>=</span> <span class=n>language</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>goBack</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>viewModelScope</span><span class=p>.</span><span class=n>launch</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>_navigateBack</span><span class=p>.</span><span class=n>send</span><span class=p>(</span><span class=n>Unit</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>toggleSorting</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>TODO</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>refresh</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>TODO</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>viewIncidentDetail</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>TODO</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>我們先看看 <code>etaResult</code>，我們用了 <code>combineTransform</code> 把 <code>language</code>（語言）、<code>line</code>（路綫）、<code>station</code>（車站）、<code>sortedBy</code>（排序）、<code>triggerRefresh</code>（觸發重新載入）整合在一起然後 call API endpoint（即是 <code>GetEtaUseCase</code>）。除了 <code>triggerRefresh</code> 之外，其餘的都是因為 <code>GetEtaUseCase</code> 需要用到才要加進入 <code>combineTransform</code>。而把 <code>triggerRefresh</code> 加進去只是單純想觸發它 call use case，這樣我們就可以一直使用同一個上游不用因為每次 call API 更新就要切換一個全新的 <code>Flow</code>。在 <code>combineTransform</code> 我們會用 <code>emit</code> 來發射最新的 value 去下游。在這裏我們先發射 <code>Loadable.Loading</code> 好讓我們在 UI 能顯示載入中的畫面。而之後的 <code>emit</code> 就會等待 <code>getEta</code> return 回來後才會發射實際結果。這個寫法會令每次 <code>triggerRefresh</code> 有東西被放進去後 <code>etaResult</code> 都會先發射載入中然後才發射實際 API 回傳結果。而最後轉成 <code>StateFlow</code> 就能讓下游（即是其餘在 data binding 用到的 <code>StateFlow</code> 和 <code>etaList</code>）每次有人 collect 時都不用再 call endpoint。而在 <code>init</code> 我們為了一進入這頁就 call API，所以就加了一句 <code>triggerRefresh.send(Unit)</code> 來觸發第一次的 API call。</p><p>接着就是 <code>loadedEtaResult</code>，它只是用來方便寫之後的 <code>Flow</code>，因為有好幾個 <code>Flow</code> 都會載入後的值才能繼續。</p><p>然後就是顯示 <code>RecyclerView</code> 的部分。<code>showEtaList</code> 就是控制 <code>RecyclerView</code> 是不是可見，所以就要檢查是不是已收到 API 成功的結果。另外一個 <code>Flow</code> 是 <code>etaList</code>，很明顯就是提供 <code>RecyclerView</code> 要顯示的內容。這個我們要取得 <code>EtaResult.Success.schedule</code>（班次）和 <code>sortedBy</code>（排序方式）來準備那個 <code>List</code>。在 <code>combine</code> 內有一個 <code>sequence { ... }.toList()</code> 的 block，其實我只是借 <code>Sequence</code> 來生成一個 <code>List</code>。因為 <a href=https://kotlinlang.org/api/latest/jvm/stdlib/kotlin.collections/build-list.html><code>buildList</code></a> 現在仍是 experimental，如果不想 opt-in 去用這些 API 的話就找了 <code>sequence</code> 來代替。跟上面的 <code>combineTransform</code> 有點似，<code>sequence</code> 都有 <code>yield</code> 來提供元素放進去 <code>Sequence</code> 內。整段 code 的大意是：如果是按方向排序的話，那就在方向開首加插一個標題（因為 <code>EtaResult.Success.schedule</code> 已經按方向排序好，所以我們會留意 <code>EtaResult.Success.schedule</code> 的 <code>direction</code> 跟上一筆是否不同就知道要不要加插標題）；如果是按時間排序就直接生成 <code>EtaListItem.Eta</code> 就可以了。在轉換成供 adapter 使用的 <code>EtaListItem.Eta</code> 我們會把 <code>Instant</code> 換算成分鐘。那個 <code>JavaDuration</code> 是 <code>java.time.Duration</code>，幫它改名是因為之後我們會同時用到 Java 的 <code>Duration</code> 和 Kotlin 的 <code>Duration</code>，為免混淆我們就把它改名。</p><p>至於 <code>goBack</code> 就是處理用戶返回上一頁的動作，由於我們沒有特別的東西要做，所以就直接向 <code>_navigateBack</code> <code>Channel</code> 發送一個 <code>Unit</code> 就可以了，另外會提供一個 <code>navigateBack</code> 的 <code>Flow</code> 讓 <code>Fragment</code> 接收。同時做 private 的 <code>Channel</code> 跟 public 的 <code>Flow</code> 意義在於 <code>Channel</code> 本身就可以讓人放東西進去，在 <code>ViewModel</code> 我們應該只開放指定的渠道供 <code>Fragment</code> 去通知 <code>ViewModel</code>。把 <code>Channel</code> 直接 public 出去 <code>Fragment</code> 那邊就可以直接繞過我們原先設計的機制，所以在很多 <code>ViewModel</code> 的示範都會同時出現 <code>MutableLiveData</code> 跟 <code>LiveData</code>、<code>MutableStateFlow</code> 跟 <code>StateFlow</code> 的組合，就是為了令 <code>Fragment</code> 那邊不能直接改變 value，要改變 value 就一定要經 <code>ViewModel</code> 指定 method 去改。習慣上如果出現這種組合的話，我們會把 private 那個 variable 前面加一個 underscore (<code>_</code>) 來分別 public 那一個。如果你能想到一個更好的命字就當然直接用另一個名字。分開 public/private 的好處是為日後功能有變動時留有空間，而且把 logic 保留在 <code>ViewModel</code> 內。</p><h2 id=小結>小結<a hidden class=anchor aria-hidden=true href=#小結>#</a></h2><p>這次的內容比較長，這是因為我想盡量壓縮篇數來寫其他內容。現在我們已經做了最基本顯示成功載入班次的部分。下一篇我們會暫時轉一轉題目，然後才繼續餘下的部分。</p><p>本篇我們看了用 <code>combine</code> 和 <code>combineTransform</code> 把多個 <code>Flow</code> 匯合成一個新的 <code>Flow</code>，以往用 <code>LiveData</code> 我們要自己 extend <code>MediatorLiveData</code> 才能做到的東西現在轉用 <code>Flow</code> 就有現成的東西可以用。</p><p>完整的 code 可以在 <a href=https://github.com/ericksli/eta-demo/tree/main/app/src/main/java/net/swiftzer/etademo/presentation/eta>GitHub repo</a> 找到，不過會夾雜本篇未完成的部分，希望大家不要介意。</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://eric.swiftzer.net/tags/2021-ithome-%E9%90%B5%E4%BA%BA%E8%B3%BD/>2021 iThome 鐵人賽</a></li><li><a href=https://eric.swiftzer.net/tags/android/>Android</a></li></ul><nav class=paginav><a class=prev href=https://eric.swiftzer.net/2021/10/2021-ithome-ironman-22-whistle-proxy/><span class=title>« 上一頁</span><br><span>2021 iThome 鐵人賽 Day 22：Whistle proxy</span></a>
<a class=next href=https://eric.swiftzer.net/2021/10/2021-ithome-ironman-20-station-list-screen-2/><span class=title>下一頁 »</span><br><span>2021 iThome 鐵人賽 Day 20：Station list screen (2)</span></a></nav></footer><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//efilm.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></article></main><footer class=footer><span>&copy; 2023 <a href=https://eric.swiftzer.net/>EricLog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>