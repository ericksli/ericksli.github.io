<!doctype html><html lang=zh-tw dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>2021 iThome 鐵人賽 Day 27：ETA screen testing (1) | EricLog</title><meta name=keywords content="2021 iThome 鐵人賽,Android"><meta name=description content="本篇文章是 2021 iThome 鐵人賽參賽題目「寫一個列車抵站時間 Android App」的第 27 篇，你可到 iThome 查看原文。 文章目錄 上一篇我們完成了車站列表頁的 ViewModel 和 Presenter 的 unit test"><meta name=author content><link rel=canonical href=https://ithelp.ithome.com.tw/articles/10280812><link crossorigin=anonymous href=/assets/css/stylesheet.48ed1b8bd3873bc86534e1a6b0ba618b6c80d8a975cf0cf1f1835c2b89c5c5b0.css integrity="sha256-SO0bi9OHO8hlNOGmsLphi2yA2Kl1zwzx8YNcK4nFxbA=" rel="preload stylesheet" as=style><link rel=icon href=https://eric.swiftzer.net/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://eric.swiftzer.net/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://eric.swiftzer.net/favicon-32x32.png><link rel=apple-touch-icon href=https://eric.swiftzer.net/apple-touch-icon.png><link rel=mask-icon href=https://eric.swiftzer.net/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=JetBrains+Mono:wght@300&display=swap" rel=stylesheet><script async src="https://www.googletagmanager.com/gtag/js?id=G-D93F946T73"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-D93F946T73",{anonymize_ip:!1})}</script><meta property="og:title" content="2021 iThome 鐵人賽 Day 27：ETA screen testing (1)"><meta property="og:description" content="本篇文章是 2021 iThome 鐵人賽參賽題目「寫一個列車抵站時間 Android App」的第 27 篇，你可到 iThome 查看原文。 文章目錄 上一篇我們完成了車站列表頁的 ViewModel 和 Presenter 的 unit test"><meta property="og:type" content="article"><meta property="og:url" content="https://eric.swiftzer.net/2021/10/2021-ithome-ironman-27-eta-screen-testing-1/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-10-12T00:00:00+08:00"><meta property="article:modified_time" content="2021-10-12T00:00:00+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="2021 iThome 鐵人賽 Day 27：ETA screen testing (1)"><meta name=twitter:description content="本篇文章是 2021 iThome 鐵人賽參賽題目「寫一個列車抵站時間 Android App」的第 27 篇，你可到 iThome 查看原文。 文章目錄 上一篇我們完成了車站列表頁的 ViewModel 和 Presenter 的 unit test"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://eric.swiftzer.net/posts/"},{"@type":"ListItem","position":2,"name":"2021 iThome 鐵人賽 Day 27：ETA screen testing (1)","item":"https://eric.swiftzer.net/2021/10/2021-ithome-ironman-27-eta-screen-testing-1/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"2021 iThome 鐵人賽 Day 27：ETA screen testing (1)","name":"2021 iThome 鐵人賽 Day 27：ETA screen testing (1)","description":"本篇文章是 2021 iThome 鐵人賽參賽題目「寫一個列車抵站時間 Android App」的第 27 篇，你可到 iThome 查看原文。 文章目錄 上一篇我們完成了車站列表頁的 ViewModel 和 Presenter 的 unit test","keywords":["2021 iThome 鐵人賽","Android"],"articleBody":" 本篇文章是 2021 iThome 鐵人賽參賽題目「寫一個列車抵站時間 Android App」的第 27 篇，你可到 iThome 查看原文。\n文章目錄\n上一篇我們完成了車站列表頁的 ViewModel 和 Presenter 的 unit test。現在轉過去寫班次頁的 unit test。\nEtaPresenter 首先我們寫 EtaPresenter 的 test。這次我們來點新意思：使用 JUnit 4 的 parameterized test，寫法跟之前 LineStationPresenterTest 很不同。Parameterized test 的基本格式是：\n提供一堆輸入和預期輸出值的 Collection（例如 List） Constructor 的 parameter 會接收那些參數 在 test method 可以拿 constructor 的 parameter 來做測試的輸入和預期輸出值 因為這次要用 Robolectric 取得 Android 的 string resource，我們要先在 build.gradle 加入以下的東西才能令 Robolectric 取得 Android resource：\nandroid { // 略…… testOptions { unitTests { includeAndroidResources = true } } } 但這次我們不需要刻意用 @Config 改變語言，因為 mapErrorMessage 只需要回傳 string resource，我們的 code 沒有 logic 決定輸出甚麼語言的文字。接下來就是完整的 EtaPresenterTest：\n@RunWith(ParameterizedRobolectricTestRunner::class) class EtaPresenterTest( private val result: EtaFailResult, private val expectedString: String?, @StringRes private val expectedResourceId: Int, ) { private lateinit var presenter: EtaPresenter private lateinit var res: Resources @Before fun setUp() { presenter = EtaPresenter(ApplicationProvider.getApplicationContext()) res = ApplicationProvider.getApplicationContext\u003cContext\u003e().resources } @Test fun mapErrorMessage() { if (expectedString == null) { expectThat(presenter.mapErrorMessage(result)).isEqualTo(res.getString(expectedResourceId)) } else { expectThat(presenter.mapErrorMessage(result)).isEqualTo(expectedString) } } companion object { @JvmStatic @get:ParameterizedRobolectricTestRunner.Parameters val data = listOf( arrayOf(EtaResult.Delay, null, R.string.delay), arrayOf(EtaResult.Incident(\"Incident\", \"https://example.com\"), \"Incident\", 0), arrayOf(EtaResult.TooManyRequests, null, R.string.error), arrayOf(EtaResult.InternalServerError, null, R.string.error), arrayOf(EtaResult.Error(RuntimeException(\"Testing\")), null, R.string.error), ) } } 先看 class 的 @RunWith，如果是單純的 JUnit 4 parameterized test 是應該用 JUnit 的 Parameterized runner。但因為我們要用 Robolectric 所以要改用 ParameterizedRobolectricTestRunner。之前用的那個 AndroidJUnit4 runner 它有封裝 Robolectric runner，但不支援 parameterized test，惟有直接用 Robolectric 提供的 runner。\n之後看看最底的 companion object，同樣因為要用 ParameterizedRobolectricTestRunner，所以要用對應的 @get:ParameterizedRobolectricTestRunner.Parameters 來標註提供予 test method 的參數。前面加了 @get 是因為我們要針對 property getter 來 annotation（因為 JUnit 是 Java 的東西，不會看懂 val，JUnit 本身的 @Parameters 是用來標註在 static method，所以要放在 companion object 內另加 @JvmStatic）。由於 EtaFailResult 有五款，我們在 listOf 就針對這五款情況提供了五組參數，每組都用 arrayOf 包住，它們分別對應 constructor 的三個參數。\n之後跳到 mapErrorMessage 這個 test method。我們會在 test method 用到 constructor 的三個參數來完成 assertion。由於我不想日後改了 string resource 的文字後 test 會報錯，所以在使用 string resource 的情景就在參數交了 string resource ID，但缺點是 assertion 部分就像謄文般抄一次它背後的 code 一次。你可以視乎情況決定在測試時即場用 string resource ID 取得文字來做做比對還是在 test case 寫死它輸出的文字做比對。\n順帶一提，如果想令 test case 的名不是 mapErrorMessage[0]、mapErrorMessage[1] 之類的話，可以在 @get:ParameterizedRobolectricTestRunner.Parameters 或者 @get:Parameters 加上 name 參數。例如 @get:Parameters(name = \"{0}\") 就是第一個參數的值 toString 後的文字，換做 {1} 就是第二個參數，如此類推。預設是用 {index} 即是參數序號。\nEtaViewModel 現在來到最後一個 ViewModel，最重要的部分當然是 etaList。由於 EtaViewModel 的 constructor 有 Java Time 的 Clock，為方便之後的測試，我們會用 ThreeTen-Extra 提供的 MutableClock：\ntestImplementation \"org.threeten:threeten-extra:$threeTenExtraVersion\" 如果不需要在測試中途改變 Clock 輸出的時間，可以直接用 Java Time 的 Clock.fixed()，毋須另外安裝 ThreeTen-Extra。\n但在寫跟 etaList 相關的 test case 之前我們先來測試一些簡單的東西。首先準備好 test class 的基本通用部分：\nprivate val DEFAULT_LOCAL_DATE = LocalDate.of(2021, 9, 1) private val DEFAULT_LOCAL_TIME = LocalTime.of(13, 0, 0) private val DEFAULT_INSTANT = ZonedDateTime.of(DEFAULT_LOCAL_DATE, DEFAULT_LOCAL_TIME, DEFAULT_TIMEZONE).toInstant() @RunWith(AndroidJUnit4::class) class EtaViewModelTest { @get:Rule val coroutineScope = MainCoroutineScopeRule() @MockK private lateinit var getEtaUseCase: GetEtaUseCase private lateinit var clock: MutableClock @Before fun setUp() { MockKAnnotations.init(this) clock = MutableClock.of(DEFAULT_INSTANT, DEFAULT_TIMEZONE) } } 雖然 EtaViewModel 沒有直接用到 Android SDK 的 class，但因為 constructor 的 SavedStateHandle 背後有用到 Bundle 所以還是要加上 @RunWith(AndroidJUnit4::class)。在 setUp 我們先設定 MutableClock 的時間做 2021 年 9 月 1 日下午 1 時正。這次特意用 MutableClock 是因為我們那個定時更新功能需要用 Clock 取得當前時間來決定下次 call API 的時間，如果時間是在 call EtaViewModel constructor 那時寫死的話就不能測試那個位置。這亦都是我們用 dependency injection library inject Clock 而不是用 System.currentTimeMillis 之類的方式取得當前時間的原因。\n我們先來寫一些簡單的 test case：line 跟 station，這兩個 StateFlow 就是供 data binding 的 MaterialToolbar 顯示班次所屬於的路綫和車站。這兩個 StateFlow 的值其實是來自 SavedStateHandle（即是 Fragment 的 arguments），我們需要在 EtaViewModel 的 constructor 提供帶有這兩個參數的 SavedStateHandle 然後檢查這兩個 StateFlow 的值是不是跟我們放在 SavedStateHandle 的一樣。\n@Test fun line() = coroutineScope.runBlockingTest { val viewModel = EtaViewModel( savedStateHandle = SavedStateHandle( mapOf( \"line\" to Line.TCL, \"station\" to Station.TUC, ) ), clock = clock, getEta = getEtaUseCase, ) viewModel.line.test { expectThat(awaitItem()).isEqualTo(Line.TCL) expectNoEvents() } } @Test fun station() = coroutineScope.runBlockingTest { val viewModel = EtaViewModel( savedStateHandle = SavedStateHandle( mapOf( \"line\" to Line.TCL, \"station\" to Station.TUC, ) ), clock = clock, getEta = getEtaUseCase, ) viewModel.station.test { expectThat(awaitItem()).isEqualTo(Station.TUC) expectNoEvents() } } 兩個 test case 的內容基本上是一樣，首先是要建構 EtaViewModel。跟以前的 test case 寫法不同，我們不會在 @Before 預先建構 EtaViewModel，這是因為不同的 test case 需要傳入不同的 constructor 參數（其實是 SavedStateHandle 會因應 test case 不同）。之後就是用 Turbine collect 我們要檢查的 Flow。由於路綫和車站在整頁的 lifecycle 都不會再改變，所以當初我們寫的時候就直接把 MutableStateFlow cast 成 StateFlow，並且在 MutableStateFlow 以 SavedStateHandle 取得的 argument 值作為它的初始值（下面就是它們的定義）。所以這兩個 StateFlow 只會發射一個值出去。\nval line: StateFlow\u003cLine\u003e = MutableStateFlow(args.line) val station: StateFlow\u003cStation\u003e = MutableStateFlow(args.station) 我們知道這兩個 StateFlow 只會發射一個值，那我們在測試時只需要 call 一次 awaitItem() 就可以了，當 assert 完第一個值後就可以 call expectNoEvents() 告訴 Turbine 之後應該不會再有新的值出現。\n之後我們看看另一個 test case navigateBack。\n@Test fun navigateBack() = coroutineScope.runBlockingTest { val viewModel = EtaViewModel( savedStateHandle = SavedStateHandle( mapOf( \"line\" to Line.TCL, \"station\" to Station.TUC, ) ), clock = clock, getEta = getEtaUseCase, ) viewModel.navigateBack.test { viewModel.goBack() awaitEvent() expectNoEvents() } } 這個又是比較簡單的，就是測試 call 了 viewModel.goBack() 後 viewModel.navigateBack 這個 Flow 有沒有發射訊號提示 EtaFragment 轉頁。由於這個 Flow 的 type 是 Unit，我們就不用 assert 它的值，只需要讓它消耗掉就可以了。\n接下來我們會寫 viewIncidentDetail 的測試。由於它是看結果是不是 EtaResult.Incident 才向 viewIncidentDetail 發射要瀏覽的網址，所以我們先試試當 getEtaUseCase 輸出 EtaResult.Incident 的情況：\n@Test fun `viewIncidentDetail incident`() = coroutineScope.runBlockingTest { coEvery { getEtaUseCase( Language.ENGLISH, Line.TCL, Station.TUC, GetEtaUseCase.SortBy.DIRECTION, ) } returns EtaResult.Incident(\"Message\", \"https://example.com\") val viewModel = EtaViewModel( savedStateHandle = SavedStateHandle( mapOf( \"line\" to Line.TCL, \"station\" to Station.TUC, ) ), clock = clock, getEta = getEtaUseCase, ) viewModel.etaList.test { viewModel.viewIncidentDetail.test { viewModel.startAutoRefresh() viewModel.viewIncidentDetail() expectThat(awaitItem()).isEqualTo(\"https://example.com\") expectNoEvents() } cancelAndIgnoreRemainingEvents() } } 因為在 call 了 EtaViewModel.startAutoRefresh 才會 call use case，我們在 viewModel.viewIncidentDetail.test 內第一句就是 viewModel.startAutoRefresh()。在寫的時候我發現 viewModel.viewIncidentDetail.test 會有怪問題出現。原來是因為我們之前寫 etaResult 是 StateFlow。如果外圍再包多一層 viewModel.etaList.test 的話才會正常，這是因為 StateFlow 是 cold flow。意思是如果沒有其他人 collect 這個 flow 的話，那在 etaResult 寫的一大串 flatMapLatest 和 scan 是不會執行。但 etaResult 是 private，所以我找了 etaList 來 collect（因為它的上游是 etaResult），這樣才不會卡死在 Loading。在實際執行其實看不到這個問題，因為 layout XML 的 data binding 會 collect 那一大堆跟 etaResult 相關的 StateFlow，所以 etaResult 內的東西一定會被執行。但感覺上還是不好吧，所以我們應該把 etaResult 改成即使沒有人 collect 仍會執行（即是 hot flow）。SharedFlow 就是 hot flow 的一種，以下是節錄自 SharedFlow 的 KDoc：\nA hot Flow that shares emitted values among all its collectors in a broadcast fashion, so that all collectors get all emitted values. A shared flow is called hot because its active instance exists independently of the presence of collectors. This is opposed to a regular Flow, such as defined by the flow { ... } function, which is cold and is started separately for each collector.\n有一樣東西要留意是：如果連續有兩個相同的值發送到 SharedFlow 的話，那麼兩個值都能交到下游；但 StateFlow 就會吃掉第二個值，直至下一個值跟先前的值不相同才會交到下游。不過在我們這個情況因為下游都是 StateFlow，即使上游發射重覆的值對那些 StateFlow 的下游都沒有分別。\n要改成 SharedFlow，只需把原先的 stateIn 換成 shareIn。 replay 設定 1 是為了其他人一開始訂閱時就能馬上收到 SharedFlow 在訂閱前所發射的最後一個值，這樣就不用讓下游在訂閱時乾等到下一次更新才能收到 CachedResult。\n改了 etaResult 後還是要改其他地方，因為 SharedFlow 是沒有 value 這個 property，要取新最新的值就要用 first()。所以我們需要一併修改 startAutoRefresh 和 viewIncidentDetail。我們亦順帶修正 viewIncidentDetail 只看 currentResult 的問題：如果當前是載入中但畫面仍是顯示事故畫面的話那按下「View detail」沒有反應。\nprivate val etaResult: SharedFlow\u003cCachedResult\u003e = triggerRefresh .consumeAsFlow() .flatMapLatest { /* 略 */ } .scan(CachedResult()) { acc, currentValue -\u003e /* 略 */ } .shareIn( scope = viewModelScope, started = SharingStarted.WhileSubscribed(STATE_FLOW_STOP_TIMEOUT_MILLIS), replay = 1, ) fun startAutoRefresh() { autoRefreshScope.launch { val delayDuration = JavaDuration.between(etaResult.first().currentResult.updatedAt, clock.instant()) // 略 } } fun viewIncidentDetail() { viewModelScope.launch { val result = etaResult.first().lastFailResult if (result !is EtaResult.Incident) return@launch _viewIncidentDetail.send(result.url) } } 那剛才的 viewIncidentDetail incident test case 我們就可以拿掉 viewModel.etaList.test 的部分。\n我們再試試當 lastFailResult 不是 EtaResult.Incident 的情況，為了令 test case 寫得短，我用了 EtaResult.Delay 來試。\n@Test fun `viewIncidentDetail delay`() = coroutineScope.runBlockingTest { coEvery { getEtaUseCase( Language.ENGLISH, Line.TCL, Station.TUC, GetEtaUseCase.SortBy.DIRECTION, ) } returns EtaResult.Delay val viewModel = EtaViewModel( savedStateHandle = SavedStateHandle( mapOf( \"line\" to Line.TCL, \"station\" to Station.TUC, ) ), clock = clock, getEta = getEtaUseCase, ) viewModel.viewIncidentDetail.test { viewModel.startAutoRefresh() viewModel.viewIncidentDetail() expectNoEvents() } } 這次我們期望 viewIncidentDetail 這個 Flow 不會發射訊號，所以用了 expectNoEvents()。\n在本篇結束前我們再寫多一個 test case showLoading，它就是用來控制是否顯示 CircularProgressIndicator。CircularProgressIndicator 會在載入完成後消失，我們會檢查它是不是首先顯示然後轉為不顯示。\n@Test fun showLoading() = coroutineScope.runBlockingTest { coEvery { getEtaUseCase( Language.ENGLISH, Line.TCL, Station.TUC, GetEtaUseCase.SortBy.DIRECTION, ) } returns EtaResult.InternalServerError val viewModel = EtaViewModel( savedStateHandle = SavedStateHandle( mapOf( \"line\" to Line.TCL, \"station\" to Station.TUC, ) ), clock = clock, getEta = getEtaUseCase, ) viewModel.showLoading.test { viewModel.startAutoRefresh() expectThat(awaitItem()).isEqualTo(true) expectThat(awaitItem()).isEqualTo(false) expectNoEvents() } } 小結 現在我們已經寫了幾個 test case，了解到如何測試 Flow，順帶介紹了 SharedFlow。另外亦在寫測試時發現先前寫的 code 有 bug，這其實是正常的，因為靠實機人手體驗可能會看不到一些問題，換了另一個角度又會看得到之前不為意的問題。下一篇我們會寫一些跟時間相關的 test case，完整的 code 可以在 GitHub repo 找到。\n參考 Testing Coroutines on Android (Android Dev Summit ‘19) KotlinConf 2019: Testing with Coroutines by Sean McQuillan StateFlow and SharedFlow ","wordCount":"3542","inLanguage":"zh-tw","datePublished":"2021-10-12T00:00:00+08:00","dateModified":"2021-10-12T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://eric.swiftzer.net/2021/10/2021-ithome-ironman-27-eta-screen-testing-1/"},"publisher":{"@type":"Organization","name":"EricLog","logo":{"@type":"ImageObject","url":"https://eric.swiftzer.net/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://eric.swiftzer.net/ accesskey=h title="EricLog (Alt + H)">EricLog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://eric.swiftzer.net/fonts/ title=Fonts><span>Fonts</span></a></li><li><a href=https://eric.swiftzer.net/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://eric.swiftzer.net/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://eric.swiftzer.net/about/ title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://eric.swiftzer.net/>首頁</a>&nbsp;»&nbsp;<a href=https://eric.swiftzer.net/posts/>Posts</a></div><h1 class=post-title>2021 iThome 鐵人賽 Day 27：ETA screen testing (1)</h1><div class=post-meta><span title='2021-10-12 00:00:00 +0800 +0800'>October 12, 2021</span></div></header><div class=post-content><blockquote><p>本篇文章是 <a href=https://ithelp.ithome.com.tw/2021ironman>2021 iThome 鐵人賽</a>參賽題目「<a href=https://ithelp.ithome.com.tw/users/20139666/ironman/4661>寫一個列車抵站時間 Android App</a>」的第 27 篇，你可到 iThome <a href=https://ithelp.ithome.com.tw/articles/10280812>查看原文</a>。</p><p><a href=https://eric.swiftzer.net/2021-ithome-ironman/>文章目錄</a></p></blockquote><p>上一篇我們完成了車站列表頁的 ViewModel 和 Presenter 的 unit test。現在轉過去寫班次頁的 unit test。</p><h2 id=etapresenter><code>EtaPresenter</code><a hidden class=anchor aria-hidden=true href=#etapresenter>#</a></h2><p>首先我們寫 <code>EtaPresenter</code> 的 test。這次我們來點新意思：使用 JUnit 4 的 parameterized test，寫法跟之前 <code>LineStationPresenterTest</code> 很不同。Parameterized test 的基本格式是：</p><ol><li>提供一堆輸入和預期輸出值的 <code>Collection</code>（例如 <code>List</code>）</li><li>Constructor 的 parameter 會接收那些參數</li><li>在 test method 可以拿 constructor 的 parameter 來做測試的輸入和預期輸出值</li></ol><p>因為這次要用 Robolectric 取得 Android 的 string resource，我們要先在 <em>build.gradle</em> 加入以下的東西才能令 Robolectric 取得 Android resource：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-groovy data-lang=groovy><span class=line><span class=cl><span class=n>android</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 略……
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>testOptions</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>unitTests</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>includeAndroidResources</span> <span class=o>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>但這次我們不需要刻意用 <code>@Config</code> 改變語言，因為 <code>mapErrorMessage</code> 只需要回傳 string resource，我們的 code 沒有 logic 決定輸出甚麼語言的文字。接下來就是完整的 <code>EtaPresenterTest</code>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=nd>@RunWith</span><span class=p>(</span><span class=n>ParameterizedRobolectricTestRunner</span><span class=o>::</span><span class=k>class</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>EtaPresenterTest</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>val</span> <span class=py>result</span><span class=p>:</span> <span class=n>EtaFailResult</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>val</span> <span class=py>expectedString</span><span class=p>:</span> <span class=n>String</span><span class=p>?,</span>
</span></span><span class=line><span class=cl>    <span class=nd>@StringRes</span> <span class=k>private</span> <span class=k>val</span> <span class=py>expectedResourceId</span><span class=p>:</span> <span class=n>Int</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>lateinit</span> <span class=k>var</span> <span class=py>presenter</span><span class=p>:</span> <span class=n>EtaPresenter</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>lateinit</span> <span class=k>var</span> <span class=py>res</span><span class=p>:</span> <span class=n>Resources</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Before</span>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>setUp</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>presenter</span> <span class=p>=</span> <span class=n>EtaPresenter</span><span class=p>(</span><span class=nc>ApplicationProvider</span><span class=p>.</span><span class=n>getApplicationContext</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=n>res</span> <span class=p>=</span> <span class=nc>ApplicationProvider</span><span class=p>.</span><span class=n>getApplicationContext</span><span class=p>&lt;</span><span class=n>Context</span><span class=p>&gt;().</span><span class=n>resources</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>mapErrorMessage</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>expectedString</span> <span class=o>==</span> <span class=k>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>expectThat</span><span class=p>(</span><span class=n>presenter</span><span class=p>.</span><span class=n>mapErrorMessage</span><span class=p>(</span><span class=n>result</span><span class=p>)).</span><span class=n>isEqualTo</span><span class=p>(</span><span class=n>res</span><span class=p>.</span><span class=n>getString</span><span class=p>(</span><span class=n>expectedResourceId</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>expectThat</span><span class=p>(</span><span class=n>presenter</span><span class=p>.</span><span class=n>mapErrorMessage</span><span class=p>(</span><span class=n>result</span><span class=p>)).</span><span class=n>isEqualTo</span><span class=p>(</span><span class=n>expectedString</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>companion</span> <span class=k>object</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nd>@JvmStatic</span>
</span></span><span class=line><span class=cl>        <span class=nd>@get</span><span class=p>:</span><span class=nc>ParameterizedRobolectricTestRunner</span><span class=p>.</span><span class=n>Parameters</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=py>data</span> <span class=p>=</span> <span class=n>listOf</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>arrayOf</span><span class=p>(</span><span class=nc>EtaResult</span><span class=p>.</span><span class=n>Delay</span><span class=p>,</span> <span class=k>null</span><span class=p>,</span> <span class=nc>R</span><span class=p>.</span><span class=n>string</span><span class=p>.</span><span class=n>delay</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>arrayOf</span><span class=p>(</span><span class=nc>EtaResult</span><span class=p>.</span><span class=n>Incident</span><span class=p>(</span><span class=s2>&#34;Incident&#34;</span><span class=p>,</span> <span class=s2>&#34;https://example.com&#34;</span><span class=p>),</span> <span class=s2>&#34;Incident&#34;</span><span class=p>,</span> <span class=m>0</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>arrayOf</span><span class=p>(</span><span class=nc>EtaResult</span><span class=p>.</span><span class=n>TooManyRequests</span><span class=p>,</span> <span class=k>null</span><span class=p>,</span> <span class=nc>R</span><span class=p>.</span><span class=n>string</span><span class=p>.</span><span class=n>error</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>arrayOf</span><span class=p>(</span><span class=nc>EtaResult</span><span class=p>.</span><span class=n>InternalServerError</span><span class=p>,</span> <span class=k>null</span><span class=p>,</span> <span class=nc>R</span><span class=p>.</span><span class=n>string</span><span class=p>.</span><span class=n>error</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>arrayOf</span><span class=p>(</span><span class=nc>EtaResult</span><span class=p>.</span><span class=n>Error</span><span class=p>(</span><span class=n>RuntimeException</span><span class=p>(</span><span class=s2>&#34;Testing&#34;</span><span class=p>)),</span> <span class=k>null</span><span class=p>,</span> <span class=nc>R</span><span class=p>.</span><span class=n>string</span><span class=p>.</span><span class=n>error</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>先看 class 的 <code>@RunWith</code>，如果是單純的 JUnit 4 parameterized test 是應該用 JUnit 的 <code>Parameterized</code> runner。但因為我們要用 Robolectric 所以要改用 <code>ParameterizedRobolectricTestRunner</code>。之前用的那個 <code>AndroidJUnit4</code> runner 它有封裝 Robolectric runner，但不支援 parameterized test，惟有直接用 Robolectric 提供的 runner。</p><p>之後看看最底的 companion object，同樣因為要用 <code>ParameterizedRobolectricTestRunner</code>，所以要用對應的 <code>@get:ParameterizedRobolectricTestRunner.Parameters</code> 來標註提供予 test method 的參數。前面加了 <code>@get</code> 是因為我們要針對 property getter 來 annotation（因為 JUnit 是 Java 的東西，不會看懂 <code>val</code>，JUnit 本身的 <code>@Parameters</code> 是用來標註在 static method，所以要放在 companion object 內另加 <code>@JvmStatic</code>）。由於 <code>EtaFailResult</code> 有五款，我們在 <code>listOf</code> 就針對這五款情況提供了五組參數，每組都用 <code>arrayOf</code> 包住，它們分別對應 constructor 的三個參數。</p><p>之後跳到 <code>mapErrorMessage</code> 這個 test method。我們會在 test method 用到 constructor 的三個參數來完成 assertion。由於我不想日後改了 string resource 的文字後 test 會報錯，所以在使用 string resource 的情景就在參數交了 string resource ID，但缺點是 assertion 部分就像謄文般抄一次它背後的 code 一次。你可以視乎情況決定在測試時即場用 string resource ID 取得文字來做做比對還是在 test case 寫死它輸出的文字做比對。</p><p>順帶一提，如果想令 test case 的名不是 <code>mapErrorMessage[0]</code>、<code>mapErrorMessage[1]</code> 之類的話，可以在 <code>@get:ParameterizedRobolectricTestRunner.Parameters</code> 或者 <code>@get:Parameters</code> 加上 <code>name</code> 參數。例如 <code>@get:Parameters(name = "{0}")</code> 就是第一個參數的值 <code>toString</code> 後的文字，換做 <code>{1}</code> 就是第二個參數，如此類推。預設是用 <code>{index}</code> 即是參數序號。</p><h2 id=etaviewmodel><code>EtaViewModel</code><a hidden class=anchor aria-hidden=true href=#etaviewmodel>#</a></h2><p>現在來到最後一個 ViewModel，最重要的部分當然是 <code>etaList</code>。由於 <code>EtaViewModel</code> 的 constructor 有 Java Time 的 <code>Clock</code>，為方便之後的測試，我們會用 <a href=https://www.threeten.org/threeten-extra/>ThreeTen-Extra</a> 提供的 <code>MutableClock</code>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-groovy data-lang=groovy><span class=line><span class=cl><span class=n>testImplementation</span> <span class=s2>&#34;org.threeten:threeten-extra:$threeTenExtraVersion&#34;</span>
</span></span></code></pre></div><p>如果不需要在測試中途改變 <code>Clock</code> 輸出的時間，可以直接用 Java Time 的 <code>Clock.fixed()</code>，毋須另外安裝 ThreeTen-Extra。</p><p>但在寫跟 <code>etaList</code> 相關的 test case 之前我們先來測試一些簡單的東西。首先準備好 test class 的基本通用部分：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>private</span> <span class=k>val</span> <span class=py>DEFAULT</span><span class=n>_LOCAL_DATE</span> <span class=p>=</span> <span class=nc>LocalDate</span><span class=p>.</span><span class=n>of</span><span class=p>(</span><span class=m>2021</span><span class=p>,</span> <span class=m>9</span><span class=p>,</span> <span class=m>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>private</span> <span class=k>val</span> <span class=py>DEFAULT</span><span class=n>_LOCAL_TIME</span> <span class=p>=</span> <span class=nc>LocalTime</span><span class=p>.</span><span class=n>of</span><span class=p>(</span><span class=m>13</span><span class=p>,</span> <span class=m>0</span><span class=p>,</span> <span class=m>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>private</span> <span class=k>val</span> <span class=py>DEFAULT</span><span class=n>_INSTANT</span> <span class=p>=</span>
</span></span><span class=line><span class=cl>    <span class=nc>ZonedDateTime</span><span class=p>.</span><span class=n>of</span><span class=p>(</span><span class=n>DEFAULT_LOCAL_DATE</span><span class=p>,</span> <span class=n>DEFAULT_LOCAL_TIME</span><span class=p>,</span> <span class=n>DEFAULT_TIMEZONE</span><span class=p>).</span><span class=n>toInstant</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@RunWith</span><span class=p>(</span><span class=n>AndroidJUnit4</span><span class=o>::</span><span class=k>class</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>EtaViewModelTest</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@get</span><span class=p>:</span><span class=n>Rule</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>coroutineScope</span> <span class=p>=</span> <span class=n>MainCoroutineScopeRule</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@MockK</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>lateinit</span> <span class=k>var</span> <span class=py>getEtaUseCase</span><span class=p>:</span> <span class=n>GetEtaUseCase</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>lateinit</span> <span class=k>var</span> <span class=py>clock</span><span class=p>:</span> <span class=n>MutableClock</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Before</span>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>setUp</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nc>MockKAnnotations</span><span class=p>.</span><span class=k>init</span><span class=p>(</span><span class=k>this</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>clock</span> <span class=p>=</span> <span class=nc>MutableClock</span><span class=p>.</span><span class=n>of</span><span class=p>(</span><span class=n>DEFAULT_INSTANT</span><span class=p>,</span> <span class=n>DEFAULT_TIMEZONE</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>雖然 <code>EtaViewModel</code> 沒有直接用到 Android SDK 的 class，但因為 constructor 的 <code>SavedStateHandle</code> 背後有用到 <code>Bundle</code> 所以還是要加上 <code>@RunWith(AndroidJUnit4::class)</code>。在 <code>setUp</code> 我們先設定 <code>MutableClock</code> 的時間做 2021 年 9 月 1 日下午 1 時正。這次特意用 <code>MutableClock</code> 是因為我們那個定時更新功能需要用 <code>Clock</code> 取得當前時間來決定下次 call API 的時間，如果時間是在 call <code>EtaViewModel</code> constructor 那時寫死的話就不能測試那個位置。這亦都是我們用 dependency injection library inject <code>Clock</code> 而不是用 <code>System.currentTimeMillis</code> 之類的方式取得當前時間的原因。</p><hr><p>我們先來寫一些簡單的 test case：<code>line</code> 跟 <code>station</code>，這兩個 <code>StateFlow</code> 就是供 data binding 的 <code>MaterialToolbar</code> 顯示班次所屬於的路綫和車站。這兩個 <code>StateFlow</code> 的值其實是來自 <code>SavedStateHandle</code>（即是 <code>Fragment</code> 的 <code>arguments</code>），我們需要在 <code>EtaViewModel</code> 的 constructor 提供帶有這兩個參數的 <code>SavedStateHandle</code> 然後檢查這兩個 <code>StateFlow</code> 的值是不是跟我們放在 <code>SavedStateHandle</code> 的一樣。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=nd>@Test</span>
</span></span><span class=line><span class=cl><span class=k>fun</span> <span class=nf>line</span><span class=p>()</span> <span class=p>=</span> <span class=n>coroutineScope</span><span class=p>.</span><span class=n>runBlockingTest</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>viewModel</span> <span class=p>=</span> <span class=n>EtaViewModel</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>savedStateHandle</span> <span class=p>=</span> <span class=n>SavedStateHandle</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>mapOf</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;line&#34;</span> <span class=n>to</span> <span class=nc>Line</span><span class=p>.</span><span class=n>TCL</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;station&#34;</span> <span class=n>to</span> <span class=nc>Station</span><span class=p>.</span><span class=n>TUC</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>clock</span> <span class=p>=</span> <span class=n>clock</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>getEta</span> <span class=p>=</span> <span class=n>getEtaUseCase</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>viewModel</span><span class=p>.</span><span class=n>line</span><span class=p>.</span><span class=n>test</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>expectThat</span><span class=p>(</span><span class=n>awaitItem</span><span class=p>()).</span><span class=n>isEqualTo</span><span class=p>(</span><span class=nc>Line</span><span class=p>.</span><span class=n>TCL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>expectNoEvents</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@Test</span>
</span></span><span class=line><span class=cl><span class=k>fun</span> <span class=nf>station</span><span class=p>()</span> <span class=p>=</span> <span class=n>coroutineScope</span><span class=p>.</span><span class=n>runBlockingTest</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>     <span class=k>val</span> <span class=py>viewModel</span> <span class=p>=</span> <span class=n>EtaViewModel</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>savedStateHandle</span> <span class=p>=</span> <span class=n>SavedStateHandle</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>mapOf</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;line&#34;</span> <span class=n>to</span> <span class=nc>Line</span><span class=p>.</span><span class=n>TCL</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;station&#34;</span> <span class=n>to</span> <span class=nc>Station</span><span class=p>.</span><span class=n>TUC</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>clock</span> <span class=p>=</span> <span class=n>clock</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>getEta</span> <span class=p>=</span> <span class=n>getEtaUseCase</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>viewModel</span><span class=p>.</span><span class=n>station</span><span class=p>.</span><span class=n>test</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>expectThat</span><span class=p>(</span><span class=n>awaitItem</span><span class=p>()).</span><span class=n>isEqualTo</span><span class=p>(</span><span class=nc>Station</span><span class=p>.</span><span class=n>TUC</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>expectNoEvents</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>兩個 test case 的內容基本上是一樣，首先是要建構 <code>EtaViewModel</code>。跟以前的 test case 寫法不同，我們不會在 <code>@Before</code> 預先建構 <code>EtaViewModel</code>，這是因為不同的 test case 需要傳入不同的 constructor 參數（其實是 <code>SavedStateHandle</code> 會因應 test case 不同）。之後就是用 <a href=https://github.com/cashapp/turbine>Turbine</a> collect 我們要檢查的 <code>Flow</code>。由於路綫和車站在整頁的 lifecycle 都不會再改變，所以當初我們寫的時候就直接把 <code>MutableStateFlow</code> cast 成 <code>StateFlow</code>，並且在 <code>MutableStateFlow</code> 以 <code>SavedStateHandle</code> 取得的 argument 值作為它的初始值（下面就是它們的定義）。所以這兩個 <code>StateFlow</code> 只會發射一個值出去。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>val</span> <span class=py>line</span><span class=p>:</span> <span class=n>StateFlow</span><span class=p>&lt;</span><span class=n>Line</span><span class=p>&gt;</span> <span class=p>=</span> <span class=n>MutableStateFlow</span><span class=p>(</span><span class=n>args</span><span class=p>.</span><span class=n>line</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>val</span> <span class=py>station</span><span class=p>:</span> <span class=n>StateFlow</span><span class=p>&lt;</span><span class=n>Station</span><span class=p>&gt;</span> <span class=p>=</span> <span class=n>MutableStateFlow</span><span class=p>(</span><span class=n>args</span><span class=p>.</span><span class=n>station</span><span class=p>)</span>
</span></span></code></pre></div><p>我們知道這兩個 <code>StateFlow</code> 只會發射一個值，那我們在測試時只需要 call 一次 <code>awaitItem()</code> 就可以了，當 assert 完第一個值後就可以 call <code>expectNoEvents()</code> 告訴 Turbine 之後應該不會再有新的值出現。</p><p>之後我們看看另一個 test case <code>navigateBack</code>。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=nd>@Test</span>
</span></span><span class=line><span class=cl><span class=k>fun</span> <span class=nf>navigateBack</span><span class=p>()</span> <span class=p>=</span> <span class=n>coroutineScope</span><span class=p>.</span><span class=n>runBlockingTest</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>viewModel</span> <span class=p>=</span> <span class=n>EtaViewModel</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>savedStateHandle</span> <span class=p>=</span> <span class=n>SavedStateHandle</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>mapOf</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;line&#34;</span> <span class=n>to</span> <span class=nc>Line</span><span class=p>.</span><span class=n>TCL</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;station&#34;</span> <span class=n>to</span> <span class=nc>Station</span><span class=p>.</span><span class=n>TUC</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>clock</span> <span class=p>=</span> <span class=n>clock</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>getEta</span> <span class=p>=</span> <span class=n>getEtaUseCase</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>viewModel</span><span class=p>.</span><span class=n>navigateBack</span><span class=p>.</span><span class=n>test</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>viewModel</span><span class=p>.</span><span class=n>goBack</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>awaitEvent</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>expectNoEvents</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>這個又是比較簡單的，就是測試 call 了 <code>viewModel.goBack()</code> 後 <code>viewModel.navigateBack</code> 這個 <code>Flow</code> 有沒有發射訊號提示 <code>EtaFragment</code> 轉頁。由於這個 <code>Flow</code> 的 type 是 <code>Unit</code>，我們就不用 assert 它的值，只需要讓它消耗掉就可以了。</p><p>接下來我們會寫 <code>viewIncidentDetail</code> 的測試。由於它是看結果是不是 <code>EtaResult.Incident</code> 才向 <code>viewIncidentDetail</code> 發射要瀏覽的網址，所以我們先試試當 <code>getEtaUseCase</code> 輸出 <code>EtaResult.Incident</code> 的情況：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=nd>@Test</span>
</span></span><span class=line><span class=cl><span class=k>fun</span> <span class=nf>`viewIncidentDetail incident`</span><span class=p>()</span> <span class=p>=</span> <span class=n>coroutineScope</span><span class=p>.</span><span class=n>runBlockingTest</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>coEvery</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>getEtaUseCase</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=nc>Language</span><span class=p>.</span><span class=n>ENGLISH</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nc>Line</span><span class=p>.</span><span class=n>TCL</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nc>Station</span><span class=p>.</span><span class=n>TUC</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nc>GetEtaUseCase</span><span class=p>.</span><span class=nc>SortBy</span><span class=p>.</span><span class=n>DIRECTION</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=n>returns</span> <span class=nc>EtaResult</span><span class=p>.</span><span class=n>Incident</span><span class=p>(</span><span class=s2>&#34;Message&#34;</span><span class=p>,</span> <span class=s2>&#34;https://example.com&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>viewModel</span> <span class=p>=</span> <span class=n>EtaViewModel</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>savedStateHandle</span> <span class=p>=</span> <span class=n>SavedStateHandle</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>mapOf</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;line&#34;</span> <span class=n>to</span> <span class=nc>Line</span><span class=p>.</span><span class=n>TCL</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;station&#34;</span> <span class=n>to</span> <span class=nc>Station</span><span class=p>.</span><span class=n>TUC</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>clock</span> <span class=p>=</span> <span class=n>clock</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>getEta</span> <span class=p>=</span> <span class=n>getEtaUseCase</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>viewModel</span><span class=p>.</span><span class=n>etaList</span><span class=p>.</span><span class=n>test</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>viewModel</span><span class=p>.</span><span class=n>viewIncidentDetail</span><span class=p>.</span><span class=n>test</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>viewModel</span><span class=p>.</span><span class=n>startAutoRefresh</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>viewModel</span><span class=p>.</span><span class=n>viewIncidentDetail</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>expectThat</span><span class=p>(</span><span class=n>awaitItem</span><span class=p>()).</span><span class=n>isEqualTo</span><span class=p>(</span><span class=s2>&#34;https://example.com&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>expectNoEvents</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>cancelAndIgnoreRemainingEvents</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>因為在 call 了 <code>EtaViewModel.startAutoRefresh</code> 才會 call use case，我們在 <code>viewModel.viewIncidentDetail.test</code> 內第一句就是 <code>viewModel.startAutoRefresh()</code>。在寫的時候我發現 <code>viewModel.viewIncidentDetail.test</code> 會有怪問題出現。原來是因為我們之前寫 <code>etaResult</code> 是 <code>StateFlow&lt;CachedResult></code>。如果外圍再包多一層 <code>viewModel.etaList.test</code> 的話才會正常，這是因為 <code>StateFlow</code> 是 cold flow。意思是如果沒有其他人 collect 這個 flow 的話，那在 <code>etaResult</code> 寫的一大串 <code>flatMapLatest</code> 和 <code>scan</code> 是不會執行。但 <code>etaResult</code> 是 private，所以我找了 <code>etaList</code> 來 collect（因為它的上游是 <code>etaResult</code>），這樣才不會卡死在 <code>Loading</code>。在實際執行其實看不到這個問題，因為 layout XML 的 data binding 會 collect 那一大堆跟 <code>etaResult</code> 相關的 <code>StateFlow</code>，所以 <code>etaResult</code> 內的東西一定會被執行。但感覺上還是不好吧，所以我們應該把 <code>etaResult</code> 改成即使沒有人 collect 仍會執行（即是 hot flow）。<code>SharedFlow</code> 就是 hot flow 的一種，以下是節錄自 <code>SharedFlow</code> 的 KDoc：</p><blockquote><p>A <em>hot</em> Flow that shares emitted values among all its collectors in a broadcast fashion, so that all collectors get all emitted values. A shared flow is called hot because its active instance exists independently of the presence of collectors. This is opposed to a regular <code>Flow</code>, such as defined by the <code>flow { ... }</code> function, which is cold and is started separately for each collector.</p></blockquote><p>有一樣東西要留意是：如果連續有兩個相同的值發送到 <code>SharedFlow</code> 的話，那麼兩個值都能交到下游；但 <code>StateFlow</code> 就會吃掉第二個值，直至下一個值跟先前的值不相同才會交到下游。不過在我們這個情況因為下游都是 <code>StateFlow</code>，即使上游發射重覆的值對那些 <code>StateFlow</code> 的下游都沒有分別。</p><p>要改成 <code>SharedFlow</code>，只需把原先的 <code>stateIn</code> 換成 <code>shareIn</code>。 <code>replay</code> 設定 <code>1</code> 是為了其他人一開始訂閱時就能馬上收到 <code>SharedFlow</code> 在訂閱前所發射的最後一個值，這樣就不用讓下游在訂閱時乾等到下一次更新才能收到 <code>CachedResult</code>。</p><p>改了 <code>etaResult</code> 後還是要改其他地方，因為 <code>SharedFlow</code> 是沒有 <code>value</code> 這個 property，要取新最新的值就要用 <code>first()</code>。所以我們需要一併修改 <code>startAutoRefresh</code> 和 <code>viewIncidentDetail</code>。我們亦順帶修正 <code>viewIncidentDetail</code> 只看 <code>currentResult</code> 的問題：如果當前是載入中但畫面仍是顯示事故畫面的話那按下「View detail」沒有反應。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>private</span> <span class=k>val</span> <span class=py>etaResult</span><span class=p>:</span> <span class=n>SharedFlow</span><span class=p>&lt;</span><span class=n>CachedResult</span><span class=p>&gt;</span> <span class=p>=</span> <span class=n>triggerRefresh</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>consumeAsFlow</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>flatMapLatest</span> <span class=p>{</span> <span class=cm>/* 略 */</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>scan</span><span class=p>(</span><span class=n>CachedResult</span><span class=p>())</span> <span class=p>{</span> <span class=n>acc</span><span class=p>,</span> <span class=n>currentValue</span> <span class=o>-&gt;</span> <span class=cm>/* 略 */</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>shareIn</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>scope</span> <span class=p>=</span> <span class=n>viewModelScope</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>started</span> <span class=p>=</span> <span class=nc>SharingStarted</span><span class=p>.</span><span class=n>WhileSubscribed</span><span class=p>(</span><span class=n>STATE_FLOW_STOP_TIMEOUT_MILLIS</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>replay</span> <span class=p>=</span> <span class=m>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>fun</span> <span class=nf>startAutoRefresh</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>autoRefreshScope</span><span class=p>.</span><span class=n>launch</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=py>delayDuration</span> <span class=p>=</span>
</span></span><span class=line><span class=cl>            <span class=nc>JavaDuration</span><span class=p>.</span><span class=n>between</span><span class=p>(</span><span class=n>etaResult</span><span class=p>.</span><span class=n>first</span><span class=p>().</span><span class=n>currentResult</span><span class=p>.</span><span class=n>updatedAt</span><span class=p>,</span> <span class=n>clock</span><span class=p>.</span><span class=n>instant</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 略
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>fun</span> <span class=nf>viewIncidentDetail</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>viewModelScope</span><span class=p>.</span><span class=n>launch</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=py>result</span> <span class=p>=</span> <span class=n>etaResult</span><span class=p>.</span><span class=n>first</span><span class=p>().</span><span class=n>lastFailResult</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>result</span> <span class=o>!is</span> <span class=nc>EtaResult</span><span class=p>.</span><span class=n>Incident</span><span class=p>)</span> <span class=k>return</span><span class=nd>@launch</span>
</span></span><span class=line><span class=cl>        <span class=n>_viewIncidentDetail</span><span class=p>.</span><span class=n>send</span><span class=p>(</span><span class=n>result</span><span class=p>.</span><span class=n>url</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>那剛才的 <code>viewIncidentDetail incident</code> test case 我們就可以拿掉 <code>viewModel.etaList.test</code> 的部分。</p><p>我們再試試當 <code>lastFailResult</code> 不是 <code>EtaResult.Incident</code> 的情況，為了令 test case 寫得短，我用了 <code>EtaResult.Delay</code> 來試。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=nd>@Test</span>
</span></span><span class=line><span class=cl><span class=k>fun</span> <span class=nf>`viewIncidentDetail delay`</span><span class=p>()</span> <span class=p>=</span> <span class=n>coroutineScope</span><span class=p>.</span><span class=n>runBlockingTest</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>coEvery</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>getEtaUseCase</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=nc>Language</span><span class=p>.</span><span class=n>ENGLISH</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nc>Line</span><span class=p>.</span><span class=n>TCL</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nc>Station</span><span class=p>.</span><span class=n>TUC</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nc>GetEtaUseCase</span><span class=p>.</span><span class=nc>SortBy</span><span class=p>.</span><span class=n>DIRECTION</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=n>returns</span> <span class=nc>EtaResult</span><span class=p>.</span><span class=n>Delay</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>viewModel</span> <span class=p>=</span> <span class=n>EtaViewModel</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>savedStateHandle</span> <span class=p>=</span> <span class=n>SavedStateHandle</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>mapOf</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;line&#34;</span> <span class=n>to</span> <span class=nc>Line</span><span class=p>.</span><span class=n>TCL</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;station&#34;</span> <span class=n>to</span> <span class=nc>Station</span><span class=p>.</span><span class=n>TUC</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>clock</span> <span class=p>=</span> <span class=n>clock</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>getEta</span> <span class=p>=</span> <span class=n>getEtaUseCase</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>viewModel</span><span class=p>.</span><span class=n>viewIncidentDetail</span><span class=p>.</span><span class=n>test</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>viewModel</span><span class=p>.</span><span class=n>startAutoRefresh</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>viewModel</span><span class=p>.</span><span class=n>viewIncidentDetail</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>expectNoEvents</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>這次我們期望 <code>viewIncidentDetail</code> 這個 <code>Flow</code> 不會發射訊號，所以用了 <code>expectNoEvents()</code>。</p><p>在本篇結束前我們再寫多一個 test case <code>showLoading</code>，它就是用來控制是否顯示 <code>CircularProgressIndicator</code>。<code>CircularProgressIndicator</code> 會在載入完成後消失，我們會檢查它是不是首先顯示然後轉為不顯示。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=nd>@Test</span>
</span></span><span class=line><span class=cl><span class=k>fun</span> <span class=nf>showLoading</span><span class=p>()</span> <span class=p>=</span> <span class=n>coroutineScope</span><span class=p>.</span><span class=n>runBlockingTest</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>coEvery</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>getEtaUseCase</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=nc>Language</span><span class=p>.</span><span class=n>ENGLISH</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nc>Line</span><span class=p>.</span><span class=n>TCL</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nc>Station</span><span class=p>.</span><span class=n>TUC</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nc>GetEtaUseCase</span><span class=p>.</span><span class=nc>SortBy</span><span class=p>.</span><span class=n>DIRECTION</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=n>returns</span> <span class=nc>EtaResult</span><span class=p>.</span><span class=n>InternalServerError</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>viewModel</span> <span class=p>=</span> <span class=n>EtaViewModel</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>savedStateHandle</span> <span class=p>=</span> <span class=n>SavedStateHandle</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>mapOf</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;line&#34;</span> <span class=n>to</span> <span class=nc>Line</span><span class=p>.</span><span class=n>TCL</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;station&#34;</span> <span class=n>to</span> <span class=nc>Station</span><span class=p>.</span><span class=n>TUC</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>clock</span> <span class=p>=</span> <span class=n>clock</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>getEta</span> <span class=p>=</span> <span class=n>getEtaUseCase</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>viewModel</span><span class=p>.</span><span class=n>showLoading</span><span class=p>.</span><span class=n>test</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>viewModel</span><span class=p>.</span><span class=n>startAutoRefresh</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>expectThat</span><span class=p>(</span><span class=n>awaitItem</span><span class=p>()).</span><span class=n>isEqualTo</span><span class=p>(</span><span class=k>true</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>expectThat</span><span class=p>(</span><span class=n>awaitItem</span><span class=p>()).</span><span class=n>isEqualTo</span><span class=p>(</span><span class=k>false</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>expectNoEvents</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=小結>小結<a hidden class=anchor aria-hidden=true href=#小結>#</a></h2><p>現在我們已經寫了幾個 test case，了解到如何測試 <code>Flow</code>，順帶介紹了 <code>SharedFlow</code>。另外亦在寫測試時發現先前寫的 code 有 bug，這其實是正常的，因為靠實機人手體驗可能會看不到一些問題，換了另一個角度又會看得到之前不為意的問題。下一篇我們會寫一些跟時間相關的 test case，完整的 code 可以在 <a href=https://github.com/ericksli/eta-demo/tree/main/app/src/test/java/net/swiftzer/etademo/presentation/eta>GitHub repo</a> 找到。</p><h2 id=參考>參考<a hidden class=anchor aria-hidden=true href=#參考>#</a></h2><ul><li><a href="https://www.youtube.com/watch?v=KMb0Fs8rCRs">Testing Coroutines on Android (Android Dev Summit &lsquo;19)</a></li><li><a href="https://www.youtube.com/watch?v=hMFwNLVK8HU">KotlinConf 2019: Testing with Coroutines by Sean McQuillan</a></li><li><a href=https://developer.android.com/kotlin/flow/stateflow-and-sharedflow>StateFlow and SharedFlow</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://eric.swiftzer.net/tags/2021-ithome-%E9%90%B5%E4%BA%BA%E8%B3%BD/>2021 iThome 鐵人賽</a></li><li><a href=https://eric.swiftzer.net/tags/android/>Android</a></li></ul><nav class=paginav><a class=prev href=https://eric.swiftzer.net/2021/10/2021-ithome-ironman-28-eta-screen-testing-2/><span class=title>« 上一頁</span><br><span>2021 iThome 鐵人賽 Day 28：ETA screen testing (2)</span></a>
<a class=next href=https://eric.swiftzer.net/2021/10/2021-ithome-ironman-26-station-list-screen-testing/><span class=title>下一頁 »</span><br><span>2021 iThome 鐵人賽 Day 26：Station list screen testing</span></a></nav></footer><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//efilm.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></article></main><footer class=footer><span>&copy; 2024 <a href=https://eric.swiftzer.net/>EricLog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>