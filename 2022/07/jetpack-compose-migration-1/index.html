<!doctype html><html lang=zh-tw dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Jetpack Compose 遷移 (1) | EricLog</title>
<meta name=keywords content="Android"><meta name=description content="近幾個月斷斷續續替 MetroRide 的界面由傳統 view system（即是 layout XML）轉為 Jetpack Compose，順帶補上去年參加 iThome 鐵人賽時用來做示範的重鐵抵站時間功能。"><meta name=author content><link rel=canonical href=https://eric.swiftzer.net/2022/07/jetpack-compose-migration-1/><link crossorigin=anonymous href=/assets/css/stylesheet.48ed1b8bd3873bc86534e1a6b0ba618b6c80d8a975cf0cf1f1835c2b89c5c5b0.css integrity="sha256-SO0bi9OHO8hlNOGmsLphi2yA2Kl1zwzx8YNcK4nFxbA=" rel="preload stylesheet" as=style><link rel=icon href=https://eric.swiftzer.net/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://eric.swiftzer.net/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://eric.swiftzer.net/favicon-32x32.png><link rel=apple-touch-icon href=https://eric.swiftzer.net/apple-touch-icon.png><link rel=mask-icon href=https://eric.swiftzer.net/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh-tw href=https://eric.swiftzer.net/2022/07/jetpack-compose-migration-1/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=JetBrains+Mono:wght@300&display=swap" rel=stylesheet><script async src="https://www.googletagmanager.com/gtag/js?id=G-D93F946T73"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-D93F946T73",{anonymize_ip:!1})}</script><meta property="og:title" content="Jetpack Compose 遷移 (1)"><meta property="og:description" content="近幾個月斷斷續續替 MetroRide 的界面由傳統 view system（即是 layout XML）轉為 Jetpack Compose，順帶補上去年參加 iThome 鐵人賽時用來做示範的重鐵抵站時間功能。"><meta property="og:type" content="article"><meta property="og:url" content="https://eric.swiftzer.net/2022/07/jetpack-compose-migration-1/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-07-24T14:06:00+08:00"><meta property="article:modified_time" content="2022-07-24T14:06:00+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Jetpack Compose 遷移 (1)"><meta name=twitter:description content="近幾個月斷斷續續替 MetroRide 的界面由傳統 view system（即是 layout XML）轉為 Jetpack Compose，順帶補上去年參加 iThome 鐵人賽時用來做示範的重鐵抵站時間功能。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://eric.swiftzer.net/posts/"},{"@type":"ListItem","position":2,"name":"Jetpack Compose 遷移 (1)","item":"https://eric.swiftzer.net/2022/07/jetpack-compose-migration-1/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Jetpack Compose 遷移 (1)","name":"Jetpack Compose 遷移 (1)","description":"近幾個月斷斷續續替 MetroRide 的界面由傳統 view system（即是 layout XML）轉為 Jetpack Compose，順帶補上去年參加 iThome 鐵人賽時用來做示範的重鐵抵站時間功能。","keywords":["Android"],"articleBody":"近幾個月斷斷續續替 MetroRide 的界面由傳統 view system（即是 layout XML）轉為 Jetpack Compose，順帶補上去年參加 iThome 鐵人賽時用來做示範的重鐵抵站時間功能。昨天新版 app 上架了就來分享一下遷移過程。其實這個 app 在之前的版本有把其中一頁靜態的頁面（延誤定義）改用 Compose，那時是在 Fragment 內的 onCreateView 加入 setContent 顯示 Compose 內容。由於那時只是做排版，沒有遇到大問題。之後開始慢慢轉用 Compose 才遇到問題。\n遷移方式 由於我本身打算一次過把全個 app 的 UI 都換成 Compose，所以除了先前的延誤定義頁之外我就沒有再特別去把原有的 Fragment 淘空 layout XML，而是直接造一個全新的 MainActivity 來顯示全新製造的 Compose UI，舊有的 layout XML 和 Fragment 就盡量不去改，方便遷移時能拿來對照參考。當全部頁面都轉成 Compose 後就會刪除舊的 Fragment 和 layout XML。另外，這個 app 本身是 single Activity app，所以只有單一 Activity，遷移後亦都會維持這個做法。\n除了大改的列車抵站時間部分，原有頁面的 ViewModel 和背後的 code 都不會大改，因為這次目的是想轉用 Compose 和補元列車抵站時間功能。現有 code 在 ViewModel 和 UI 之間的通訊方式是以 LiveData 和 ViewModel 的 function，再加上使用 databinding。在遷移現有頁面時 ViewModel 要改動的地方不算太多，而背後拿資料的部分都不用改。\n狀態 Compose 和傳統 view system 其中一個明顯差別就是狀態處理。Compose 特別強調狀態，明確地分別出 composable function 的參數、remember 和 rememberSavable。remember 就是在 Compose rerender (recompose) 時能保存的 state，而 rememberSavable 就更進一步連 process 被 kill 後重開 app 都能保存 state。即是跟 savedInstanceState 一樣，只是重新包裝方便將 Compose 帶去非 Android 平台用。\n官方建議盡量寫 stateless 的 composable function，把 state 都推去上層管理（正式叫法是 state hoisting），你可以把 state 推到上去 ViewModel，即是跟傳統 Activity/Fragment 般一個頁面配一個 ViewModel 來管理 state。但不代表要把所有 state 都推到去 ViewModel 管理。一般建議的做法是比較關 UI 事的 state 就保留在 composable function 內放置（靠 remember 和 rememberSavable），例如 scroll、animation 的 state。而偏向資料性的 state 就交由 ViewModel 管理。目前我都在摸索除了那些很明顯的 scroll、animation 之類的 UI state 外，還有甚麼 state 是應該放去 Compose 那邊。以顯示列車班次為例，UI 要顯示班次抵站的倒數時間。究竟應該把定時計算倒數分鐘的 code 放去非 Compose 的地方，然後經 ViewModel 的 StateFlow 傳去要顯示分鐘的 composable function 讓它直接拿那個預先計算好的數字顯示出來還是 ViewModel 只向 composable function 提供絕對時間（Instant 之類），composable function 會定時計算倒數分鐘並顯示出來（會有 side-effect）。這次我選了前者，但下次再選的話可能會選後者。我沒有太仔細看官方的 sample project，但似乎因為現在 UI 的部分可以直接寫 Kotlin code，不像以往 XML layout 般難把 Java/Kotlin code 塞入去（databinding 都是 Java syntax 而且不能分行寫），現在可以把偏 UI 相關的 code 都放去 composable function 內。但因為這次沒有寫 UI test，反而是要刪走以前針對傳統 view system 寫的 UI test，所以還未能拿捏到應不應該把這類的 logic 下放到 composable function 內。\n這次因為遷移時還保留着現有的 Fragment 和 layout XML，所以不太想修改現有的 ViewModel 以免動到舊有的 code。我之前在舊公司試過新頁面用 Compose 寫，在寫 code 時其實是會自然地傾向把 composable function 寫到 stateless 和減少 logic，最好連 UI 顯示式樣都由非 Compose 的地方計算好。以 WhatsApp 的訊息列表為例（見下圖），會以 sealed interface/class 的形式向 UI 表示每間房間的最新訊息欄的式樣（自己發送單剔、自己發送雙剔、別人發送、房間沒有訊息等等），然後 composable function 放個 when 來實際控制 UI 顯示式樣（例如顏色、icon），而不是在 composable function 內拿到個未處理的 object 再在 composable function 內寫一堆 code 去決定顯示那款最新訊息式樣。同時亦會慢慢傾向造一個 StateFlow 去表達整頁的 state。如果要用 data class 並以 immutable 的方式表達整頁的 state 的話，在複雜的環境下可能需要借助 kotlinx.collections.immutable 和 Arrow Optics 之類的 library 來生成新的 state object，因為那些 state 可能放到很深入，用 data class copy function 不夠方便，會很累贅。\nWhatsApp 最新訊息欄 另一樣應該都算關 state 事的地方是 Compose 對那些要費時完成的動作（例如 scroll 去某個位置、彈出 bottom sheet 之類）的 function 都定義為 suspending function。以往在傳統 view system 可能只是 call 完 function 就算，但 Compose 就要你開一個 coroutine scope 才能 call。\nNavigation 由於是另起爐灶，Navigation 我沒有做甚麼遷移，要做的東西就是重新做過一個新的 NavHost。如果是分階段遷移的話一般都是叫你用 Fragment 來顯示 composable function 並沿用現有的 XML 式 navigation graph 直頭全部頁面都換成 Compose 才轉用 Compose 版 Navigation。Compose 版 Navigation 跟 XML 明顯分別是沒有 IDE 預覽、轉用 route（string 形式）而不是用 R class ID 和沒有 SafeArgs，而傳遞參數都改以 query parameter 形式而不是用 Bundle。很多人都不習慣這個新設定，有人用 Kotlin Symbol Processing (KSP) 還原了 SafeArgs 功能。官方就建議大家寫 sealed class 來表達 route。我覺得 Compose Navigation 應該比 XML 版 Navigation 更容易做到 runtime 隨時切換 navigation graph（例如用戶登入前和登入後），過份追求跟 XML 版 Navigation 功能一致可能會令隨時切換 navigation graph 變得更難做到。另一樣比較多人不喜歡的地方是傳遞參數要用 query parameter。我初初以為 route 是像 RESTful 般如果有子目錄就是代表是某一個 route 的子頁 (sub-graph)，但實際試用過才發現那些 route 就只是一個名字而已。而不能傳 Parcelable 參數是因為官方建議是應傳 ID 之類的簡單參數，開了另一頁後才憑那個 ID 從 local storage（SQLite database、Data Store、SharedPreferences、file system）找回那個大 object。以前工作遇過有人會用 singleton object 來暫存那些大 object，因為太大不能塞進去 intent extras。但這個做法沒有考慮到系統 kill process 後用戶從 Recents screen 再次打開 app 的情景，所以還是應該把大 object 放去 local storage。\n另外，route 其實跟 deep link 沒有關連，因為 deep link 是另外宣告的，但 deeplink 用到的 argument 要在 arguments 一併宣告。\ncomposable( route = \"stationDetail/{id}\", arguments = listOf( navArgument(\"id\") { type = NavType.IntType defaultValue = -1 }, navArgument(\"lrlStopId\") { type = NavType.IntType defaultValue = -1 }, ), deepLinks = listOf( navDeepLink { uriPattern = \"https://lrnt.mtr.com.hk/moblink/?station_id={lrlStopId}\" }, ), ) { val viewModel = hiltViewModel\u003cStationDetailViewModel\u003e() StationDetailScreen( viewModel = viewModel, onNavigateUpClick = { navController.navigateUp() }, ) } 加完 deepLinks 後記得要自己在 AndroidManifest.xml 加上 intent-filter，不然就做不到 deep link。另外，在 Android 12 (API level 31) 起 deep link 的 domain 必須要放置 Digital Asset Links JSON，否則預設只會開 web browser。惟用戶可以自行到 app settings 開啟 deep link 功能。\n對於那些 SafeArgs 的 library，我反而期望有人做到類似 backend framework routing 的 middleware/interceptor 功能（又或者是 OkHttp 的 interceptor）。即是每次收到要轉頁的請求時都可以先經過一些 middleware，middleware 可以決定是否放行或者轉址去另一頁，而那些 middleware function 要是 suspending function。有了 middleware 就可以很容易做到登入後才能進入某些頁面的要求，不用再在每一頁加入登入檢查的 code。這大概是要封裝一次 Compose Navigation，幫它加上 queue 來為轉頁動作排隊，還要補上等待轉頁時的載入中畫面。\n有一樣東西我想分享是如何做到 navigation graph level 的 ViewModel 共用，那時在做這個部分找到一大輪才知道這個寫法。我的 project 用了 Dagger Hilt，如果不是用 Dagger Hilt 的話可以把 hiltViewModel 改成對應寫法。重點是要用 navController.getBackStackEntry 拿到 navigation graph 的 entry，再憑那個 entry 設定 ViewModelStoreOwner 就能拿到同一個 ViewModel instance。下面是設定頁及其 dialog 的 sub-graph，dialog 會與設定頁共用同一個 SettingsViewModel。\n@Composable fun AppNavHost( modifier: Modifier = Modifier, navController: NavHostController, ) { NavHost( modifier = modifier, navController = navController, startDestination = \"status\", ) { // 略…… settingsGraph(navController) } } fun NavGraphBuilder.settingsGraph(navController: NavHostController) { navigation(startDestination = \"settingsHome\", route = \"settings\") { composable(\"settingsHome\") { backStackEntry -\u003e val parentEntry = remember(backStackEntry) { navController.getBackStackEntry(\"settings\") } val viewModel = hiltViewModel\u003cSettingsViewModel\u003e(parentEntry) SettingsScreen( viewModel = viewModel, navigateUp = { navController.popBackStack() }, // 略…… ) } dialog( route = \"language?index={index}\", arguments = listOf( navArgument(\"index\") { type = NavType.IntType defaultValue = -1 }, ), ) { backStackEntry -\u003e val parentEntry = remember(backStackEntry) { navController.getBackStackEntry(\"settings\") } val viewModel = hiltViewModel\u003cSettingsViewModel\u003e(parentEntry) val selectedIndex = backStackEntry.arguments?.getInt(\"index\") ?: -1 LanguageSettingDialog( preSelected = LanguageSetting.values() .getOrElse(selectedIndex) { LanguageSetting.SYSTEM_DEFAULT }, onConfirmSelect = { languageSetting -\u003e viewModel.updateLanguage(languageSetting) navController.popBackStack() }, onDismissRequest = { navController.popBackStack() }, ) } dialog( route = \"theme?nightMode={nightMode}\", arguments = listOf( navArgument(\"nightMode\") { type = NavType.IntType defaultValue = AppCompatDelegate.MODE_NIGHT_UNSPECIFIED }, ), ) { backStackEntry -\u003e val parentEntry = remember(backStackEntry) { navController.getBackStackEntry(\"settings\") } val viewModel = hiltViewModel\u003cSettingsViewModel\u003e(parentEntry) val nightMode = backStackEntry.arguments?.getInt(\"nightMode\") ?: AppCompatDelegate.MODE_NIGHT_UNSPECIFIED ThemeSettingDialog( preSelected = nightMode, onConfirmSelect = { newValue -\u003e viewModel.updateTheme(newValue) navController.popBackStack() }, onDismissRequest = { navController.popBackStack() }, ) } } } 小結 其實實際的遷移工作不用做這麼久，只是因為這是 side project 沒有時間限制所以才慢慢做。這次先分享到這裏，我本來想一併分享其餘內容，但都是留待下篇才寫。下次應該會寫 interop 的部分。\n","wordCount":"3127","inLanguage":"zh-tw","datePublished":"2022-07-24T14:06:00+08:00","dateModified":"2022-07-24T14:06:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://eric.swiftzer.net/2022/07/jetpack-compose-migration-1/"},"publisher":{"@type":"Organization","name":"EricLog","logo":{"@type":"ImageObject","url":"https://eric.swiftzer.net/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://eric.swiftzer.net/ accesskey=h title="EricLog (Alt + H)">EricLog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li></ul></div></div><ul id=menu><li><a href=https://eric.swiftzer.net/fonts/ title=Fonts><span>Fonts</span></a></li><li><a href=https://eric.swiftzer.net/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://eric.swiftzer.net/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://eric.swiftzer.net/about/ title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://eric.swiftzer.net/>首頁</a>&nbsp;»&nbsp;<a href=https://eric.swiftzer.net/posts/>Posts</a></div><h1 class=post-title>Jetpack Compose 遷移 (1)</h1><div class=post-meta>&lt;span title='2022-07-24 14:06:00 +0800 +0800'>July 24, 2022&lt;/span></div></header><div class=post-content><p>近幾個月斷斷續續替 <a href="https://play.google.com/store/apps/details?id=net.swiftzer.metroride">MetroRide</a> 的界面由傳統 view system（即是 layout XML）轉為 <a href=https://developer.android.com/jetpack/compose>Jetpack Compose</a>，順帶補上去年參加 <a href=https://eric.swiftzer.net/2021-ithome-ironman/>iThome 鐵人賽</a>時用來做示範的重鐵抵站時間功能。昨天新版 app 上架了就來分享一下遷移過程。其實這個 app 在之前的版本有把其中一頁靜態的頁面（延誤定義）改用 Compose，那時是在 <code>Fragment</code> 內的 <code>onCreateView</code> 加入 <code>setContent</code> 顯示 Compose 內容。由於那時只是做排版，沒有遇到大問題。之後開始慢慢轉用 Compose 才遇到問題。</p><h2 id=遷移方式>遷移方式<a hidden class=anchor aria-hidden=true href=#遷移方式>#</a></h2><p>由於我本身打算一次過把全個 app 的 UI 都換成 Compose，所以除了先前的延誤定義頁之外我就沒有再特別去把原有的 <code>Fragment</code> 淘空 layout XML，而是直接造一個全新的 <code>MainActivity</code> 來顯示全新製造的 Compose UI，舊有的 layout XML 和 <code>Fragment</code> 就盡量不去改，方便遷移時能拿來對照參考。當全部頁面都轉成 Compose 後就會刪除舊的 <code>Fragment</code> 和 layout XML。另外，這個 app 本身是 single <code>Activity</code> app，所以只有單一 <code>Activity</code>，遷移後亦都會維持這個做法。</p><p>除了大改的列車抵站時間部分，原有頁面的 <code>ViewModel</code> 和背後的 code 都不會大改，因為這次目的是想轉用 Compose 和補元列車抵站時間功能。現有 code 在 <code>ViewModel</code> 和 UI 之間的通訊方式是以 <code>LiveData</code> 和 <code>ViewModel</code> 的 function，再加上使用 databinding。在遷移現有頁面時 <code>ViewModel</code> 要改動的地方不算太多，而背後拿資料的部分都不用改。</p><h2 id=狀態>狀態<a hidden class=anchor aria-hidden=true href=#狀態>#</a></h2><p>Compose 和傳統 view system 其中一個明顯差別就是狀態處理。Compose 特別強調狀態，明確地分別出 composable function 的參數、<code>remember</code> 和 <code>rememberSavable</code>。<code>remember</code> 就是在 Compose rerender (recompose) 時能保存的 state，而 <code>rememberSavable</code> 就更進一步連 process 被 kill 後重開 app 都能保存 state。即是跟 <code>savedInstanceState</code> 一樣，只是重新包裝方便將 Compose 帶去非 Android 平台用。</p><p>官方建議盡量寫 stateless 的 composable function，把 state 都推去上層管理（正式叫法是 <a href=https://developer.android.com/jetpack/compose/state#state-hoisting>state hoisting</a>），你可以把 state 推到上去 <code>ViewModel</code>，即是跟傳統 <code>Activity</code>/<code>Fragment</code> 般一個頁面配一個 <code>ViewModel</code> 來管理 state。但不代表要把所有 state 都推到去 <code>ViewModel</code> 管理。一般建議的做法是比較關 UI 事的 state 就保留在 composable function 內放置（靠 <code>remember</code> 和 <code>rememberSavable</code>），例如 scroll、animation 的 state。而偏向資料性的 state 就交由 <code>ViewModel</code> 管理。目前我都在摸索除了那些很明顯的 scroll、animation 之類的 UI state 外，還有甚麼 state 是應該放去 Compose 那邊。以顯示列車班次為例，UI 要顯示班次抵站的倒數時間。究竟應該把定時計算倒數分鐘的 code 放去非 Compose 的地方，然後經 <code>ViewModel</code> 的 <code>StateFlow</code> 傳去要顯示分鐘的 composable function 讓它直接拿那個預先計算好的數字顯示出來還是 <code>ViewModel</code> 只向 composable function 提供絕對時間（<code>Instant</code> 之類），composable function 會定時計算倒數分鐘並顯示出來（會有 side-effect）。這次我選了前者，但下次再選的話可能會選後者。我沒有太仔細看官方的 sample project，但似乎因為現在 UI 的部分可以直接寫 Kotlin code，不像以往 XML layout 般難把 Java/Kotlin code 塞入去（databinding 都是 Java syntax 而且不能分行寫），現在可以把偏 UI 相關的 code 都放去 composable function 內。但因為這次沒有寫 UI test，反而是要刪走以前針對傳統 view system 寫的 UI test，所以還未能拿捏到應不應該把這類的 logic 下放到 composable function 內。</p><p>這次因為遷移時還保留着現有的 <code>Fragment</code> 和 layout XML，所以不太想修改現有的 <code>ViewModel</code> 以免動到舊有的 code。我之前在舊公司試過新頁面用 Compose 寫，在寫 code 時其實是會自然地傾向把 composable function 寫到 stateless 和減少 logic，最好連 UI 顯示式樣都由非 Compose 的地方計算好。以 WhatsApp 的訊息列表為例（見下圖），會以 sealed interface/class 的形式向 UI 表示每間房間的最新訊息欄的式樣（自己發送單剔、自己發送雙剔、別人發送、房間沒有訊息等等），然後 composable function 放個 <code>when</code> 來實際控制 UI 顯示式樣（例如顏色、icon），而不是在 composable function 內拿到個未處理的 object 再在 composable function 內寫一堆 code 去決定顯示那款最新訊息式樣。同時亦會慢慢傾向造一個 <code>StateFlow</code> 去表達整頁的 state。如果要用 data class 並以 immutable 的方式表達整頁的 state 的話，在複雜的環境下可能需要借助 <a href=https://github.com/Kotlin/kotlinx.collections.immutable>kotlinx.collections.immutable</a> 和 <a href=https://arrow-kt.io/docs/optics/>Arrow Optics</a> 之類的 library 來生成新的 state object，因為那些 state 可能放到很深入，用 data class <code>copy</code> function 不夠方便，會很累贅。</p><figure><img loading=lazy src=whatsapp-last-message.png><figcaption>WhatsApp 最新訊息欄</figcaption></figure><p>另一樣應該都算關 state 事的地方是 Compose 對那些要費時完成的動作（例如 scroll 去某個位置、彈出 bottom sheet 之類）的 function 都定義為 suspending function。以往在傳統 view system 可能只是 call 完 function 就算，但 Compose 就要你開一個 coroutine scope 才能 call。</p><h2 id=navigation>Navigation<a hidden class=anchor aria-hidden=true href=#navigation>#</a></h2><p>由於是另起爐灶，Navigation 我沒有做甚麼遷移，要做的東西就是重新做過一個新的 <code>NavHost</code>。如果是分階段遷移的話一般都是叫你用 <code>Fragment</code> 來顯示 composable function 並沿用現有的 XML 式 navigation graph 直頭全部頁面都換成 Compose 才轉用 Compose 版 Navigation。Compose 版 Navigation 跟 XML 明顯分別是沒有 IDE 預覽、轉用 route（string 形式）而不是用 R class ID 和沒有 SafeArgs，而傳遞參數都改以 query parameter 形式而不是用 <code>Bundle</code>。很多人都不習慣這個新設定，有人用 Kotlin Symbol Processing (KSP) <a href=https://github.com/raamcosta/compose-destinations>還原了 SafeArgs 功能</a>。官方就<a href=https://developer.android.com/jetpack/compose/navigation#bottom-nav>建議大家寫 sealed class 來表達 route</a>。我覺得 Compose Navigation 應該比 XML 版 Navigation 更容易做到 runtime 隨時切換 navigation graph（例如用戶登入前和登入後），過份追求跟 XML 版 Navigation 功能一致可能會令隨時切換 navigation graph 變得更難做到。另一樣比較多人不喜歡的地方是傳遞參數要用 query parameter。我初初以為 route 是像 RESTful 般如果有子目錄就是代表是某一個 route 的子頁 (sub-graph)，但實際試用過才發現那些 route 就只是一個名字而已。而不能傳 <code>Parcelable</code> 參數是因為官方建議是應傳 ID 之類的簡單參數，開了另一頁後才憑那個 ID 從 local storage（SQLite database、Data Store、SharedPreferences、file system）找回那個大 object。以前工作遇過有人會用 singleton object 來暫存那些大 object，因為太大不能塞進去 intent extras。但這個做法沒有考慮到系統 kill process 後用戶從 <a href=https://developer.android.com/guide/components/activities/recents>Recents screen</a> 再次打開 app 的情景，所以還是應該把大 object 放去 local storage。</p><p>另外，route 其實跟 deep link 沒有關連，因為 deep link 是另外宣告的，但 deeplink 用到的 argument 要在 <code>arguments</code> 一併宣告。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=n>composable</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>route</span> <span class=p>=</span> <span class=s2>&#34;stationDetail/{id}&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>arguments</span> <span class=p>=</span> <span class=n>listOf</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>navArgument</span><span class=p>(</span><span class=s2>&#34;id&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>type</span> <span class=p>=</span> <span class=nc>NavType</span><span class=p>.</span><span class=n>IntType</span>
</span></span><span class=line><span class=cl>            <span class=n>defaultValue</span> <span class=p>=</span> <span class=p>-</span><span class=m>1</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=n>navArgument</span><span class=p>(</span><span class=s2>&#34;lrlStopId&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>type</span> <span class=p>=</span> <span class=nc>NavType</span><span class=p>.</span><span class=n>IntType</span>
</span></span><span class=line><span class=cl>            <span class=n>defaultValue</span> <span class=p>=</span> <span class=p>-</span><span class=m>1</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>deepLinks</span> <span class=p>=</span> <span class=n>listOf</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>navDeepLink</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>uriPattern</span> <span class=p>=</span> <span class=s2>&#34;https://lrnt.mtr.com.hk/moblink/?station_id={lrlStopId}&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>),</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>viewModel</span> <span class=p>=</span> <span class=n>hiltViewModel</span><span class=p>&lt;</span><span class=n>StationDetailViewModel</span><span class=p>&gt;()</span>
</span></span><span class=line><span class=cl>    <span class=n>StationDetailScreen</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>viewModel</span> <span class=p>=</span> <span class=n>viewModel</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>onNavigateUpClick</span> <span class=p>=</span> <span class=p>{</span> <span class=n>navController</span><span class=p>.</span><span class=n>navigateUp</span><span class=p>()</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>加完 <code>deepLinks</code> 後記得要自己在 <em>AndroidManifest.xml</em> 加上 <code>intent-filter</code>，不然就做不到 deep link。另外，在 Android 12 (API level 31) 起 deep link 的 domain 必須要放置 <a href=https://developer.android.com/training/app-links/verify-site-associations>Digital Asset Links JSON</a>，否則預設只會開 web browser。惟用戶可以自行到 app settings 開啟 deep link 功能。</p><p>對於那些 SafeArgs 的 library，我反而期望有人做到類似 backend framework routing 的 middleware/interceptor 功能（又或者是 OkHttp 的 interceptor）。即是每次收到要轉頁的請求時都可以先經過一些 middleware，middleware 可以決定是否放行或者轉址去另一頁，而那些 middleware function 要是 suspending function。有了 middleware 就可以很容易做到登入後才能進入某些頁面的要求，不用再在每一頁加入登入檢查的 code。這大概是要封裝一次 Compose Navigation，幫它加上 queue 來為轉頁動作排隊，還要補上等待轉頁時的載入中畫面。</p><p>有一樣東西我想分享是如何做到 navigation graph level 的 <code>ViewModel</code> 共用，那時在做這個部分找到一大輪才知道這個寫法。我的 project 用了 Dagger Hilt，如果不是用 Dagger Hilt 的話可以把 <code>hiltViewModel</code> 改成對應寫法。重點是要用 <code>navController.getBackStackEntry</code> 拿到 navigation graph 的 entry，再憑那個 entry 設定 <code>ViewModelStoreOwner</code> 就能拿到同一個 <code>ViewModel</code> instance。下面是設定頁及其 dialog 的 sub-graph，dialog 會與設定頁共用同一個 <code>SettingsViewModel</code>。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=nd>@Composable</span>
</span></span><span class=line><span class=cl><span class=k>fun</span> <span class=nf>AppNavHost</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>modifier</span><span class=p>:</span> <span class=n>Modifier</span> <span class=p>=</span> <span class=n>Modifier</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>navController</span><span class=p>:</span> <span class=n>NavHostController</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>NavHost</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>modifier</span> <span class=p>=</span> <span class=n>modifier</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>navController</span> <span class=p>=</span> <span class=n>navController</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>startDestination</span> <span class=p>=</span> <span class=s2>&#34;status&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 略……
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>settingsGraph</span><span class=p>(</span><span class=n>navController</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>fun</span> <span class=nf>NavGraphBuilder</span><span class=p>.</span><span class=n>settingsGraph</span><span class=p>(</span><span class=n>navController</span><span class=p>:</span> <span class=n>NavHostController</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>navigation</span><span class=p>(</span><span class=n>startDestination</span> <span class=p>=</span> <span class=s2>&#34;settingsHome&#34;</span><span class=p>,</span> <span class=n>route</span> <span class=p>=</span> <span class=s2>&#34;settings&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>composable</span><span class=p>(</span><span class=s2>&#34;settingsHome&#34;</span><span class=p>)</span> <span class=p>{</span> <span class=n>backStackEntry</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>            <span class=k>val</span> <span class=py>parentEntry</span> <span class=p>=</span> <span class=n>remember</span><span class=p>(</span><span class=n>backStackEntry</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>navController</span><span class=p>.</span><span class=n>getBackStackEntry</span><span class=p>(</span><span class=s2>&#34;settings&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=k>val</span> <span class=py>viewModel</span> <span class=p>=</span> <span class=n>hiltViewModel</span><span class=p>&lt;</span><span class=n>SettingsViewModel</span><span class=p>&gt;(</span><span class=n>parentEntry</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>SettingsScreen</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>viewModel</span> <span class=p>=</span> <span class=n>viewModel</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>navigateUp</span> <span class=p>=</span> <span class=p>{</span> <span class=n>navController</span><span class=p>.</span><span class=n>popBackStack</span><span class=p>()</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 略……
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>dialog</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>route</span> <span class=p>=</span> <span class=s2>&#34;language?index={index}&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>arguments</span> <span class=p>=</span> <span class=n>listOf</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>navArgument</span><span class=p>(</span><span class=s2>&#34;index&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>type</span> <span class=p>=</span> <span class=nc>NavType</span><span class=p>.</span><span class=n>IntType</span>
</span></span><span class=line><span class=cl>                    <span class=n>defaultValue</span> <span class=p>=</span> <span class=p>-</span><span class=m>1</span>
</span></span><span class=line><span class=cl>                <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span> <span class=p>{</span> <span class=n>backStackEntry</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>            <span class=k>val</span> <span class=py>parentEntry</span> <span class=p>=</span> <span class=n>remember</span><span class=p>(</span><span class=n>backStackEntry</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>navController</span><span class=p>.</span><span class=n>getBackStackEntry</span><span class=p>(</span><span class=s2>&#34;settings&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=k>val</span> <span class=py>viewModel</span> <span class=p>=</span> <span class=n>hiltViewModel</span><span class=p>&lt;</span><span class=n>SettingsViewModel</span><span class=p>&gt;(</span><span class=n>parentEntry</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>val</span> <span class=py>selectedIndex</span> <span class=p>=</span> <span class=n>backStackEntry</span><span class=p>.</span><span class=n>arguments</span><span class=o>?.</span><span class=n>getInt</span><span class=p>(</span><span class=s2>&#34;index&#34;</span><span class=p>)</span> <span class=o>?:</span> <span class=p>-</span><span class=m>1</span>
</span></span><span class=line><span class=cl>            <span class=n>LanguageSettingDialog</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>preSelected</span> <span class=p>=</span> <span class=nc>LanguageSetting</span><span class=p>.</span><span class=n>values</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                    <span class=p>.</span><span class=n>getOrElse</span><span class=p>(</span><span class=n>selectedIndex</span><span class=p>)</span> <span class=p>{</span> <span class=nc>LanguageSetting</span><span class=p>.</span><span class=n>SYSTEM_DEFAULT</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>                <span class=n>onConfirmSelect</span> <span class=p>=</span> <span class=p>{</span> <span class=n>languageSetting</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>                    <span class=n>viewModel</span><span class=p>.</span><span class=n>updateLanguage</span><span class=p>(</span><span class=n>languageSetting</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>navController</span><span class=p>.</span><span class=n>popBackStack</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=p>},</span>
</span></span><span class=line><span class=cl>                <span class=n>onDismissRequest</span> <span class=p>=</span> <span class=p>{</span> <span class=n>navController</span><span class=p>.</span><span class=n>popBackStack</span><span class=p>()</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>dialog</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>route</span> <span class=p>=</span> <span class=s2>&#34;theme?nightMode={nightMode}&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>arguments</span> <span class=p>=</span> <span class=n>listOf</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>navArgument</span><span class=p>(</span><span class=s2>&#34;nightMode&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>type</span> <span class=p>=</span> <span class=nc>NavType</span><span class=p>.</span><span class=n>IntType</span>
</span></span><span class=line><span class=cl>                    <span class=n>defaultValue</span> <span class=p>=</span> <span class=nc>AppCompatDelegate</span><span class=p>.</span><span class=n>MODE_NIGHT_UNSPECIFIED</span>
</span></span><span class=line><span class=cl>                <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span> <span class=p>{</span> <span class=n>backStackEntry</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>            <span class=k>val</span> <span class=py>parentEntry</span> <span class=p>=</span> <span class=n>remember</span><span class=p>(</span><span class=n>backStackEntry</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>navController</span><span class=p>.</span><span class=n>getBackStackEntry</span><span class=p>(</span><span class=s2>&#34;settings&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=k>val</span> <span class=py>viewModel</span> <span class=p>=</span> <span class=n>hiltViewModel</span><span class=p>&lt;</span><span class=n>SettingsViewModel</span><span class=p>&gt;(</span><span class=n>parentEntry</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>val</span> <span class=py>nightMode</span> <span class=p>=</span> <span class=n>backStackEntry</span><span class=p>.</span><span class=n>arguments</span><span class=o>?.</span><span class=n>getInt</span><span class=p>(</span><span class=s2>&#34;nightMode&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=o>?:</span> <span class=nc>AppCompatDelegate</span><span class=p>.</span><span class=n>MODE_NIGHT_UNSPECIFIED</span>
</span></span><span class=line><span class=cl>            <span class=n>ThemeSettingDialog</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>preSelected</span> <span class=p>=</span> <span class=n>nightMode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>onConfirmSelect</span> <span class=p>=</span> <span class=p>{</span> <span class=n>newValue</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>                    <span class=n>viewModel</span><span class=p>.</span><span class=n>updateTheme</span><span class=p>(</span><span class=n>newValue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>navController</span><span class=p>.</span><span class=n>popBackStack</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=p>},</span>
</span></span><span class=line><span class=cl>                <span class=n>onDismissRequest</span> <span class=p>=</span> <span class=p>{</span> <span class=n>navController</span><span class=p>.</span><span class=n>popBackStack</span><span class=p>()</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=小結>小結<a hidden class=anchor aria-hidden=true href=#小結>#</a></h2><p>其實實際的遷移工作不用做這麼久，只是因為這是 side project 沒有時間限制所以才慢慢做。這次先分享到這裏，我本來想一併分享其餘內容，但都是留待下篇才寫。下次應該會寫 interop 的部分。</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://eric.swiftzer.net/tags/android/>Android</a></li></ul><nav class=paginav><a class=prev href=https://eric.swiftzer.net/2022/07/jetpack-compose-migration-2/><span class=title>« 上一頁</span><br><span>Jetpack Compose 遷移 (2)</span>
</a><a class=next href=https://eric.swiftzer.net/2022/01/androidx-room-relational-query-method/><span class=title>下一頁 »</span><br><span>AndroidX Room Relational Query Method</span></a></nav></footer><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//efilm.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></article></main><footer class=footer><span>&copy; 2024 <a href=https://eric.swiftzer.net/>EricLog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>